/*! For license information please see main.45b5eb09aafb97181cae.js.LICENSE.txt */
(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(){var e,n,a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",o=a.toStringTag||"@@toStringTag";function s(t,a,i,o){var s=a&&a.prototype instanceof h?a:h,m=Object.create(s.prototype);return r(m,"_invoke",function(t,r,a){var i,o,s,h=0,m=a||[],c=!1,u={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,r){return i=t,o=0,s=e,u.n=r,l}};function d(t,r){for(o=t,s=r,n=0;!c&&h&&!a&&n<m.length;n++){var a,i=m[n],d=u.p,p=i[2];t>3?(a=p===r)&&(s=i[(o=i[4])?5:(o=3,3)],i[4]=i[5]=e):i[0]<=d&&((a=t<2&&d<i[1])?(o=0,u.v=r,u.n=i[1]):d<p&&(a=t<3||i[0]>r||r>p)&&(i[4]=t,i[5]=r,u.n=p,o=0))}if(a||t>1)return l;throw c=!0,r}return function(a,m,p){if(h>1)throw TypeError("Generator is already running");for(c&&1===m&&d(m,p),o=m,s=p;(n=o<2?e:s)||!c;){i||(o?o<3?(o>1&&(u.n=-1),d(o,s)):u.n=s:u.v=s);try{if(h=2,i){if(o||(a="next"),n=i[a]){if(!(n=n.call(i,s)))throw TypeError("iterator result is not an object");if(!n.done)return n;s=n.value,o<2&&(o=0)}else 1===o&&(n=i.return)&&n.call(i),o<2&&(s=TypeError("The iterator does not provide a '"+a+"' method"),o=1);i=e}else if((n=(c=u.n<0)?s:t.call(r,u))!==l)break}catch(t){i=e,o=1,s=t}finally{h=1}}return{value:n,done:c}}}(t,i,o),!0),m}var l={};function h(){}function m(){}function c(){}n=Object.getPrototypeOf;var u=[][i]?n(n([][i]())):(r(n={},i,function(){return this}),n),d=c.prototype=h.prototype=Object.create(u);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,r(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return m.prototype=c,r(d,"constructor",c),r(c,"constructor",m),m.displayName="GeneratorFunction",r(c,o,"GeneratorFunction"),r(d),r(d,o,"Generator"),r(d,i,function(){return this}),r(d,"toString",function(){return"[object Generator]"}),(t=function(){return{w:s,m:p}})()}function r(e,t,n,a){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}r=function(e,t,n,a){function o(t,n){r(e,t,function(e){return this._invoke(t,n,e)})}t?i?i(e,t,{value:n,enumerable:!a,configurable:!a,writable:!a}):e[t]=n:(o("next",0),o("throw",1),o("return",2))},r(e,t,n,a)}function n(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,i(n.key),n)}}function i(t){var r=function(t){if("object"!=e(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!=e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(r)?r:r+""}var o=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.canvas=t,this.gl=null,this.program=null,this.textures={},this.currentScene=null,this.init()},r=[{key:"init",value:function(){var e=this;try{if(this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl"),!this.gl)throw new Error("WebGL not supported");this.resizeCanvas(),window.addEventListener("resize",function(){return e.resizeCanvas()}),this.initShaders(),this.initBuffers(),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.clearColor(0,0,0,1),console.log("WebGL initialized successfully")}catch(e){console.error("WebGL initialization failed:",e);var t=this.canvas.getContext("2d");t&&(t.fillStyle="#333",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.font="16px Courier New",t.fillStyle="#f00",t.textAlign="center",t.fillText("WebGL not supported or initialization failed.",this.canvas.width/2,this.canvas.height/2))}}},{key:"resizeCanvas",value:function(){var e=this.canvas.parentElement;this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}},{key:"initShaders",value:function(){var e=this.loadShader(this.gl.VERTEX_SHADER,"\n      attribute vec4 aVertexPosition;\n      attribute vec2 aTextureCoord;\n      \n      uniform mat4 uModelViewMatrix;\n      uniform mat4 uProjectionMatrix;\n      \n      varying highp vec2 vTextureCoord;\n      \n      void main() {\n        gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;\n        vTextureCoord = aTextureCoord;\n      }\n    "),t=this.loadShader(this.gl.FRAGMENT_SHADER,"\n      varying highp vec2 vTextureCoord;\n      \n      uniform sampler2D uSampler;\n      \n      void main() {\n        gl_FragColor = texture2D(uSampler, vTextureCoord);\n      }\n    ");if(this.program=this.gl.createProgram(),this.gl.attachShader(this.program,e),this.gl.attachShader(this.program,t),this.gl.linkProgram(this.program),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw new Error("Unable to initialize the shader program: "+this.gl.getProgramInfoLog(this.program));this.programInfo={program:this.program,attribLocations:{vertexPosition:this.gl.getAttribLocation(this.program,"aVertexPosition"),textureCoord:this.gl.getAttribLocation(this.program,"aTextureCoord")},uniformLocations:{projectionMatrix:this.gl.getUniformLocation(this.program,"uProjectionMatrix"),modelViewMatrix:this.gl.getUniformLocation(this.program,"uModelViewMatrix"),uSampler:this.gl.getUniformLocation(this.program,"uSampler")}}}},{key:"loadShader",value:function(e,t){var r=this.gl.createShader(e);if(this.gl.shaderSource(r,t),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)){var n=this.gl.getShaderInfoLog(r);throw this.gl.deleteShader(r),new Error("An error occurred compiling the shaders: "+n)}return r}},{key:"initBuffers",value:function(){this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0]),this.gl.STATIC_DRAW),this.textureCoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureCoordBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,1,1,1,1,0,0,0]),this.gl.STATIC_DRAW),this.indexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),this.gl.STATIC_DRAW)}},{key:"loadTexture",value:function(e){var t=this;return new Promise(function(n,a){var i=t.gl.createTexture();t.gl.bindTexture(t.gl.TEXTURE_2D,i),t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,1,1,0,t.gl.RGBA,t.gl.UNSIGNED_BYTE,new Uint8Array([128,128,128,255]));var o=new Image;o.onload=function(){t.gl.bindTexture(t.gl.TEXTURE_2D,i),t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,t.gl.RGBA,t.gl.UNSIGNED_BYTE,o),r(o.width)&&r(o.height)?t.gl.generateMipmap(t.gl.TEXTURE_2D):(t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.LINEAR)),n(i)},o.onerror=function(){a(new Error("Failed to load texture: ".concat(e)))},o.src=e});function r(e){return!(e&e-1)}}},{key:"loadScene",value:(i=t().m(function e(r){var n,a,i,o,s;return t().w(function(e){for(;;)switch(e.p=e.n){case 0:e.p=0,a=0,i=["svg","jpg","png"];case 1:if(!(a<i.length)){e.n=6;break}return o=i[a],e.p=2,e.n=3,this.loadTexture("assets/images/".concat(r,".").concat(o));case 3:return n=e.v,e.a(3,6);case 4:e.p=4,e.v;case 5:a++,e.n=1;break;case 6:if(n){e.n=8;break}return e.n=7,this.loadTexture("assets/images/placeholder.svg");case 7:n=e.v;case 8:return this.textures[r]=n,this.currentScene=r,e.a(2,!0);case 9:return e.p=9,s=e.v,console.error("Failed to load scene:",s),e.a(2,!1)}},e,this,[[2,4],[0,9]])}),o=function(){var e=this,t=arguments;return new Promise(function(r,a){var o=i.apply(e,t);function s(e){n(o,r,a,s,l,"next",e)}function l(e){n(o,r,a,s,l,"throw",e)}s(void 0)})},function(e){return o.apply(this,arguments)})},{key:"render",value:function(e){var t=this;if(this.gl){if(this.currentScene!==e){if(!this.textures[e])return void this.loadScene(e).then(function(){return t.render(e)});this.currentScene=e}if(this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.textures[e]){var r=45*Math.PI/180,n=this.canvas.clientWidth/this.canvas.clientHeight,a=s.create();s.perspective(a,r,n,.1,100);var i=s.create();s.translate(i,i,[0,0,-4]),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.vertexAttribPointer(this.programInfo.attribLocations.vertexPosition,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.programInfo.attribLocations.vertexPosition),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureCoordBuffer),this.gl.vertexAttribPointer(this.programInfo.attribLocations.textureCoord,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.programInfo.attribLocations.textureCoord),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.useProgram(this.programInfo.program),this.gl.uniformMatrix4fv(this.programInfo.uniformLocations.projectionMatrix,!1,a),this.gl.uniformMatrix4fv(this.programInfo.uniformLocations.modelViewMatrix,!1,i),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[e]),this.gl.uniform1i(this.programInfo.uniformLocations.uSampler,0),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0)}}}},{key:"setScene",value:function(e){if(e)if("string"==typeof e)this.loadScene(e);else if(this.currentSceneData=e,e.background){var t=e.id||e.background.replace(/\.[^/.]+$/,"");this.loadScene(t)}else e.id&&this.loadScene(e.id);else console.warn("No scene data provided to setScene")}},{key:"setMemoryFlashImage",value:function(e){this.memoryFlashImage=e}},{key:"updateMemoryFlash",value:function(e,t){if(this.memoryFlashProgress=e,this.currentMemoryData=t,this.gl&&this.currentScene){var r=.3*Math.sin(e*Math.PI);this.applyFlashOverlay(r)}}},{key:"clearMemoryFlash",value:function(){this.memoryFlashProgress=0,this.currentMemoryData=null,this.memoryFlashImage=null}},{key:"applyFlashOverlay",value:function(e){if(this.gl&&!(e<=0)){var t=this.gl.isEnabled(this.gl.BLEND);this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(1,1,1,e),t||this.gl.disable(this.gl.BLEND)}}}],r&&a(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,r,i,o}(),s={create:function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},perspective:function(e,t,r,n,a){var i=1/Math.tan(t/2),o=1/(n-a);return e[0]=i/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(a+n)*o,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*a*n*o,e[15]=0,e},translate:function(e,t,r){var n,a,i,o,s,l,h,m,c,u,d,p,g=r[0],y=r[1],f=r[2];return t===e?(e[12]=t[0]*g+t[4]*y+t[8]*f+t[12],e[13]=t[1]*g+t[5]*y+t[9]*f+t[13],e[14]=t[2]*g+t[6]*y+t[10]*f+t[14],e[15]=t[3]*g+t[7]*y+t[11]*f+t[15]):(n=t[0],a=t[1],i=t[2],o=t[3],s=t[4],l=t[5],h=t[6],m=t[7],c=t[8],u=t[9],d=t[10],p=t[11],e[0]=n,e[1]=a,e[2]=i,e[3]=o,e[4]=s,e[5]=l,e[6]=h,e[7]=m,e[8]=c,e[9]=u,e[10]=d,e[11]=p,e[12]=n*g+s*y+c*f+t[12],e[13]=a*g+l*y+u*f+t[13],e[14]=i*g+h*y+d*f+t[14],e[15]=o*g+m*y+p*f+t[15]),e}};function l(e){return new o(e)}function h(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function m(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?h(Object(r),!0).forEach(function(t){c(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):h(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function c(e,t,r){return(t=y(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function u(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return d(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?d(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){s=!0,i=e},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw i}}}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function p(e){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},p(e)}function g(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,y(n.key),n)}}function y(e){var t=function(e){if("object"!=p(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=p(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==p(t)?t:t+""}var f=function(){return e=function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.gameState=t,this.terminal=r,this.webglRenderer=n,this.locations={},this.items={},this.npcs={},this.combatSystem=null,this.memorySystem=null,this.initializeCommandHandlers()},(t=[{key:"initializeCommandHandlers",value:function(){var e=this;this.terminal.registerCommand("^(go|move|walk|run|travel) (to )?(north|south|east|west|n|s|e|w)",function(t){var r=t.match(/(north|south|east|west|n|s|e|w)/i)[0].toLowerCase();e.handleMovement(r)}),this.terminal.registerCommand("^(north|south|east|west|n|s|e|w)$",function(t){var r=t.trim().toLowerCase();e.handleMovement(r)}),this.terminal.registerCommand("^(look|examine|inspect|l)( around)?$",function(){e.describeCurrentLocation()}),this.terminal.registerCommand("^(look|examine|inspect|l) (at )?(.+)$",function(t){var r=t.match(/^(?:look|examine|inspect|l)(?: at)?\s+(.+)$/i)[1].toLowerCase();e.examineObject(r)}),this.terminal.registerCommand("^(take|get|grab|pick up) (.+)$",function(t){var r=t.match(/^(?:take|get|grab|pick up)\s+(.+)$/i)[1].toLowerCase();e.takeItem(r)}),this.terminal.registerCommand("^(drop|discard|throw away) (.+)$",function(t){var r=t.match(/^(?:drop|discard|throw away)\s+(.+)$/i)[1].toLowerCase();e.dropItem(r)}),this.terminal.registerCommand("^(use|activate|apply) (.+)$",function(t){var r=t.match(/^(?:use|activate|apply)\s+(.+)$/i)[1].toLowerCase();e.useItem(r)}),this.terminal.registerCommand("^(equip|wear|wield) (.+)$",function(t){var r=t.match(/^(?:equip|wear|wield)\s+(.+)$/i)[1].toLowerCase();e.equipItem(r)}),this.terminal.registerCommand("^(inventory|inv|i)$",function(){e.showInventory()}),this.terminal.registerCommand("^(talk|speak|chat) (to|with) (.+)$",function(t){var r=t.match(/^(?:talk|speak|chat) (?:to|with) (.+)$/i)[1].toLowerCase();e.talkToNPC(r)}),this.terminal.registerCommand("^(attack|fight|hit) (.+)$",function(t){var r=t.match(/^(?:attack|fight|hit) (.+)$/i)[1].toLowerCase();e.attackTarget(r)}),this.terminal.registerCommand("^(help|\\?)$",function(){e.showHelp()}),this.terminal.registerCommand("^(status|stats|health|condition)$",function(){e.showStatus()}),this.terminal.registerCommand("^(save)$",function(){e.gameState.saveGame()?e.terminal.print("Game saved successfully.","system-message"):e.terminal.print("Failed to save game.","error-message")}),this.terminal.registerCommand("^(search|loot) (.+)$",function(t){var r=t.match(/^(?:search|loot)\s+(.+)$/i)[1].toLowerCase();e.searchTarget(r)})}},{key:"registerLocation",value:function(e,t){this.locations[e]=t}},{key:"registerItem",value:function(e,t){this.items[e]=t}},{key:"registerNPC",value:function(e,t){this.npcs[e]=t}},{key:"setCombatSystem",value:function(e){this.combatSystem=e}},{key:"setMemorySystem",value:function(e){this.memorySystem=e}},{key:"start",value:function(){this.showIntroduction(),this.describeCurrentLocation()}},{key:"showIntroduction",value:function(){this.terminal.print("You awaken on a dirt road, your head throbbing. Your clothes are torn and stained with blood and dirt. You have no memory of who you are or how you got here.","story-text"),this.terminal.print("As you struggle to your feet, you find yourself at a crossroads. The world around you seems both familiar and strange.","story-text"),this.terminal.print("\nType 'help' for a list of commands.","system-message")}},{key:"describeCurrentLocation",value:function(){var e=this,t=this.gameState.currentLocation,r=this.locations[t];if(r){if(this.webglRenderer.setScene(r.scene),this.terminal.print("\n".concat(r.name),"location-name"),this.terminal.print(r.description,"location-description"),r.exits&&Object.keys(r.exits).length>0){var n=Object.keys(r.exits).map(function(e){return e}).join(", ");this.terminal.print("Exits: ".concat(n),"exits-list")}else this.terminal.print("There are no obvious exits.","exits-list");if(r.items&&r.items.length>0){var a=r.items.filter(function(t){var r=e.items[t];return r&&(!r.hidden||e.gameState.flags[r.revealFlag])});if(a.length>0){var i=a.map(function(t){return e.items[t].name});this.terminal.print("You can see: ".concat(i.join(", "),"."),"items-list")}}if(r.npcs&&r.npcs.length>0){var o=r.npcs.filter(function(t){var r=e.npcs[t];return r&&(!r.hidden||e.gameState.flags[r.revealFlag])});o.length>0&&o.forEach(function(t){var r=e.npcs[t];e.terminal.print(r.presenceDescription,"npc-description")})}this.gameState.hasVisitedLocation(t)&&!r.alwaysTriggerEvent||r.onFirstVisit&&r.onFirstVisit(this.gameState,this.terminal)}else this.terminal.print("Error: Location '".concat(t,"' not found."),"error-message")}},{key:"handleMovement",value:function(e){var t=this.gameState.currentLocation,r=this.locations[t];if(r){var n={n:"north",s:"south",e:"east",w:"west"}[e]||e;if(r.exits&&r.exits[n]){var a,i=r.exits[n];if("object"===p(i)&&i.condition){if(!i.condition(this.gameState))return this.gameState.triggerWolfDeathStory?void this.triggerWolfDeathStory():void this.terminal.print(i.blockedMessage||"You cannot go ".concat(n," from here."),"error-message");a=i.locationId}else a=i;this.gameState.changeLocation(a),this.terminal.print("You go ".concat(n,"."),"action-result"),this.describeCurrentLocation()}else this.terminal.print("You cannot go ".concat(n," from here."),"error-message")}else this.terminal.print("Error: Current location '".concat(t,"' not found."),"error-message")}},{key:"examineObject",value:function(e){var t=this.gameState.currentLocation,r=this.locations[t];if(r){if(r.features){var n,a=u(r.features);try{for(a.s();!(n=a.n()).done;){var i=n.value;if(i.keywords.some(function(t){return e.includes(t)})){if(this.terminal.print(i.description,"examine-result"),this.memorySystem&&this.memorySystem.checkTriggers("examine",e,{feature:i}),i.revealsItem){var o=i.revealsItem,s=this.items[o];s&&s.hidden&&(s.hidden=!1,this.terminal.print("You found ".concat(s.name,"!"),"item-found"),i.autoTake&&(this.gameState.addToInventory(m({id:o},s)),this.terminal.print("You take the ".concat(s.name,"."),"action-result")))}return}}}catch(e){a.e(e)}finally{a.f()}}if(r.items){var l,h=u(r.items);try{for(h.s();!(l=h.n()).done;){var c=l.value,d=this.items[c];if(d&&(!d.hidden||this.gameState.flags[d.revealFlag])&&d.keywords.some(function(t){return e.includes(t)}))return void this.terminal.print(d.description,"examine-result")}}catch(e){h.e(e)}finally{h.f()}}if(r.npcs){var p,g=u(r.npcs);try{for(g.s();!(p=g.n()).done;){var y=p.value,f=this.npcs[y];if(f&&(!f.hidden||this.gameState.flags[f.revealFlag])&&f.keywords.some(function(t){return e.includes(t)}))return void this.terminal.print(f.description,"examine-result")}}catch(e){g.e(e)}finally{g.f()}}var v,b=u(this.gameState.inventory);try{for(b.s();!(v=b.n()).done;){var w=v.value;if(w.keywords.some(function(t){return e.includes(t)}))return void this.terminal.print(w.description,"examine-result")}}catch(e){b.e(e)}finally{b.f()}this.terminal.print("You don't see anything special about the ".concat(e,"."),"error-message")}else this.terminal.print("Error: Location '".concat(t,"' not found."),"error-message")}},{key:"takeItem",value:function(e){var t=this.gameState.currentLocation,r=this.locations[t];if(r&&r.items){for(var n=0;n<r.items.length;n++){var a=r.items[n],i=this.items[a];if(i&&(!i.hidden||this.gameState.flags[i.revealFlag])&&i.keywords.some(function(t){return e.includes(t)}))return!1===i.takeable?void this.terminal.print(i.cantTakeMessage||"You can't take the ".concat(i.name,"."),"error-message"):(r.items.splice(n,1),this.gameState.addToInventory(m({id:a},i)),this.terminal.print("You take the ".concat(i.name,"."),"action-result"),this.memorySystem&&this.memorySystem.checkTriggers("take",a,{item:i}),void(i.onTake&&i.onTake(this.gameState,this.terminal)))}this.terminal.print("You don't see any ".concat(e," here."),"error-message")}else this.terminal.print("There's nothing here to take.","error-message")}},{key:"dropItem",value:function(e){for(var t=0;t<this.gameState.inventory.length;t++){var r=this.gameState.inventory[t];if(r.keywords.some(function(t){return e.includes(t)})){if(!1===r.droppable)return void this.terminal.print(r.cantDropMessage||"You can't drop the ".concat(r.name,"."),"error-message");this.gameState.removeFromInventory(r.id);var n=this.gameState.currentLocation,a=this.locations[n];return a.items||(a.items=[]),a.items.push(r.id),this.terminal.print("You drop the ".concat(r.name,"."),"action-result"),void(r.onDrop&&r.onDrop(this.gameState,this.terminal,n))}}this.terminal.print("You don't have any ".concat(e,"."),"error-message")}},{key:"useItem",value:function(e){var t,r=u(this.gameState.inventory);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n.keywords.some(function(t){return e.includes(t)}))return!1===n.usable?void this.terminal.print(n.cantUseMessage||"You can't use the ".concat(n.name,"."),"error-message"):n.onUse?void n.onUse(this.gameState,this.terminal,this):void this.terminal.print("You're not sure how to use the ".concat(n.name,"."),"error-message")}}catch(e){r.e(e)}finally{r.f()}var a=this.gameState.currentLocation,i=this.locations[a];if(i&&i.items){var o,s=u(i.items);try{for(s.s();!(o=s.n()).done;){var l=o.value,h=this.items[l];if(h&&(!h.hidden||this.gameState.flags[h.revealFlag])&&h.keywords.some(function(t){return e.includes(t)}))return!1===h.usable?void this.terminal.print(h.cantUseMessage||"You can't use the ".concat(h.name,"."),"error-message"):h.onUse?void h.onUse(this.gameState,this.terminal,this):void this.terminal.print("You're not sure how to use the ".concat(h.name,"."),"error-message")}}catch(e){s.e(e)}finally{s.f()}}this.terminal.print("You don't see any ".concat(e," that you can use."),"error-message")}},{key:"equipItem",value:function(e){var t,r=u(this.gameState.inventory);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(n.keywords.some(function(t){return e.includes(t)}))return"weapon"!==n.type&&"armor"!==n.type?void this.terminal.print("You can't equip the ".concat(n.name,"."),"error-message"):("weapon"===n.type?(this.gameState.equipWeapon(n.id),this.terminal.print("You equip the ".concat(n.name,"."),"action-result")):"armor"===n.type&&(this.gameState.equipArmor(n.id),this.terminal.print("You equip the ".concat(n.name,"."),"action-result")),void(n.onEquip&&n.onEquip(this.gameState,this.terminal)))}}catch(e){r.e(e)}finally{r.f()}this.terminal.print("You don't have any ".concat(e," to equip."),"error-message")}},{key:"showInventory",value:function(){if(0!==this.gameState.inventory.length){this.terminal.print("You are carrying:","inventory-header");var e,t=u(this.gameState.inventory);try{for(t.s();!(e=t.n()).done;){var r=e.value,n="- ".concat(r.name);this.gameState.equippedWeapon&&this.gameState.equippedWeapon.id===r.id?n+=" (equipped as weapon)":this.gameState.equippedArmor&&this.gameState.equippedArmor.id===r.id&&(n+=" (equipped as armor)"),this.terminal.print(n,"inventory-item")}}catch(e){t.e(e)}finally{t.f()}}else this.terminal.print("You aren't carrying anything.","inventory-empty")}},{key:"talkToNPC",value:function(e){var t=this.gameState.currentLocation,r=this.locations[t];if(r&&r.npcs){var n,a=u(r.npcs);try{for(a.s();!(n=a.n()).done;){var i=n.value,o=this.npcs[i];if(o&&(!o.hidden||this.gameState.flags[o.revealFlag])&&o.keywords.some(function(t){return e.includes(t)}))return!1===o.talkable?void this.terminal.print(o.cantTalkMessage||"".concat(o.name," doesn't seem interested in talking."),"error-message"):o.onTalk?void o.onTalk(this.gameState,this.terminal,this):void this.terminal.print("".concat(o.name," has nothing to say."),"error-message")}}catch(e){a.e(e)}finally{a.f()}this.terminal.print("You don't see anyone called ".concat(e," here."),"error-message")}else this.terminal.print("There's no one here to talk to.","error-message")}},{key:"attackTarget",value:function(e){var t=this.gameState.currentLocation,r=this.locations[t];if(r&&r.npcs){var n,a=u(r.npcs);try{for(a.s();!(n=a.n()).done;){var i=n.value,o=this.npcs[i];if(o&&(!o.hidden||this.gameState.flags[o.revealFlag])&&o.keywords.some(function(t){return e.includes(t)}))return!1===o.attackable?void this.terminal.print(o.cantAttackMessage||"You can't attack ".concat(o.name,"."),"error-message"):this.combatSystem?void this.combatSystem.initiateCombat(o):o.onAttack?void o.onAttack(this.gameState,this.terminal,this):void this.terminal.print("You attack ".concat(o.name," but nothing happens."),"error-message")}}catch(e){a.e(e)}finally{a.f()}this.terminal.print("You don't see anyone called ".concat(e," here."),"error-message")}else this.terminal.print("There's no one here to attack.","error-message")}},{key:"searchTarget",value:function(e){var t=this.gameState.currentLocation,r=this.locations[t];if(r&&r.npcs){var n,a=u(r.npcs);try{for(a.s();!(n=a.n()).done;){var i=n.value,o=this.npcs[i];if(o&&(!o.hidden||this.gameState.flags[o.revealFlag])&&o.keywords.some(function(t){return e.includes(t)})){if(o.isCorpse){if(o.searched)return void this.terminal.print("You have already searched the ".concat(o.name,"."),"action-result");if(o.searched=!0,o.loot&&o.loot.length>0){this.terminal.print("You search the ".concat(o.name," and find:"),"action-result"),r.items||(r.items=[]);var s,l=u(o.loot);try{for(l.s();!(s=l.n()).done;){var h=s.value,m=this.items[h.id];m&&(r.items.includes(h.id)||r.items.push(h.id),this.terminal.print("- ".concat(m.name),"item-found"))}}catch(e){l.e(e)}finally{l.f()}this.terminal.print("You can 'take' or 'get' each item individually.","action-hint")}else this.terminal.print("You search the ".concat(o.name," but find nothing of value."),"action-result");return}return void this.terminal.print("You can't search ".concat(o.name,"."),"error-message")}}}catch(e){a.e(e)}finally{a.f()}this.terminal.print("You don't see any ".concat(e," here to search."),"error-message")}else this.terminal.print("There's nothing here to search.","error-message")}},{key:"triggerWolfDeathStory",value:function(){var e=this;this.gameState.triggerWolfDeathStory=!1,this.terminal.print("\n","story-text"),this.terminal.print("As you turn your back on the terrified children and attempt to flee...","story-text"),setTimeout(function(){e.terminal.print("\nThe twisted wolf's eyes gleam with predatory hunger. It sees your cowardice.","story-text")},1500),setTimeout(function(){e.terminal.print("\nWith lightning speed, the beast lunges forward, its massive jaws clamping down on your leg.","story-text")},3e3),setTimeout(function(){e.terminal.print("\nYou scream in agony as razor-sharp teeth tear through flesh and bone.","story-text")},4500),setTimeout(function(){e.terminal.print("\nThe children's cries echo behind you as the wolf drags you into the darkness.","story-text")},6e3),setTimeout(function(){e.terminal.print("\nYour vision fades as the creature's claws rake across your chest...","story-text")},7500),setTimeout(function(){e.terminal.print("\nIn your final moments, you hear the wolf's satisfied growl and the children's screams growing distant.","story-text")},9e3),setTimeout(function(){e.terminal.print("\nYou have failed them. You have failed yourself.","story-text")},10500),setTimeout(function(){e.terminal.print("\n*** YOU HAVE DIED ***","error-message"),e.combatSystem&&e.combatSystem.playerDefeated?e.combatSystem.playerDefeated():e.gameOverReturnToTitle()},12e3)}},{key:"gameOverReturnToTitle",value:function(){this.terminal.print("\nPress Enter to return to title screen...","game-over-message"),this.setupGameOverHandler()}},{key:"setupGameOverHandler",value:function(){var e=this;this.terminal.disable();var t=function(r){"Enter"===r.key&&(r.preventDefault(),document.removeEventListener("keydown",t),e.returnToTitleScreen())};document.addEventListener("keydown",t)}},{key:"returnToTitleScreen",value:function(){this.terminal.enable(),this.terminal.clear(),document.querySelectorAll(".screen").forEach(function(e){return e.classList.remove("active")});var e=document.getElementById("title-screen");e&&e.classList.add("active")}},{key:"showHelp",value:function(){this.terminal.print("Available commands:","help-header"),this.terminal.print("- look / examine [object]: Look around or examine something specific","help-item"),this.terminal.print("- go/move [direction]: Move in a direction (north, south, east, west)","help-item"),this.terminal.print("- take/get [item]: Pick up an item","help-item"),this.terminal.print("- drop [item]: Drop an item from your inventory","help-item"),this.terminal.print("- use [item]: Use an item","help-item"),this.terminal.print("- equip [item]: Equip a weapon or armor","help-item"),this.terminal.print("- inventory/inv: Check what you're carrying","help-item"),this.terminal.print("- talk to [person]: Talk to someone","help-item"),this.terminal.print("- attack [target]: Attack a creature or person","help-item"),this.terminal.print("- search/loot [target]: Search a corpse for items","help-item"),this.terminal.print("- status: Check your health and condition","help-item"),this.terminal.print("- save: Save your game progress","help-item")}},{key:"showStatus",value:function(){this.terminal.print("Name: ".concat(this.gameState.playerName),"status-item"),this.terminal.print("Health: ".concat(this.gameState.playerHealth,"/").concat(this.gameState.playerMaxHealth),"status-item"),this.gameState.equippedWeapon?this.terminal.print("Weapon: ".concat(this.gameState.equippedWeapon.name),"status-item"):this.terminal.print("Weapon: None","status-item"),this.gameState.equippedArmor?this.terminal.print("Armor: ".concat(this.gameState.equippedArmor.name),"status-item"):this.terminal.print("Armor: None","status-item"),this.terminal.print("Memory recovered: ".concat(this.gameState.memoryRecovered,"%"),"status-item")}},{key:"update",value:function(){}}])&&g(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function v(e){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},v(e)}function b(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function w(e,t,r){return(t=function(e){var t=function(e){if("object"!=v(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=v(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==v(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var k={locations:{crossroads:{name:"Crossroads",scene:"crossroads",description:"You stand at a dusty crossroads. The dirt beneath your feet is stained with what appears to be dried blood—your blood. Your head throbs with pain, and your memory is a fog. Paths lead in four directions through the surrounding forest.",exits:{north:"forest_path_north",south:"forest_path_south",east:"forest_path_east",west:"forest_path_west"},features:[{keywords:["blood","stain","stains"],description:"Dark, dried blood stains the dirt. It seems to be yours, though you have no memory of how you were injured."},{keywords:["path","paths","road","roads"],description:"Dirt paths extend in all four directions, disappearing into the dense forest."},{keywords:["forest","trees","woods"],description:"A thick forest surrounds the crossroads, with tall trees blocking much of the sunlight."},{keywords:["ground","dirt","earth"],description:"The ground is disturbed, as if there was a struggle here. Scuff marks and overturned stones tell a story of violence.",onExamine:function(e,t){e.memoryFragments.includes("crossroads_battle")?t.print("The signs of your desperate battle are still visible in the disturbed earth.","description"):(e.memoryFragments.push("crossroads_battle"),t.print("As you examine the ground more closely, a memory flashes: You see yourself fighting multiple shadowy figures here, your sword flashing in the moonlight before something strikes you from behind.","memory-flash"),e.setFlag("rememberedAmbush",!0))}}],onFirstVisit:function(e,t){t.print("Your head pounds as you try to remember who you are and how you got here. Nothing comes to mind except a vague sense of urgency.","memory-flash")}},forest_path_west:{name:"Forest Path - West",scene:"forest_path",description:"The forest path winds westward. The trees grow closer together here, and the air feels cooler. You hear faint sounds of distress in the distance.",exits:{east:"crossroads",west:"village_outskirts"},features:[{keywords:["sounds","distress","noise","cries"],description:"The sounds seem to be coming from further west—perhaps children in trouble?"},{keywords:["trees","forest"],description:"The forest is dense here, with ancient trees towering overhead."},{keywords:["path"],description:"The dirt path continues west, leading deeper into the forest."}]},village_outskirts:{name:"Village Outskirts",scene:"village_outskirts",description:"The forest thins as the path approaches what appears to be a small village. Nearby, you hear children screaming in terror.",exits:{east:{locationId:"forest_path_west",condition:function(e){return!!e.getFlag("savedChildren")||(e.triggerWolfDeathStory=!0,!1)},blockedMessage:""},west:{locationId:"village_entrance",condition:function(e){return!!e.getFlag("savedChildren")||(e.triggerWolfDeathStory=!0,!1)},blockedMessage:""}},npcs:["child1","child2","small_creature"],items:["branch"],features:[{keywords:["village"],description:"A small village lies to the west, with simple wooden buildings visible through the trees."}],onFirstVisit:function(e,t){t.print("Two children are being attacked by a twisted, snarling creature! Without thinking, you look for something to use as a weapon.","story-event"),e.setFlag("metChildren",!0)}},village_entrance:{name:"Village Entrance",scene:"village_entrance",description:"You stand at the entrance to a modest village. Simple wooden buildings line a central dirt road. Villagers move about, though they seem wary and on edge.",exits:{east:"village_outskirts",west:"village_square",north:"village_smithy",south:"village_inn"},features:[{keywords:["buildings","houses"],description:"The buildings are simple but sturdy, made of wood with thatched roofs."},{keywords:["villagers","people"],description:"The villagers glance at you with a mixture of hope and suspicion. They seem troubled by something."}],onFirstVisit:function(e,t){e.getFlag("savedChildren")?(t.print("As you enter the village, people turn to look at you. Word of your rescue of the children has already spread.","story-event"),t.print("An older man approaches you. 'You saved those children! Please, our village needs help with another creature that's been terrorizing us.'","npc-dialog"),e.setFlag("visitedVillage",!0)):(t.print("The villagers eye you warily as you enter. You hear whispers about children being attacked outside the village.","story-event"),e.setFlag("visitedVillage",!0))}},village_square:{name:"Village Square",scene:"village_square",description:"The central square of the village. A well sits in the middle, and villagers gather in small groups, speaking in hushed tones. A village elder stands near the well.",exits:{east:"village_entrance",north:"village_elder_house",south:"village_market"},npcs:["village_elder"],features:[{keywords:["well"],description:"A stone well stands in the center of the square, providing water for the village."},{keywords:["villagers","people","groups"],description:"The villagers speak quietly among themselves, occasionally glancing in your direction."}]},village_smithy:{name:"Village Smithy",scene:"village_smithy",description:"The village blacksmith's shop. The forge is hot, and the sound of hammering fills the air. Tools and weapons line the walls.",exits:{south:"village_entrance"},npcs:["blacksmith"],items:["rusty_sword"],features:[{keywords:["forge","furnace"],description:"The forge glows with hot coals, ready for metalworking."},{keywords:["tools","weapons"],description:"Various tools and simple weapons hang on the walls or rest on racks."}]},village_inn:{name:"Village Inn",scene:"village_inn",description:"A cozy inn with a few tables and a small bar. A fire crackles in the hearth, providing warmth and light.",exits:{north:"village_entrance"},npcs:["innkeeper"],features:[{keywords:["fire","hearth","fireplace"],description:"A warm fire burns in the stone hearth, casting flickering shadows around the room."},{keywords:["tables","chairs"],description:"Wooden tables and chairs are arranged around the room, most of them empty."},{keywords:["bar"],description:"A simple wooden bar stands along one wall, with a few bottles and mugs behind it."}]},village_elder_house:{name:"Village Elder's House",scene:"village_elder_house",description:"The home of the village elder. It's larger than most houses in the village, with bookshelves lining the walls and a large table in the center.",exits:{south:"village_square"},items:["leather_armor"],features:[{keywords:["bookshelves","books"],description:"The bookshelves contain old tomes and scrolls, many of them appearing to be historical records."},{keywords:["table"],description:"A large wooden table dominates the center of the room, with a map of the surrounding area spread across it."},{keywords:["map"],description:"The map shows the village and surrounding forest. A location to the north is marked with a red X and labeled 'Creature's Den'.",revealsItem:"map_to_den",autoTake:!0},{keywords:["scroll","scrolls","parchment"],description:"Among the scrolls, one catches your eye. It bears a royal seal and mentions something about a 'Knight Commander'.",onExamine:function(e,t){e.memoryFragments.includes("royal_scroll")?t.print("The royal scroll still bears the seal of your former queen.","description"):(e.memoryFragments.push("royal_scroll"),t.print("As you read the scroll, a memory flashes: You see yourself kneeling before a throne, receiving a sword from a crowned woman. 'Protect the realm, Sir Knight,' she says.","memory-flash"),e.setFlag("rememberedKnighthood",!0))}}]},village_market:{name:"Village Market",scene:"village_market",description:"The village market area. Several stalls are set up, though many are empty or abandoned. A few villagers browse the remaining goods.",exits:{north:"village_square"},npcs:["merchant"],features:[{keywords:["stalls","stands"],description:"Most of the market stalls are empty or in disrepair. The few that remain open offer basic goods."},{keywords:["goods","wares","merchandise"],description:"The available goods are simple: some food, cloth, and basic tools. Nothing particularly valuable."}]},forest_path_north:{name:"Forest Path - North",scene:"forest_path",description:"The forest path continues northward. The trees are thinner here, allowing more sunlight to filter through.",exits:{south:"crossroads",north:{locationId:"creature_den_entrance",condition:function(e){return e.hasItem("map_to_den")},blockedMessage:"The path seems to continue north, but you're not sure where it leads. Perhaps someone in the village would know."}},features:[{keywords:["trees","forest"],description:"The forest is less dense here, with more space between the trees."},{keywords:["path"],description:"The dirt path winds northward through the forest."},{keywords:["sunlight","light"],description:"Sunlight filters through the canopy, creating dappled patterns on the ground."}]},creature_den_entrance:{name:"Creature's Den - Entrance",scene:"cave_entrance",description:"A dark cave mouth opens in the side of a small hill. Strange scratches mark the rocks around the entrance, and an unnatural silence hangs in the air.",exits:{south:"forest_path_north",north:"creature_den_interior"},features:[{keywords:["cave","entrance","mouth"],description:"The cave entrance is roughly circular, about seven feet in diameter. Claw marks surround the opening."},{keywords:["scratches","marks","claw","claws"],description:"Deep gouges in the stone suggest a creature with formidable claws. Some marks are fresh."},{keywords:["hill"],description:"The hill is small but steep, covered in sparse vegetation. The cave appears to go deep inside."}]},creature_den_interior:{name:"Creature's Den - Interior",scene:"cave_interior",description:"The inside of the cave is damp and dark. Bones litter the floor, and a foul smell permeates the air. At the back of the cave, a large creature stirs.",exits:{south:"creature_den_entrance"},npcs:["cave_creature"],items:[],features:[{keywords:["bones","remains"],description:"Animal bones are scattered across the floor, picked clean. Some appear to be from livestock, others from forest animals."},{keywords:["smell","odor","stench"],description:"A putrid smell fills the cave—a mixture of rotting meat and something else, something unnatural."}],onFirstVisit:function(e,t){t.print("As your eyes adjust to the darkness, you see a large, twisted creature at the back of the cave. It was once a bear, but now it's something else—its form warped by dark magic, with extra limbs and glowing red eyes.","story-event"),t.print("The creature growls as it notices you, rising to its feet and preparing to attack!","story-event")}},forest_path_east:{name:"Forest Path - East",scene:"forest_path",description:"The forest path extends eastward. The trees here are older and taller, with thick canopies that block much of the sunlight.",exits:{west:"crossroads",east:"forest_clearing"},features:[{keywords:["trees","forest"],description:"Ancient trees tower overhead, their massive trunks covered in moss and lichen."},{keywords:["path"],description:"The dirt path winds through the massive trees, occasionally obscured by roots and undergrowth."},{keywords:["canopy","leaves"],description:"The dense canopy high above allows only occasional shafts of sunlight to reach the forest floor."}]},forest_clearing:{name:"Forest Clearing",scene:"forest_clearing",description:"A circular clearing in the forest. Sunlight streams down, illuminating a small pond in the center. The water reflects the sky above, unnaturally still and clear.",exits:{west:"forest_path_east",east:"deep_forest"},features:[{keywords:["pond","water","pool"],description:"The pond's surface is mirror-like, reflecting the sky perfectly. As you look closer, you see not just the sky's reflection, but fleeting images—a castle, a crowned woman, a man in armor...",onExamine:function(e,t){e.memoryFragments||(e.memoryFragments=[]),e.memoryFragments.includes("pond_visions")?e.memoryFragments.length>=3?(t.print("The pond shows you more: A dark wizard casting a spell, your memories being torn away as you fall unconscious. You remember now—you were sent to stop him!","memory-flash"),e.memoryFragments.includes("wizard_betrayal")||(e.memoryFragments.push("wizard_betrayal"),e.setFlag("rememberedMission",!0))):t.print("The pond's surface ripples gently, but the visions remain unclear. Perhaps more memories would help focus what you see here.","description"):(e.memoryFragments.push("pond_visions"),t.print("The images in the water become clearer: You see yourself in shining armor, standing in a great hall. A beautiful queen speaks: 'Rise, Sir Knight. The kingdom needs your courage.'","memory-flash"),e.setFlag("rememberedKnight",!0),t.print("You remember now—you are a knight! But why were you on that road, and what happened to your armor and weapons?","memory-flash"))}},{keywords:["clearing"],description:"The clearing is a perfect circle, as if deliberately created rather than naturally formed."},{keywords:["sunlight","light"],description:"Sunlight fills the clearing, warm and bright compared to the shadowy forest around it."}]},deep_forest:{name:"Deep Forest",scene:"deep_forest",description:"The deepest part of the forest. The trees here are ancient and massive, their roots creating a maze on the forest floor. Strange glowing fungi grow on the trees, providing an eerie blue light.",exits:{west:"forest_clearing",east:{locationId:"wizard_tower_base",condition:function(e){return e.getFlag("rememberedWizard")},blockedMessage:"The forest seems to continue eastward, but something makes you hesitate. You feel you're not ready to go that way yet."}},features:[{keywords:["trees","forest"],description:"The trees here must be centuries old, with trunks wider than a man is tall. They seem to watch you with ancient awareness."},{keywords:["roots"],description:"Massive roots snake across the ground, creating natural steps and barriers."},{keywords:["fungi","mushrooms","glow"],description:"Bioluminescent fungi grow on the trees and roots, emitting a soft blue glow that illuminates the forest with otherworldly light.",onExamine:function(e,t){e.getFlag("rememberedWizard")||(t.print("As you touch one of the glowing mushrooms, another memory flashes in your mind: a tall man in flowing robes, his hands crackling with energy. 'Your queen cannot protect you now, knight,' he sneers. 'My magic will twist this land until it bows to me!'","memory-flash"),e.setFlag("rememberedWizard",!0),t.print("The wizard! He attacked you... he must have taken the queen! You must find his tower and stop him before his corruption spreads further.","memory-flash"))}}]},wizard_tower_base:{name:"Wizard's Tower - Base",scene:"wizard_tower_exterior",description:"A tall, twisted tower rises before you, its black stone seeming to absorb the light around it. The forest has been cleared in a perfect circle around the structure, and the ground is barren and cracked.",exits:{west:"deep_forest",enter:"wizard_tower_entrance"},features:[{keywords:["tower","structure"],description:"The tower spirals upward, its architecture defying natural laws. Windows glow with an unnatural purple light at irregular intervals along its height."},{keywords:["ground","earth","soil"],description:"The ground around the tower is dead and cracked, as if all life has been drained from it."},{keywords:["door","entrance"],description:"A heavy iron door stands at the base of the tower, covered in strange arcane symbols."},{keywords:["symbols","runes","markings"],description:"The arcane symbols pulse with a faint purple light. As you study them, they seem familiar...",onExamine:function(e,t){e.getFlag("rememberedMission")&&!e.memoryFragments.includes("tower_symbols")?(e.memoryFragments.push("tower_symbols"),t.print("The symbols trigger a memory: You remember studying these same runes in the royal library, preparing for your mission to stop the dark wizard Malachar!","memory-flash"),e.setFlag("rememberedWizardName",!0)):e.getFlag("rememberedMission")?t.print("The symbols of Malachar's dark magic. You know what lies beyond this door.","description"):t.print("The symbols seem familiar, but you can't quite place where you've seen them before.","description")}}],onFirstVisit:function(e,t){t.print("As you approach the tower, your final memories return in a rush: You led a group of knights to confront the wizard after he threatened the queen. There was a battle... your companions fell... and the wizard struck you down with a spell that sent you flying through the air.","memory-flash"),t.print("You remember crashing to the ground at the crossroads, your armor shattered, your mind wiped clean by the impact. But now you remember everything—and the queen is still in danger.","memory-flash"),e.setFlag("rememberedQueen",!0),e.setFlag("foundTower",!0)}},forest_path_south:{name:"Forest Path - South",scene:"forest_path",description:"The forest path leads southward. The trees thin out slightly here, and you can see rolling hills in the distance.",exits:{north:"crossroads",south:"hillside"},features:[{keywords:["trees","forest"],description:"The forest is less dense here, with more space between the trees."},{keywords:["path"],description:"The dirt path winds southward toward the hills."},{keywords:["hills","distance"],description:"Rolling hills can be seen to the south, their slopes covered in tall grass."}]},hillside:{name:"Hillside",scene:"hillside",description:"You stand on a grassy hillside overlooking a vast valley. In the far distance, you can see what appears to be a castle or large stone structure.",exits:{north:"forest_path_south"},features:[{keywords:["hills","hillside","grass"],description:"The hills are covered in tall grass that waves gently in the breeze."},{keywords:["valley"],description:"A wide valley stretches before you, with fields and small clusters of trees."},{keywords:["castle","structure","distance"],description:"In the far distance, you can make out what appears to be a castle or large stone structure. It's too far to reach from here, but seeing it triggers a sense of familiarity.",onExamine:function(e,t){e.getFlag("rememberedKnight")||t.print("As you gaze at the distant castle, you feel a strong sense of duty and belonging. Though you can't remember details, you know that place is important to you.","memory-flash")}}]}},items:{branch:{name:"Sturdy Branch",description:"A thick, sturdy branch that could serve as a makeshift weapon.",keywords:["branch","stick","weapon"],type:"weapon",damage:5,takeable:!0},rusty_sword:{name:"Rusty Sword",description:"An old sword with a rusty blade. Despite its condition, it's still sharp enough to be effective.",keywords:["sword","rusty","blade","weapon"],type:"weapon",damage:10,takeable:!0,hidden:!0,revealFlag:"visitedVillage"},leather_armor:{name:"Leather Armor",description:"A simple set of leather armor. It's worn but serviceable, offering basic protection.",keywords:["armor","leather","protection"],type:"armor",protection:3,speedPenalty:1,takeable:!0,hidden:!0,revealFlag:"visitedVillage"},map_to_den:{name:"Map to Creature's Den",description:"A rough map showing the location of a creature's den north of the village.",keywords:["map","parchment","paper"],type:"quest",takeable:!0,usable:!0,onUse:function(e,t){return t.print("You study the map. It shows a path leading north from the crossroads to a small cave in the hills. The cave is marked as 'Creature's Den'.","item-use"),!0}},steel_sword:{name:"Steel Sword",description:"A well-crafted steel sword with a sharp edge and good balance.",keywords:["sword","steel","blade","weapon"],type:"weapon",damage:15,takeable:!0},chainmail:{name:"Chainmail Armor",description:"A shirt of interlocking metal rings, providing good protection without sacrificing too much mobility.",keywords:["chainmail","armor","mail","chain"],type:"armor",protection:5,speedPenalty:2,takeable:!0},health_potion:{name:"Health Potion",description:"A small vial containing a red liquid that smells of herbs and magic.",keywords:["potion","health","vial","healing"],type:"consumable",takeable:!0,usable:!0,usableInCombat:!0,onUse:function(e,t){return e.heal(25),t.print("You drink the potion. A warm sensation spreads through your body as your wounds begin to close.","item-use"),t.print("Your health is now ".concat(e.playerHealth,"/").concat(e.playerMaxHealth,"."),"status-update"),e.removeFromInventory("health_potion"),!0},onCombatUse:function(e,t,r,n){return e.heal(25),t.print("You quickly drink the potion. A warm sensation spreads through your body as your wounds begin to close.","item-use"),t.print("Your health is now ".concat(e.playerHealth,"/").concat(e.playerMaxHealth,"."),"status-update"),e.removeFromInventory("health_potion"),!0}},knight_signet:{name:"Knight's Signet Ring",description:"A heavy gold ring bearing the royal coat of arms. It feels familiar in your hand.",keywords:["ring","signet","gold","royal"],type:"quest",takeable:!0,hidden:!0,revealFlag:"defeatedCaveCreature",onTake:function(e,t){e.memoryFragments.includes("knight_signet")||(e.memoryFragments.push("knight_signet"),t.print("As you slip the ring onto your finger, memories flood back: You remember your oath of service, your training in the royal guard, and your true name—Sir Aldric of Westmarch!","memory-flash"),e.setFlag("rememberedName",!0),e.playerName="Sir Aldric of Westmarch")}},memory_crystal:{name:"Memory Crystal",description:"A small, glowing crystal that pulses with inner light. It seems to resonate with your thoughts.",keywords:["crystal","memory","gem","stone"],type:"quest",takeable:!0,usable:!0,onUse:function(e,t){return e.memoryFragments.length>=5?(t.print("The crystal glows brightly as it absorbs your recovered memories. You feel your mind becoming clearer and more focused. Your maximum health increases!","memory-flash"),e.maxHealth+=15,e.health+=15,!0):(t.print("The crystal glows faintly, but you need more memories to unlock its power.","description"),!1)}},wolf_pelt:{name:"Wolf Pelt",description:"A rough pelt from a twisted wolf. The fur is patchy and has an unnatural texture, but it might be useful for crafting.",keywords:["pelt","fur","hide","wolf"],type:"material",takeable:!0},twisted_claw:{name:"Twisted Claw",description:"A sharp claw from a corrupted creature. It's unnaturally hard and seems to shimmer with dark energy.",keywords:["claw","talon","twisted"],type:"material",takeable:!0},bear_hide:{name:"Bear Hide",description:"A thick hide from a massive bear. Despite the creature's corruption, the hide is still valuable and could be used for armor.",keywords:["hide","skin","bear"],type:"material",takeable:!0},bear_claws:{name:"Bear Claws",description:"Massive claws from a twisted bear. They're razor-sharp and could potentially be crafted into weapons.",keywords:["claws","talons","bear"],type:"material",takeable:!0}},npcs:{child1:{name:"Village Boy",description:"A young boy, no more than ten years old, with tousled hair and wide, frightened eyes.",presenceDescription:"A young boy cowers against a tree, trying to protect a smaller girl.",keywords:["boy","child","kid","children"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,r){e.getFlag("savedChildren")?t.print("'Thank you for saving us,' the boy says, still trembling. 'That thing came from the forest. There are more of them around the village lately.'","npc-dialog"):t.print("'Please help us!' the boy cries. 'That monster is going to eat us!'","npc-dialog")}},child2:{name:"Village Girl",description:"A small girl with braided hair, tears streaming down her face.",presenceDescription:"A little girl huddles close to the boy, sobbing quietly.",keywords:["girl","child","kid","children"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,r){e.getFlag("savedChildren")?(t.print("'Are you a knight?' the girl asks between sniffles. 'My papa says knights protect people from monsters.'","npc-dialog"),e.getFlag("rememberedKnight")||t.print("Something about her words resonates with you. Knight... The title feels right somehow.","memory-flash")):t.print("The girl is too frightened to speak, only sobbing and pointing at the creature.","npc-dialog")}},small_creature:{name:"Twisted Wolf",description:"What might once have been a wolf, now warped by dark magic. Its fur is patchy, revealing scaled skin underneath, and its eyes glow with an unnatural red light.",presenceDescription:"A twisted, wolf-like creature snarls and advances toward the children, its movements jerky and unnatural.",combatDescription:"The creature's jaws drip with saliva as it turns its attention to you, growling deeply.",keywords:["creature","monster","wolf","beast"],talkable:!1,attackable:!0,hidden:!1,health:20,maxHealth:20,damage:4,speed:6,onDefeat:function(e,t,r){t.print("The twisted wolf collapses, its unnatural red glow fading from its eyes. The children are safe!","combat-aftermath"),e.setFlag("savedChildren",!0);var n=r.locations.village_outskirts;n.description="The forest thins as the path approaches what appears to be a small village. The children you saved have run back to safety.";var a=n.npcs.indexOf("small_creature");-1!==a&&n.npcs.splice(a,1);var i=n.npcs.indexOf("child1");-1!==i&&n.npcs.splice(i,1);var o=n.npcs.indexOf("child2");-1!==o&&n.npcs.splice(o,1),t.print("'Thank you!' the boy cries, helping the girl to her feet. 'We need to get back to the village. You should come too—our elder will want to thank you.'","npc-dialog"),t.print("The children run toward the village to the west.","story-event")}},village_elder:{name:"Village Elder",description:"An elderly man with a long gray beard and kind eyes that have seen much hardship. He walks with the aid of a wooden staff.",presenceDescription:"An elderly man with a long gray beard stands near the well, watching you with interest.",keywords:["elder","old man","man","villager"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,r){e.getFlag("savedChildren")?(t.print("'You have our thanks for saving those children,' the elder says. 'These are dark times. Strange creatures have been appearing in the forest, twisted by some evil magic.'","npc-dialog"),t.print("'One larger beast has made its den north of here. It's been taking our livestock and threatening travelers. If you could deal with it, we would be most grateful. I've marked its location on a map in my house.'","npc-dialog"),e.getFlag("defeatedVillageMonster")&&t.print("'You've defeated the creature? Remarkable! You have the bearing of a warrior—perhaps even a knight. There are rumors that the royal knights were defeated by an evil wizard who has captured the queen. These twisted creatures began appearing after that.'","npc-dialog")):t.print("'Welcome, stranger,' the elder says. 'You seem lost. Our village has seen better days—we're plagued by strange creatures from the forest.'","npc-dialog")}},blacksmith:{name:"Village Blacksmith",description:"A muscular woman with soot-stained arms and a leather apron. Her hands are calloused from years of metalwork.",presenceDescription:"A strong-looking woman works at the forge, hammering a piece of metal.",keywords:["blacksmith","smith","woman"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,r){e.getFlag("savedChildren")?(t.print("'Heard you saved those kids,' the blacksmith says, pausing her work. 'We need more people like you around here. Take that old sword if you want—it's not much, but it's better than nothing.'","npc-dialog"),r.items.rusty_sword.hidden=!1):t.print("'Don't have time to chat,' the blacksmith says without looking up from her work. 'Unless you're buying something.'","npc-dialog")}},innkeeper:{name:"Innkeeper",description:"A portly man with a friendly face and a stained apron. He has the look of someone who enjoys sampling his own cooking.",presenceDescription:"A heavyset man stands behind the bar, wiping a mug with a cloth.",keywords:["innkeeper","barkeeper","bartender","man"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,r){t.print("'Welcome to the Twisted Oak Inn,' the innkeeper says with a smile. 'Not many travelers these days, what with the strange creatures about. Can I get you something to drink?'","npc-dialog"),e.getFlag("defeatedVillageMonster")&&(t.print("'You're the one who killed that beast in the cave? Drinks are on the house! We haven't had a proper hero around here since... well, since before the wizard took the queen.'","npc-dialog"),e.hasItem("health_potion")||(t.print("'Here, take this healing potion. A traveling merchant left it as payment. Might come in handy for someone like you.'","npc-dialog"),e.addToInventory(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?b(Object(r),!0).forEach(function(t){w(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):b(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({id:"health_potion"},r.items.health_potion)),t.print("You received: Health Potion","item-received")))}},merchant:{name:"Traveling Merchant",description:"A thin woman with sharp eyes and colorful clothes. She has a small cart of goods beside her.",presenceDescription:"A merchant with a small cart watches you carefully, evaluating you as a potential customer.",keywords:["merchant","trader","seller","woman"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,r){t.print("'Interested in trading?' the merchant asks. 'I don't have much these days—the roads are too dangerous with all these creatures about. I heard a wizard is responsible, twisting animals with dark magic.'","npc-dialog"),e.getFlag("rememberedWizard")&&(t.print("'A wizard, you say? Yes, I remember now. He attacked the royal castle and took the queen. I need to find his tower.'","player-dialog"),t.print("The merchant's eyes widen. 'The wizard's tower? They say it's deep in the eastern forest, but no one who's gone looking for it has returned. You'd have to be mad—or a hero—to go there.'","npc-dialog"))}},cave_creature:{name:"Twisted Bear",description:"A massive bear warped by dark magic. Its body is asymmetrical, with extra limbs growing from its torso, and its eyes glow with malevolent red light.",presenceDescription:"A huge, twisted bear-like creature growls at the back of the cave, its red eyes fixed on you.",combatDescription:"The monstrous bear rises to its full height, easily eight feet tall. Multiple limbs end in razor-sharp claws, and its jaws are filled with too many teeth.",keywords:["creature","monster","bear","beast"],talkable:!1,attackable:!0,hidden:!1,health:50,maxHealth:50,damage:8,speed:4,rewards:{healthIncrease:10,items:["chainmail","steel_sword","knight_signet"]},onDefeat:function(e,t,r){t.print("The twisted bear collapses with a final roar. As it dies, you notice its form seems to partially revert to that of a normal bear, though the corruption is too deep to fully disappear.","combat-aftermath"),e.setFlag("defeatedVillageMonster",!0),t.print("At the back of the cave, you find what appears to be the creature's hoard—items taken from its victims.","story-event");var n=r.locations.creature_den_interior,a=n.npcs.indexOf("cave_creature");-1!==a&&n.npcs.splice(a,1),n.description="The inside of the cave is damp and dark. Bones litter the floor, and a foul smell permeates the air. The twisted bear lies dead at the back of the cave."}}}};function S(e){return S="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},S(e)}function T(e){return function(e){if(Array.isArray(e))return A(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||_(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function E(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,s=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){s=!0,i=e},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw i}}}}function _(e,t){if(e){if("string"==typeof e)return A(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?A(e,t):void 0}}function A(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function C(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function I(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?C(Object(r),!0).forEach(function(t){x(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):C(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function x(e,t,r){return(t=F(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function O(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,F(n.key),n)}}function F(e){var t=function(e){if("object"!=S(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=S(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==S(t)?t:t+""}var L=function(){return e=function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.gameState=t,this.terminal=r,this.storyEngine=n,this.inCombat=!1,this.currentEnemy=null,this.playerTurn=!0,this.initializeCommandHandlers()},(t=[{key:"continueCombatInit",value:function(){this.setupCombatHandlers(),this.terminal.print("".concat(this.currentEnemy.name,"'s Health: ").concat(this.currentEnemy.health,"/").concat(this.currentEnemy.maxHealth),"enemy-stats"),this.terminal.print("Your Health: ".concat(this.gameState.health,"/").concat(this.gameState.maxHealth),"player-stats"),this.showCombatActions()}},{key:"setupCombatHandlers",value:function(){var e=this;this.originalHandlers=I({},this.terminal.commandHandlers),this.terminal.commandHandlers={},this.terminal.registerCommand("^(attack|fight|hit|strike)$",function(){e.inCombat&&e.playerTurn?e.playerAttack():e.inCombat?e.terminal.print("It's not your turn to attack.","error-message"):e.terminal.print("There's nothing to attack right now.","error-message")}),this.terminal.registerCommand("^(defend|block|parry)$",function(){e.inCombat&&e.playerTurn?e.playerDefend():e.inCombat?e.terminal.print("It's not your turn to defend.","error-message"):e.terminal.print("There's no need to defend right now.","error-message")}),this.terminal.registerCommand("^(use) (.+)$",function(t){if(e.inCombat&&e.playerTurn){var r=t.match(/^use\s+(.+)$/i)[1].toLowerCase();e.useItemInCombat(r)}else{if(!e.inCombat)return!1;e.terminal.print("It's not your turn to use an item.","error-message")}}),this.terminal.registerCommand("^(flee|escape|run)$",function(){e.inCombat&&e.playerTurn?e.attemptFlee():e.inCombat?e.terminal.print("It's not your turn to flee.","error-message"):e.terminal.print("There's nothing to flee from right now.","error-message")}),this.terminal.registerCommand("^(switch|change) weapon$",function(){e.inCombat&&e.playerTurn?e.showWeaponSwitchOptions():e.inCombat?e.terminal.print("It's not your turn to switch weapons.","error-message"):e.terminal.print("You can switch weapons outside of combat using 'equip [weapon name]'.","error-message")})}},{key:"displayWeaponStatus",value:function(){var e=this;this.terminal.print("\n--- WEAPON STATUS ---","combat-header"),this.gameState.equippedWeapon?this.terminal.print("Currently equipped: ".concat(this.gameState.equippedWeapon.name," (Damage: ").concat(this.gameState.equippedWeapon.damage,")"),"weapon-equipped"):this.terminal.print("Currently equipped: Bare hands (Damage: 5)","weapon-equipped");var t=this.getAvailableWeapons();t.length>0&&(this.terminal.print("\nWeapons in inventory:","weapon-list-header"),t.forEach(function(t,r){var n=e.gameState.equippedWeapon&&e.gameState.equippedWeapon.id===t.id?" (equipped)":"";e.terminal.print("- ".concat(t.name," (Damage: ").concat(t.damage,")").concat(n),"weapon-option")}),this.terminal.print("Type 'switch weapon' to change weapons during combat.","combat-hint"))}},{key:"showWeaponSwitchOptions",value:function(){var e=this,t=this.getAvailableWeapons();0!==t.length?(this.terminal.print("\nSelect a weapon to switch to:","combat-prompt"),t.forEach(function(t,r){var n=e.gameState.equippedWeapon&&e.gameState.equippedWeapon.id===t.id?" (currently equipped)":"";e.terminal.print("".concat(r+1,". ").concat(t.name," (Damage: ").concat(t.damage,")").concat(n),"weapon-option")}),this.terminal.print("\nType the number of the weapon to switch to it, or 'cancel' to return to combat:","combat-prompt"),this.setupWeaponSwitchHandlers(t)):this.terminal.print("You have no weapons in your inventory to switch to.","error-message")}},{key:"setupWeaponSwitchHandlers",value:function(e){var t=this;this.combatHandlers=I({},this.terminal.commandHandlers),this.terminal.commandHandlers={};for(var r=function(){var r=n;t.terminal.registerCommand("^".concat(n+1,"$"),function(){var n=e[r];t.gameState.equippedWeapon&&t.gameState.equippedWeapon.id===n.id?t.terminal.print("You already have the ".concat(n.name," equipped."),"combat-info"):t.gameState.equipWeapon(n.id)?t.terminal.print("You switch to your ".concat(n.name,"."),"combat-equip"):t.terminal.print("Failed to equip the ".concat(n.name,"."),"error-message"),t.restoreCombatHandlers()})},n=0;n<e.length;n++)r();this.terminal.registerCommand("^(cancel|back|return)$",function(){t.terminal.print("You decide to keep your current weapon.","combat-choice"),t.restoreCombatHandlers()})}},{key:"restoreCombatHandlers",value:function(){this.terminal.commandHandlers=this.combatHandlers,this.combatHandlers=null}},{key:"promptBranchChoice",value:function(){this.terminal.print("\nYou're about to fight with your bare hands!","combat-warning"),this.terminal.print("You notice a branch nearby that could serve as a weapon.","combat-suggestion"),this.terminal.print("\nWhat would you like to do?","combat-prompt"),this.terminal.print("1. Take the branch and equip it","combat-option"),this.terminal.print("2. Fight with bare hands","combat-option"),this.terminal.print("\nType '1' or '2' to choose:","combat-prompt"),this.setupBranchChoiceHandlers()}},{key:"setupBranchChoiceHandlers",value:function(){var e=this;this.originalHandlers=I({},this.terminal.commandHandlers),this.terminal.commandHandlers={},this.terminal.registerCommand("^1$",function(){e.restoreCommandHandlers(),e.takeBranchAndEquip()}),this.terminal.registerCommand("^2$",function(){e.restoreCommandHandlers(),e.terminal.print("You decide to fight with your bare hands. Brave, but dangerous!","combat-choice"),e.continueCombatInit()}),this.terminal.registerCommand(".*",function(){e.terminal.print("Please type '1' to take the branch or '2' to fight bare handed.","error-message")})}},{key:"takeBranchAndEquip",value:function(){var e=this.storyEngine.locations[this.gameState.currentLocation],t=this.storyEngine.items.branch,r=e.items.indexOf("branch");r>-1&&e.items.splice(r,1),this.gameState.addToInventory(I({id:"branch"},t)),this.gameState.equipWeapon(I({id:"branch"},t)),this.terminal.print("You quickly grab the ".concat(t.name.toLowerCase()," and ready it as a weapon!"),"action-result"),this.terminal.print("".concat(t.name," equipped!"),"equip-success"),this.continueCombatInit()}},{key:"getAvailableWeapons",value:function(){return this.gameState.inventory.filter(function(e){return"weapon"===e.type})}},{key:"promptWeaponEquip",value:function(e){var t=this;this.terminal.print("\nYou have no weapon equipped, but you have weapons in your inventory:","combat-warning"),e.forEach(function(e,r){t.terminal.print("".concat(r+1,". ").concat(e.name," (Damage: ").concat(e.damage,")"),"weapon-option")}),this.terminal.print("\nWould you like to equip a weapon before fighting?","combat-prompt"),this.terminal.print("Type the number of the weapon to equip it, or 'no' to fight unarmed:","combat-prompt"),this.setupWeaponSelectionHandlers(e)}},{key:"setupWeaponSelectionHandlers",value:function(e){var t=this;this.originalHandlers=I({},this.terminal.commandHandlers),this.terminal.commandHandlers={};for(var r=function(){var r=n;t.terminal.registerCommand("^".concat(n+1,"$"),function(){var n=e[r];t.gameState.equipWeapon(n.id)&&(t.terminal.print("You equip the ".concat(n.name,"."),"combat-equip"),t.restoreCommandHandlers(),t.continueCombatInit())})},n=0;n<e.length;n++)r();this.terminal.registerCommand("^(no|n)$",function(){t.terminal.print("You decide to fight unarmed.","combat-choice"),t.restoreCommandHandlers(),t.continueCombatInit()})}},{key:"restoreCommandHandlers",value:function(){this.terminal.commandHandlers=this.originalHandlers,this.originalHandlers=null}},{key:"initializeCommandHandlers",value:function(){var e=this;this.storyEngine||this.terminal.registerCommand("^(attack|fight|hit|strike)$",function(){e.inCombat&&e.playerTurn?e.playerAttack():e.inCombat?e.terminal.print("It's not your turn to attack.","error-message"):e.terminal.print("There's nothing to attack right now.","error-message")}),this.terminal.registerCommand("^(defend|block|parry)$",function(){e.inCombat&&e.playerTurn?e.playerDefend():e.inCombat?e.terminal.print("It's not your turn to defend.","error-message"):e.terminal.print("There's no need to defend right now.","error-message")}),this.terminal.registerCommand("^(use) (.+)$",function(t){if(e.inCombat&&e.playerTurn){var r=t.match(/^use\s+(.+)$/i)[1].toLowerCase();e.useItemInCombat(r)}else{if(!e.inCombat)return!1;e.terminal.print("It's not your turn to use an item.","error-message")}}),this.terminal.registerCommand("^(flee|escape|run)$",function(){e.inCombat&&e.playerTurn?e.attemptFlee():e.inCombat?e.terminal.print("It's not your turn to flee.","error-message"):e.terminal.print("There's nothing to flee from right now.","error-message")})}},{key:"initiateCombat",value:function(e){if(this.inCombat=!0,this.currentEnemy=e,this.playerTurn=!0,this.terminal.print("\n--- COMBAT STARTED ---","combat-header"),this.terminal.print("You are fighting ".concat(e.name,"!"),"combat-start"),this.terminal.print(e.combatDescription||e.description,"combat-description"),!this.gameState.equippedWeapon){var t=this.getAvailableWeapons();if(t.length>0)return void this.promptWeaponEquip(t);var r=this.storyEngine.locations[this.gameState.currentLocation];if(r&&r.items&&r.items.includes("branch")){var n=this.storyEngine.items.branch;if(n&&(!n.hidden||this.gameState.flags[n.revealFlag]))return void this.promptBranchChoice()}}this.continueCombatInit()}},{key:"showCombatActions",value:function(){this.terminal.print("\nAvailable actions:","combat-actions-header"),this.terminal.print("- attack: Attack the enemy","combat-action"),this.terminal.print("- defend: Take a defensive stance to reduce damage","combat-action"),this.terminal.print("- use [item]: Use an item from your inventory","combat-action"),this.terminal.print("- flee: Attempt to escape from combat","combat-action"),this.terminal.print("- switch weapon: Change your equipped weapon","combat-action")}},{key:"playerAttack",value:function(){var e=this;if(!this.gameState.equippedWeapon){var t=this.storyEngine.locations[this.gameState.currentLocation];if(t&&t.items&&t.items.includes("branch")){var r=this.storyEngine.items.branch;!r||r.hidden&&!this.gameState.flags[r.revealFlag]||(this.terminal.print("You're fighting with your bare hands! You notice a ".concat(r.name.toLowerCase()," nearby that could serve as a weapon."),"combat-suggestion"),this.terminal.print("Try 'take branch' and then 'equip branch' to improve your combat effectiveness!","combat-suggestion"))}}var n=5,a=1;if(this.gameState.equippedWeapon&&(n=this.gameState.equippedWeapon.damage||10,this.gameState.equippedWeapon.effects)){var i,o=E(this.gameState.equippedWeapon.effects);try{for(o.s();!(i=o.n()).done;){var s=i.value;"damageMultiplier"===s.type&&(a*=s.value)}}catch(e){o.e(e)}finally{o.f()}}var l=.8+.4*Math.random(),h=Math.floor(n*a*l);this.currentEnemy.health-=h,this.gameState.equippedWeapon?this.terminal.print("You attack ".concat(this.currentEnemy.name," with your ").concat(this.gameState.equippedWeapon.name,", dealing ").concat(h," damage!"),"player-attack"):this.terminal.print("You attack ".concat(this.currentEnemy.name," with your bare hands, dealing ").concat(h," damage!"),"player-attack"),this.currentEnemy.health<=0?this.enemyDefeated():(this.playerTurn=!1,this.terminal.print("".concat(this.currentEnemy.name,"'s Health: ").concat(this.currentEnemy.health,"/").concat(this.currentEnemy.maxHealth),"enemy-stats"),setTimeout(function(){return e.enemyTurn()},1500))}},{key:"playerDefend",value:function(){var e=this;this.defending=!0,this.terminal.print("You take a defensive stance, preparing to block the next attack.","player-defend"),this.playerTurn=!1,setTimeout(function(){return e.enemyTurn()},1500)}},{key:"useItemInCombat",value:function(e){var t,r=this,n=E(this.gameState.inventory);try{for(n.s();!(t=n.n()).done;){var a=t.value;if(a.keywords.some(function(t){return e.includes(t)})){if(!1===a.usableInCombat)return void this.terminal.print("You can't use the ".concat(a.name," during combat."),"error-message");if(a.onCombatUse){if(!1!==a.onCombatUse(this.gameState,this.terminal,this.currentEnemy,this)){if(this.playerTurn=!1,this.currentEnemy.health<=0)return void this.enemyDefeated();setTimeout(function(){return r.enemyTurn()},1500)}return}if(a.onUse){if(!1!==a.onUse(this.gameState,this.terminal,this.storyEngine)){if(this.playerTurn=!1,this.currentEnemy.health<=0)return void this.enemyDefeated();setTimeout(function(){return r.enemyTurn()},1500)}return}return void this.terminal.print("You're not sure how to use the ".concat(a.name," in combat."),"error-message")}}}catch(e){n.e(e)}finally{n.f()}this.terminal.print("You don't have any ".concat(e," to use."),"error-message")}},{key:"attemptFlee",value:function(){var e=this,t=this.currentEnemy.speed||5,r=5;this.gameState.equippedArmor&&(r-=this.gameState.equippedArmor.speedPenalty||0);var n=.5+.05*(r-t);Math.random()<n?(this.terminal.print("You successfully escape from combat!","combat-flee"),this.endCombat()):(this.terminal.print("You try to escape, but ".concat(this.currentEnemy.name," blocks your path!"),"combat-flee-fail"),this.playerTurn=!1,setTimeout(function(){return e.enemyTurn()},1500))}},{key:"enemyTurn",value:function(){var e=this.currentEnemy.damage||5,t=.8+.4*Math.random(),r=0;this.gameState.equippedArmor&&(r=this.gameState.equippedArmor.protection||0),this.defending&&(r+=5,this.terminal.print("Your defensive stance reduces the incoming damage!","combat-defend"),this.defending=!1);var n=Math.max(1,Math.floor(e*t-r));if(this.gameState.health-=n,this.terminal.print("".concat(this.currentEnemy.name," attacks you, dealing ").concat(n," damage!"),"enemy-attack"),this.terminal.print("Your Health: ".concat(this.gameState.health,"/").concat(this.gameState.maxHealth),"player-stats"),this.gameState.health<=0)return this.gameState.health=0,void this.playerDefeated();this.playerTurn=!0,this.showCombatActions()}},{key:"enemyDefeated",value:function(){if(this.terminal.print("\nYou have defeated ".concat(this.currentEnemy.name,"!"),"combat-victory"),this.currentEnemy.rewards&&(this.currentEnemy.rewards.healthIncrease&&(this.gameState.maxHealth+=this.currentEnemy.rewards.healthIncrease,this.gameState.health+=this.currentEnemy.rewards.healthIncrease,this.terminal.print("Your maximum health increases by ".concat(this.currentEnemy.rewards.healthIncrease,"!"),"reward")),this.currentEnemy.rewards.items)){var e,t=E(this.currentEnemy.rewards.items);try{for(t.s();!(e=t.n()).done;){var r=e.value,n=this.storyEngine.items[r];n&&(this.gameState.addToInventory(I({id:r},n)),this.terminal.print("You found: ".concat(n.name),"reward"))}}catch(e){t.e(e)}finally{t.f()}}this.createCorpse(),this.currentEnemy.onDefeat&&this.currentEnemy.onDefeat(this.gameState,this.terminal,this.storyEngine),this.endCombat()}},{key:"createCorpse",value:function(){var e=this,t=this.storyEngine.locations[this.gameState.currentLocation];if(t){var r="".concat(this.currentEnemy.name.toLowerCase().replace(/\s+/g,"_"),"_corpse"),n=[],a=this.currentEnemy.name.toLowerCase();a.includes("wolf")?n=[{id:"wolf_pelt"},{id:"twisted_claw"}]:a.includes("bear")&&(n=[{id:"bear_hide"},{id:"bear_claws"}]);var i={name:"".concat(this.currentEnemy.name," Corpse"),description:"The lifeless body of the ".concat(this.currentEnemy.name.toLowerCase(),". You might be able to find something useful on it."),presenceDescription:"The corpse of the ".concat(this.currentEnemy.name.toLowerCase()," lies here."),keywords:["corpse","body","remains"].concat(T(this.currentEnemy.keywords)),talkable:!1,attackable:!1,hidden:!1,isCorpse:!0,searched:!1,originalEnemy:this.currentEnemy.name,loot:n,onExamine:function(t,r,n){r.print("The ".concat(e.currentEnemy.name.toLowerCase()," lies motionless. Its body shows the wounds from your battle."),"examine-result"),i.loot&&i.loot.length>0?r.print("You might find something useful if you search the corpse.","examine-result"):r.print("The corpse appears to have nothing of value.","examine-result")}};this.storyEngine.npcs[r]=i,t.npcs||(t.npcs=[]),t.npcs.push(r);var o=t.npcs.indexOf(this.currentEnemy.id||this.currentEnemy.name.toLowerCase().replace(/\s+/g,"_"));-1!==o&&t.npcs.splice(o,1)}}},{key:"playerDefeated",value:function(){this.terminal.print("\nYou have been defeated!","combat-defeat"),this.currentEnemy.onPlayerDefeat?this.currentEnemy.onPlayerDefeat(this.gameState,this.terminal,this.storyEngine):(this.terminal.print("\nGAME OVER","game-over"),this.terminal.print("\nPress Enter to return to title screen...","game-over-message"),this.setupGameOverHandler()),this.endCombat()}},{key:"setupGameOverHandler",value:function(){var e=this;this.terminal.disable();var t=function(r){"Enter"===r.key&&(r.preventDefault(),document.removeEventListener("keydown",t),e.returnToTitleScreen())};document.addEventListener("keydown",t)}},{key:"returnToTitleScreen",value:function(){this.terminal.enable(),this.terminal.clear(),document.querySelectorAll(".screen").forEach(function(e){return e.classList.remove("active")});var e=document.getElementById("title-screen");e&&e.classList.add("active")}},{key:"endCombat",value:function(){this.inCombat=!1,this.currentEnemy=null,this.playerTurn=!1,this.defending=!1,this.terminal.print("\n--- COMBAT ENDED ---","combat-header"),this.restoreCommandHandlers()}}])&&O(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function j(e){return j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},j(e)}function H(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,i,o,s=[],l=!0,h=!1;try{if(i=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;l=!1}else for(;!(l=(n=i.call(r)).done)&&(s.push(n.value),s.length!==t);l=!0);}catch(e){h=!0,a=e}finally{try{if(!l&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(h)throw a}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return M(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?M(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function M(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function P(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Y(n.key),n)}}function Y(e){var t=function(e){if("object"!=j(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=j(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==j(t)?t:t+""}var q=function(){return e=function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.outputElement="string"==typeof t?document.getElementById(t):t,this.inputElement="string"==typeof r?document.getElementById(r):r,this.commandHistory=[],this.historyIndex=-1,this.commandHandlers={},this.outputElement&&this.inputElement?this.init():console.error("Terminal: Could not find required DOM elements")},t=[{key:"init",value:function(){var e=this;this.inputElement.addEventListener("keydown",function(t){"Enter"===t.key?(t.preventDefault(),e.processInput()):"ArrowUp"===t.key?(t.preventDefault(),e.navigateHistory(-1)):"ArrowDown"===t.key&&(t.preventDefault(),e.navigateHistory(1))}),this.inputElement.focus(),document.getElementById("terminal-container").addEventListener("click",function(){e.inputElement.focus()})}},{key:"processInput",value:function(){var e=this.inputElement.value.trim();""!==e&&(this.commandHistory.push(e),this.historyIndex=this.commandHistory.length,this.print(e,"player-input"),this.inputElement.value="",this.parseCommand(e))}},{key:"navigateHistory",value:function(e){var t=this;0!==this.commandHistory.length&&(this.historyIndex+=e,this.historyIndex<0&&(this.historyIndex=0),this.historyIndex>this.commandHistory.length&&(this.historyIndex=this.commandHistory.length),this.historyIndex===this.commandHistory.length?this.inputElement.value="":this.inputElement.value=this.commandHistory[this.historyIndex],setTimeout(function(){t.inputElement.selectionStart=t.inputElement.value.length,t.inputElement.selectionEnd=t.inputElement.value.length},0))}},{key:"parseCommand",value:function(e){for(var t=e.toLowerCase(),r=0,n=Object.entries(this.commandHandlers);r<n.length;r++){var a=H(n[r],2),i=a[0],o=a[1];if(t.match(new RegExp(i,"i")))return void o(e)}this.print("I don't understand that command.","error-message")}},{key:"registerCommand",value:function(e,t){this.commandHandlers[e]=t}},{key:"print",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=document.createElement("div");r.className="message ".concat(t),r.textContent=e,this.outputElement.appendChild(r),this.outputElement.scrollTop=this.outputElement.scrollHeight}},{key:"getHistory",value:function(){return this.outputElement.innerHTML}},{key:"setHistory",value:function(e){"string"==typeof e?this.outputElement.innerHTML=e:Array.isArray(e)&&(this.outputElement.innerHTML=e.join("")),this.outputElement.scrollTop=this.outputElement.scrollHeight}},{key:"clear",value:function(){this.outputElement.innerHTML=""}},{key:"disable",value:function(){this.inputElement.disabled=!0}},{key:"enable",value:function(){this.inputElement.disabled=!1,this.inputElement.focus()}},{key:"printHTML",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=document.createElement("div");r.className="message ".concat(t),r.innerHTML=e,this.outputElement.appendChild(r),this.outputElement.scrollTop=this.outputElement.scrollHeight}}],t&&P(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function D(e){return D="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},D(e)}function R(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function B(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,G(n.key),n)}}function W(e,t,r){return t&&B(e.prototype,t),r&&B(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function G(e){var t=function(e){if("object"!=D(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=D(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==D(t)?t:t+""}var N=function(){return W(function e(t,r,n,a){R(this,e),this.gameState=t,this.terminal=r,this.webglRenderer=n,this.audioManager=a,this.memories={},this.memoryTriggers={},this.activeMemoryFlash=!1,this.memoryFlashStartTime=0,this.memoryFlashDuration=2e3},[{key:"registerMemory",value:function(e,t){this.memories[e]={id:e,title:t.title||"Forgotten Memory",text:t.text||"A fragment of memory returns to you...",flashImage:t.flashImage||null,recovered:!1,importance:t.importance||"minor",relatedObjectives:t.relatedObjectives||[],onRecovered:t.onRecovered||null}}},{key:"registerMemoryTrigger",value:function(e,t){this.memoryTriggers[e]={id:e,type:t.type,target:t.target,condition:t.condition||null,memoryId:t.memoryId,triggered:!1,oneTime:void 0===t.oneTime||t.oneTime}}},{key:"checkTriggers",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=[];return Object.values(this.memoryTriggers).forEach(function(i){if(!(i.triggered&&i.oneTime||i.type!==e||i.target!==t&&"*"!==i.target)){var o=!0;if(i.condition&&"function"==typeof i.condition&&(o=i.condition(r.gameState,n)),o){i.triggered=!0;var s=r.memories[i.memoryId];s&&!s.recovered&&(r.recoverMemory(i.memoryId),a.push(s))}}}),a}},{key:"recoverMemory",value:function(e){var t=this,r=this.memories[e];return!(!r||r.recovered||(r.recovered=!0,this.gameState.memoryRecovered+=1,this.gameState.knownInformation.push({type:"memory",title:r.title,text:r.text,importance:r.importance}),this.triggerMemoryFlash(r),r.onRecovered&&"function"==typeof r.onRecovered&&r.onRecovered(this.gameState,this.terminal),r.relatedObjectives&&r.relatedObjectives.length>0&&r.relatedObjectives.forEach(function(e){t.gameState.completeObjective(e)}),0))}},{key:"triggerMemoryFlash",value:function(e){this.audioManager&&this.audioManager.playSound("memory_flash"),this.activeMemoryFlash=!0,this.memoryFlashStartTime=Date.now(),this.currentMemoryFlash=e,this.terminal.printHTML('<div class="memory-flash">\n      <h3>'.concat(e.title,"</h3>\n      <p>").concat(e.text,"</p>\n    </div>")),e.flashImage&&this.webglRenderer&&this.webglRenderer.setMemoryFlashImage(e.flashImage)}},{key:"update",value:function(){if(this.activeMemoryFlash){var e=Date.now()-this.memoryFlashStartTime,t=Math.min(1,e/this.memoryFlashDuration);return this.webglRenderer&&this.webglRenderer.updateMemoryFlash(t,this.currentMemoryFlash),t>=1&&(this.activeMemoryFlash=!1,this.currentMemoryFlash=null,this.webglRenderer&&this.webglRenderer.clearMemoryFlash()),!0}return!1}},{key:"getRecoveredMemories",value:function(){return Object.values(this.memories).filter(function(e){return e.recovered})}},{key:"getAllMemories",value:function(){return this.memories}},{key:"getMemoryRecoveryProgress",value:function(){var e=Object.keys(this.memories).length;return 0===e?0:Object.values(this.memories).filter(function(e){return e.recovered}).length/e*100}},{key:"isMemoryRecovered",value:function(e){return this.memories[e]&&this.memories[e].recovered}}])}(),U=W(function e(t){R(this,e),this.id=t.id,this.title=t.title||"Forgotten Memory",this.text=t.text||"A fragment of memory returns to you...",this.flashImage=t.flashImage||null,this.importance=t.importance||"minor",this.relatedObjectives=t.relatedObjectives||[],this.onRecovered=t.onRecovered||null}),z=W(function e(t){R(this,e),this.id=t.id,this.type=t.type,this.target=t.target,this.condition=t.condition||null,this.memoryId=t.memoryId,this.oneTime=void 0===t.oneTime||t.oneTime}),V={memories:{pond_visions:new U({id:"pond_visions",title:"Visions in the Water",text:"You see flashes of yourself in gleaming armor, standing before a great castle. A woman in a crown speaks to you with urgency in her voice.",importance:"major",flashImage:"memory_castle.jpg"}),rememberedKnight:new U({id:"rememberedKnight",title:"The Knight's Oath",text:"You remember taking an oath of service, kneeling before the throne. You were a knight of the realm, sworn to protect the innocent.",importance:"critical",flashImage:"memory_oath.jpg"}),wizard_betrayal:new U({id:"wizard_betrayal",title:"The Wizard's Betrayal",text:'A trusted advisor... no, a wizard you once called friend. His face twists with malice as he raises his staff against you. "You know too much," he hisses.',importance:"critical",flashImage:"memory_betrayal.jpg"}),royal_scroll:new U({id:"royal_scroll",title:"Royal Decree",text:"The scroll bears the royal seal. You remember delivering urgent messages between the castle and distant outposts. You were a trusted messenger of the crown.",importance:"major",flashImage:"memory_scroll.jpg"}),tower_symbols:new U({id:"tower_symbols",title:"The Wizard's Name",text:"The symbols spell out a name: Malachar the Deceiver. Your former mentor, the court wizard who betrayed the realm and erased your memories.",importance:"critical",flashImage:"memory_symbols.jpg"}),crossroads_battle:new U({id:"crossroads_battle",title:"The Ambush",text:"You remember now - you were ambushed here while carrying vital intelligence about Malachar's treachery. Dark creatures overwhelmed you, but not before you hid the evidence.",importance:"critical",flashImage:"memory_ambush.jpg"}),knight_identity:new U({id:"knight_identity",title:"Your True Name",text:"Sir Aldric of Westmarch - that is who you are. A knight-errant in service to the crown, tasked with uncovering corruption in the highest ranks of the kingdom.",importance:"critical",flashImage:"memory_identity.jpg"})},triggers:{pond_examine:new z({id:"pond_examine",type:"examine",target:"pond",memoryId:"pond_visions",oneTime:!0}),pond_examine_advanced:new z({id:"pond_examine_advanced",type:"examine",target:"pond",memoryId:"wizard_betrayal",condition:function(e){return e.flags.pond_visions&&e.memoryFragments.length>=3},oneTime:!0}),scroll_examine:new z({id:"scroll_examine",type:"examine",target:"scroll",memoryId:"royal_scroll",oneTime:!0}),symbols_examine:new z({id:"symbols_examine",type:"examine",target:"symbols",memoryId:"tower_symbols",condition:function(e){return e.flags.rememberedMission},oneTime:!0}),ground_examine:new z({id:"ground_examine",type:"examine",target:"ground",memoryId:"crossroads_battle",oneTime:!0}),signet_take:new z({id:"signet_take",type:"take",target:"knight_signet",memoryId:"knight_identity",oneTime:!0})}};function $(e){return $="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$(e)}function K(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,X(n.key),n)}}function X(e){var t=function(e){if("object"!=$(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=$(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==$(t)?t:t+""}var Q=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.reset()},t=[{key:"reset",value:function(){this.playerName="",this.playerHealth=100,this.playerMaxHealth=100,this.currentLocation="crossroads",this.visitedLocations=new Set(["crossroads"]),this.completedObjectives=new Set,this.knownInformation=new Set,this.memoryRecovered=0,this.inventory=[],this.equippedWeapon=null,this.equippedArmor=null,this.flags={metChildren:!1,savedChildren:!1,visitedVillage:!1,defeatedVillageMonster:!1,rememberedKnight:!1,rememberedWizard:!1,rememberedQueen:!1,foundTower:!1}}},{key:"newGame",value:function(e){this.reset(),this.playerName=e,this.saveGame()}},{key:"saveGame",value:function(){var e={playerName:this.playerName,playerHealth:this.playerHealth,playerMaxHealth:this.playerMaxHealth,currentLocation:this.currentLocation,visitedLocations:Array.from(this.visitedLocations),completedObjectives:Array.from(this.completedObjectives),knownInformation:Array.from(this.knownInformation),memoryRecovered:this.memoryRecovered,inventory:this.inventory,equippedWeapon:this.equippedWeapon,equippedArmor:this.equippedArmor,flags:this.flags};return localStorage.setItem("forgottenSteel_saveGame",JSON.stringify(e)),!0}},{key:"loadFromSave",value:function(e){return this.playerName=e.playerName||"",this.playerHealth=e.playerHealth||100,this.playerMaxHealth=e.playerMaxHealth||100,this.currentLocation=e.currentLocation||"crossroads",this.visitedLocations=new Set(e.visitedLocations||["crossroads"]),this.completedObjectives=new Set(e.completedObjectives||[]),this.knownInformation=new Set(e.knownInformation||[]),this.memoryRecovered=e.memoryRecovered||0,this.inventory=e.inventory||[],this.equippedWeapon=e.equippedWeapon||null,this.equippedArmor=e.equippedArmor||null,this.flags=e.flags||{metChildren:!1,savedChildren:!1,visitedVillage:!1,defeatedVillageMonster:!1,rememberedKnight:!1,rememberedWizard:!1,rememberedQueen:!1,foundTower:!1},!0}},{key:"changeLocation",value:function(e){return this.currentLocation=e,this.visitedLocations.add(e),this.saveGame(),!0}},{key:"addToInventory",value:function(e){return this.inventory.push(e),this.saveGame(),!0}},{key:"removeFromInventory",value:function(e){var t=this.inventory.findIndex(function(t){return t.id===e});if(-1!==t){var r=this.inventory[t];return this.inventory.splice(t,1),this.saveGame(),r}return null}},{key:"equipWeapon",value:function(e){var t=this.inventory.find(function(t){return t.id===e&&"weapon"===t.type});return!!t&&(this.equippedWeapon=t,this.saveGame(),!0)}},{key:"equipArmor",value:function(e){var t=this.inventory.find(function(t){return t.id===e&&"armor"===t.type});return!!t&&(this.equippedArmor=t,this.saveGame(),!0)}},{key:"completeObjective",value:function(e){return this.completedObjectives.add(e),this.updateMemoryRecovered(),this.saveGame(),!0}},{key:"updateMemoryRecovered",value:function(){var e=0;this.flags.rememberedKnight&&(e+=25),this.flags.rememberedWizard&&(e+=25),this.flags.rememberedQueen&&(e+=25),e+=5*this.completedObjectives.size,this.memoryRecovered=Math.min(100,e)}},{key:"setFlag",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e in this.flags&&(this.flags[e]=t,e.startsWith("remembered")&&this.updateMemoryRecovered(),this.saveGame(),!0)}},{key:"getFlag",value:function(e){return this.flags[e]||!1}},{key:"takeDamage",value:function(e){return this.playerHealth=Math.max(0,this.playerHealth-e),this.saveGame(),this.playerHealth>0}},{key:"heal",value:function(e){return this.playerHealth=Math.min(this.playerMaxHealth,this.playerHealth+e),this.saveGame(),!0}},{key:"isObjectiveCompleted",value:function(e){return this.completedObjectives.has(e)}},{key:"hasVisitedLocation",value:function(e){return this.visitedLocations.has(e)}},{key:"hasItem",value:function(e){return this.inventory.some(function(t){return t.id===e})}}],t&&K(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function J(e){return J="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},J(e)}function Z(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,i,o,s=[],l=!0,h=!1;try{if(i=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;l=!1}else for(;!(l=(n=i.call(r)).done)&&(s.push(n.value),s.length!==t);l=!0);}catch(e){h=!0,a=e}finally{try{if(!l&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(h)throw a}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return ee(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ee(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function te(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,re(n.key),n)}}function re(e){var t=function(e){if("object"!=J(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=J(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==J(t)?t:t+""}var ne=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.titleScreen=null,this.characterCreation=null,this.gameScreen=null,this.newGameBtn=null,this.loadGameBtn=null,this.startAdventureBtn=null,this.characterNameInput=null,this.playerName="",this.currentLocation="crossroads",this.inventory=[],this.gameProgress={memoryFragments:[],questFlags:{},visitedLocations:[],defeatedEnemies:[],discoveredItems:[]},this.terminalHistory=[],this.webglRenderer=null,this.terminal=null,this.storyEngine=null,this.combatSystem=null,this.memorySystem=null,this.gameState=new Q,this.gameState.playerName="",this.gameState.currentLocation="crossroads",this.gameState.inventory=[],this.gameState.health=100,this.gameState.maxHealth=100,this.gameState.experience=0,this.gameState.level=1,this.gameState.equipment={weapon:null,armor:null},this.gameState.flags={},this.gameState.memoryFragments=[],this.gameState.memoryRecovered=0,this.gameState.knownInformation=[],this.init()},t=[{key:"isLocalStorageAvailable",value:function(){try{var e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}},{key:"init",value:function(){this.titleScreen=document.getElementById("title-screen"),this.characterCreation=document.getElementById("character-creation-screen"),this.gameScreen=document.getElementById("game-screen"),this.newGameBtn=document.getElementById("new-game-btn"),this.loadGameBtn=document.getElementById("load-game-btn"),this.startAdventureBtn=document.getElementById("start-game-btn"),this.characterNameInput=document.getElementById("player-name"),this.loadGameBtnGameOver=document.getElementById("load-game-btn-gameover"),this.newGameBtnGameOver=document.getElementById("new-game-btn-gameover"),this.titleBtnGameOver=document.getElementById("title-btn-gameover"),this.setupEventListeners(),this.showScreen("title-screen")}},{key:"setupEventListeners",value:function(){var e=this;this.newGameBtn&&this.newGameBtn.addEventListener("click",function(){return e.showCharacterCreation()}),this.loadGameBtn&&this.loadGameBtn.addEventListener("click",function(){return e.loadGame()}),this.startAdventureBtn&&this.startAdventureBtn.addEventListener("click",function(){return e.startNewGame()}),this.loadGameBtnGameOver&&this.loadGameBtnGameOver.addEventListener("click",function(){return e.loadGame()}),this.newGameBtnGameOver&&this.newGameBtnGameOver.addEventListener("click",function(){return e.showCharacterCreation()}),this.titleBtnGameOver&&this.titleBtnGameOver.addEventListener("click",function(){return e.showScreen("title-screen")})}},{key:"showScreen",value:function(e){document.querySelectorAll(".screen").forEach(function(e){return e.classList.remove("active")});var t=document.getElementById(e);t&&t.classList.add("active")}},{key:"showCharacterCreation",value:function(){this.showScreen("character-creation-screen")}},{key:"loadGame",value:function(){if(this.isLocalStorageAvailable()){var e=localStorage.getItem("forgottenSteel_saveGame");if(e)try{var t=JSON.parse(e);this.playerName=t.playerName||"",this.currentLocation=t.currentLocation||"crossroads",this.inventory=t.inventory||[],this.gameProgress=t.gameProgress||{memoryFragments:[],questFlags:{},visitedLocations:[],defeatedEnemies:[],discoveredItems:[]},this.terminalHistory=t.terminalHistory||[],this.gameState.playerName=t.playerName||"",this.gameState.currentLocation=t.currentLocation||"crossroads",this.gameState.inventory=t.inventory||[],this.gameState.health=t.health||100,this.gameState.maxHealth=t.maxHealth||100,this.gameState.experience=t.experience||0,this.gameState.level=t.level||1,this.gameState.equipment=t.equipment||{weapon:null,armor:null},this.gameState.flags=t.flags||{},this.gameState.memoryFragments=t.memoryFragments||[],this.gameState.memoryRecovered=t.memoryRecovered||0,this.gameState.knownInformation=t.knownInformation||[],this.showScreen("game-screen"),this.restoreGame();var r="Game loaded successfully! Welcome back, ".concat(this.playerName,"!");this.terminal?this.terminal.print(r,"system-message"):alert(r)}catch(e){alert("Error loading saved game. The save file may be corrupted or incompatible. Please start a new game."),console.error("Load game error:",e);try{localStorage.removeItem("forgottenSteel_saveGame")}catch(e){console.error("Failed to clear corrupted save:",e)}}else alert("No saved game found! Start a new game to begin your adventure.")}else alert("Save/Load functionality is not available in this browser or is disabled.")}},{key:"saveGame",value:function(){if(!this.isLocalStorageAvailable())return this.terminal?this.terminal.print("Save functionality is not available in this browser.","error-message"):alert("Save functionality is not available in this browser."),!1;try{var e={playerName:this.gameState.playerName,currentLocation:this.gameState.currentLocation,inventory:this.gameState.inventory,health:this.gameState.health,maxHealth:this.gameState.maxHealth,experience:this.gameState.experience,level:this.gameState.level,equipment:this.gameState.equipment,flags:this.gameState.flags,memoryFragments:this.gameState.memoryFragments,memoryRecovered:this.gameState.memoryRecovered,knownInformation:this.gameState.knownInformation,gameProgress:this.gameProgress,terminalHistory:this.terminal?this.terminal.getHistory():this.terminalHistory,saveDate:(new Date).toISOString()};localStorage.setItem("forgottenSteel_saveGame",JSON.stringify(e));var t="Game saved successfully! (".concat((new Date).toLocaleString(),")");if(this.terminal)this.terminal.print(t,"system-message");else{var r=document.getElementById("terminal-output");r?(r.innerHTML+='<p class="system-message">'.concat(t,"</p>"),r.scrollTop=r.scrollHeight):alert("Game saved successfully!")}return!0}catch(e){console.error("Failed to save game:",e);var n="Failed to save game. This may be due to insufficient storage space or browser restrictions. Please try again.";return this.terminal?this.terminal.print(n,"error-message"):alert(n),!1}}},{key:"restoreGame",value:function(){var e,t=this,r=document.getElementById("webgl-canvas");r&&(this.webglRenderer=l(r),this.renderCurrentScene()),this.terminal=new q("terminal-output","terminal-input"),this.terminalHistory.length>0&&this.terminal.setHistory(this.terminalHistory),this.memorySystem=new N(this.gameState,this.terminal,this.webglRenderer,null),e=this.memorySystem,Object.values(V.memories).forEach(function(t){e.registerMemory(t.id,t)}),Object.values(V.triggers).forEach(function(t){e.registerMemoryTrigger(t.id,t)}),this.storyEngine=new f(this.gameState,this.terminal,this.webglRenderer),this.combatSystem=new L(this.gameState,this.terminal,this.storyEngine),this.combatSystem.storyEngine=this.storyEngine,this.storyEngine.setCombatSystem(this.combatSystem),this.storyEngine.setMemorySystem(this.memorySystem),Object.entries(k.locations).forEach(function(e){var r=Z(e,2),n=r[0],a=r[1];t.storyEngine.registerLocation(n,a)}),Object.entries(k.items).forEach(function(e){var r=Z(e,2),n=r[0],a=r[1];t.storyEngine.registerItem(n,a)}),Object.entries(k.npcs).forEach(function(e){var r=Z(e,2),n=r[0],a=r[1];t.storyEngine.registerNPC(n,a)}),this.storyEngine.describeCurrentLocation(),this.startGameLoop(),this.terminal.print("Game loaded successfully. Welcome back!","system-message")}},{key:"startNewGame",value:function(){var e,t=null===(e=this.characterNameInput)||void 0===e?void 0:e.value.trim();t?(this.playerName=t,this.showScreen("game-screen"),this.initializeGame()):alert("Please enter a name for your character.")}},{key:"initializeGame",value:function(){var e=this;this.currentLocation="crossroads",this.inventory=[],this.gameProgress={memoryFragments:[],questFlags:{},visitedLocations:[],defeatedEnemies:[],discoveredItems:[]},this.terminalHistory=[],this.gameState=new Q,this.gameState.playerName=this.playerName,this.gameState.currentLocation="crossroads",this.gameState.inventory=[],this.gameState.health=100,this.gameState.maxHealth=100,this.gameState.experience=0,this.gameState.level=1,this.gameState.equipment={weapon:null,armor:null},this.gameState.flags={},this.gameState.memoryFragments=[],this.gameState.memoryRecovered=0,this.gameState.knownInformation=[];var t=document.getElementById("webgl-canvas");t&&(this.webglRenderer=l(t),this.renderCurrentScene()),this.terminal=new q("terminal-output","terminal-input"),this.storyEngine=new f(this.gameState,this.terminal,this.webglRenderer),this.combatSystem=new L(this.gameState,this.terminal,this.storyEngine),this.combatSystem.storyEngine=this.storyEngine,this.storyEngine.setCombatSystem(this.combatSystem),this.storyEngine.setMemorySystem(this.memorySystem),Object.entries(k.locations).forEach(function(t){var r=Z(t,2),n=r[0],a=r[1];e.storyEngine.registerLocation(n,a)}),Object.entries(k.items).forEach(function(t){var r=Z(t,2),n=r[0],a=r[1];e.storyEngine.registerItem(n,a)}),Object.entries(k.npcs).forEach(function(t){var r=Z(t,2),n=r[0],a=r[1];e.storyEngine.registerNPC(n,a)}),this.storyEngine.start(),this.startGameLoop()}},{key:"renderCurrentScene",value:function(){if(this.webglRenderer&&this.gameState.currentLocation){var e={crossroads:"crossroads",forest_path_north:"forest_path",forest_path_south:"forest_path",forest_path_east:"forest_path",forest_path_west:"forest_path",village_outskirts:"village_outskirts",village_entrance:"village_entrance",village_square:"village_square",village_smithy:"village_smithy",village_inn:"village_inn",village_elder_house:"village_elder_house",village_market:"village_market",creature_den_entrance:"cave_entrance",creature_den_interior:"cave_interior",forest_clearing:"forest_clearing",deep_forest:"deep_forest",wizard_tower_base:"wizard_tower_exterior",hillside:"hillside"}[this.gameState.currentLocation]||"chamber";this.webglRenderer.render(e)}}},{key:"startGameLoop",value:function(){var e=this,t=function(){e.memorySystem&&e.memorySystem.update(),requestAnimationFrame(t)};requestAnimationFrame(t)}}],t&&te(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();document.addEventListener("DOMContentLoaded",function(){new ne})})();