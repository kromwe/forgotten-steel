/*! For license information please see main.8d3c077ad45b655e7f32.js.LICENSE.txt */
(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a,o,s=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,i=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw i}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return n(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach(function(t){a(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function a(e,t,n){return(t=h(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function a(n,r,i,a){var o=r&&r.prototype instanceof c?r:c,u=Object.create(o.prototype);return s(u,"_invoke",function(n,r,i){var a,o,s,c=0,u=i||[],h=!1,m={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,n){return a=t,o=0,s=e,m.n=n,l}};function d(n,r){for(o=n,s=r,t=0;!h&&c&&!i&&t<u.length;t++){var i,a=u[t],d=m.p,g=a[2];n>3?(i=g===r)&&(s=a[(o=a[4])?5:(o=3,3)],a[4]=a[5]=e):a[0]<=d&&((i=n<2&&d<a[1])?(o=0,m.v=r,m.n=a[1]):d<g&&(i=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,o=0))}if(i||n>1)return l;throw h=!0,r}return function(i,u,g){if(c>1)throw TypeError("Generator is already running");for(h&&1===u&&d(u,g),o=u,s=g;(t=o<2?e:s)||!h;){a||(o?o<3?(o>1&&(m.n=-1),d(o,s)):m.n=s:m.v=s);try{if(c=2,a){if(o||(i="next"),t=a[i]){if(!(t=t.call(a,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,o<2&&(o=0)}else 1===o&&(t=a.return)&&t.call(a),o<2&&(s=TypeError("The iterator does not provide a '"+i+"' method"),o=1);a=e}else if((t=(h=m.n<0)?s:n.call(r,m))!==l)break}catch(t){a=e,o=1,s=t}finally{c=1}}return{value:t,done:h}}}(n,i,a),!0),u}var l={};function c(){}function u(){}function h(){}t=Object.getPrototypeOf;var m=[][r]?t(t([][r]())):(s(t={},r,function(){return this}),t),d=h.prototype=c.prototype=Object.create(m);function g(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,s(e,i,"GeneratorFunction")),e.prototype=Object.create(d),e}return u.prototype=h,s(d,"constructor",h),s(h,"constructor",u),u.displayName="GeneratorFunction",s(h,i,"GeneratorFunction"),s(d),s(d,i,"Generator"),s(d,r,function(){return this}),s(d,"toString",function(){return"[object Generator]"}),(o=function(){return{w:a,m:g}})()}function s(e,t,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}s=function(e,t,n,r){function a(t,n){s(e,t,function(e){return this._invoke(t,n,e)})}t?i?i(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},s(e,t,n,r)}function l(e,t,n,r,i,a,o){try{var s=e[a](o),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,i)}function c(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var a=e.apply(t,n);function o(e){l(a,r,i,o,s,"next",e)}function s(e){l(a,r,i,o,s,"throw",e)}o(void 0)})}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,h(r.key),r)}}function h(t){var n=function(t){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=e(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(n)?n:n+""}var m=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.canvas=t,this.gl=null,this.program=null,this.textures={},this.currentScene=null,this.dynamicImage=null,this.init()},n=[{key:"init",value:function(){var e=this;try{if(this.gl=this.canvas.getContext("webgl2")||this.canvas.getContext("webgl"),!this.gl)throw new Error("WebGL not supported");this.resizeCanvas(),window.addEventListener("resize",function(){return e.resizeCanvas()}),this.initShaders(),this.initBuffers(),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.clearColor(0,0,0,1),console.log("WebGL initialized successfully")}catch(e){console.error("WebGL initialization failed:",e);var t=this.canvas.getContext("2d");t&&(t.fillStyle="#333",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.font="16px Courier New",t.fillStyle="#f00",t.textAlign="center",t.fillText("WebGL not supported or initialization failed.",this.canvas.width/2,this.canvas.height/2))}}},{key:"resizeCanvas",value:function(){var e=this.canvas.parentElement;this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}},{key:"initShaders",value:function(){var e=this.loadShader(this.gl.VERTEX_SHADER,"\n      attribute vec4 aVertexPosition;\n      attribute vec2 aTextureCoord;\n      \n      uniform mat4 uModelViewMatrix;\n      uniform mat4 uProjectionMatrix;\n      \n      varying highp vec2 vTextureCoord;\n      \n      void main() {\n        gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;\n        vTextureCoord = aTextureCoord;\n      }\n    "),t=this.loadShader(this.gl.FRAGMENT_SHADER,"\n      varying highp vec2 vTextureCoord;\n      \n      uniform sampler2D uSampler;\n      \n      void main() {\n        gl_FragColor = texture2D(uSampler, vTextureCoord);\n      }\n    ");if(this.program=this.gl.createProgram(),this.gl.attachShader(this.program,e),this.gl.attachShader(this.program,t),this.gl.linkProgram(this.program),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw new Error("Unable to initialize the shader program: "+this.gl.getProgramInfoLog(this.program));this.programInfo={program:this.program,attribLocations:{vertexPosition:this.gl.getAttribLocation(this.program,"aVertexPosition"),textureCoord:this.gl.getAttribLocation(this.program,"aTextureCoord")},uniformLocations:{projectionMatrix:this.gl.getUniformLocation(this.program,"uProjectionMatrix"),modelViewMatrix:this.gl.getUniformLocation(this.program,"uModelViewMatrix"),uSampler:this.gl.getUniformLocation(this.program,"uSampler")}}}},{key:"loadShader",value:function(e,t){var n=this.gl.createShader(e);if(this.gl.shaderSource(n,t),this.gl.compileShader(n),!this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS)){var r=this.gl.getShaderInfoLog(n);throw this.gl.deleteShader(n),new Error("An error occurred compiling the shaders: "+r)}return n}},{key:"initBuffers",value:function(){this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0]),this.gl.STATIC_DRAW),this.textureCoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureCoordBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,1,1,1,1,0,0,0]),this.gl.STATIC_DRAW),this.indexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),this.gl.STATIC_DRAW)}},{key:"loadTexture",value:function(e){var t=this;return new Promise(function(r,i){var a=t.gl.createTexture();t.gl.bindTexture(t.gl.TEXTURE_2D,a),t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,1,1,0,t.gl.RGBA,t.gl.UNSIGNED_BYTE,new Uint8Array([128,128,128,255]));var o=new Image;o.onload=function(){t.gl.bindTexture(t.gl.TEXTURE_2D,a),t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,t.gl.RGBA,t.gl.UNSIGNED_BYTE,o),n(o.width)&&n(o.height)?t.gl.generateMipmap(t.gl.TEXTURE_2D):(t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.LINEAR)),r(a)},o.onerror=function(){i(new Error("Failed to load texture: ".concat(e)))},o.src=e});function n(e){return!(e&e-1)}}},{key:"loadScene",value:(a=c(o().m(function e(t){var n,r,i,a,s,l,c,u,h,m,d,g;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:e.p=0,r=0,i=["svg","jpg","png"];case 1:if(!(r<i.length)){e.n=6;break}return a=i[r],e.p=2,e.n=3,this.loadTexture("assets/images/".concat(t,".").concat(a));case 3:return n=e.v,e.a(3,6);case 4:e.p=4,e.v;case 5:r++,e.n=1;break;case 6:if(n){e.n=8;break}return s=["forest_path","forest_path_north","forest_path_south","forest_path_east","forest_path_west","crossroads"],l=["village_smithy","village_inn","village_elder_house","village_market"],c=["cave_entrance","cave_interior","creature_den_entrance","creature_den_interior"],u=["dungeon_entrance","dungeon_corridor","dungeon_chamber","underground_passage"],h=["castle_entrance","castle_courtyard","castle_hall","throne_room"],m=["hillside","mountain_path","rocky_outcrop","cliff_edge"],d="village_entrance"===t?"Village_Entrance.png":"village_square"===t?"Cottage.png":"village_outskirts"===t?"Wolf_Children.png":s.includes(t)||l.includes(t)?"Forest_Path.png":c.includes(t)?"Cave_Entrance.png":u.includes(t)?"Dungeon_Entrance.png":h.includes(t)?"Castle_Entrance.png":m.includes(t)?"Hillside.png":"Forest_Path.png",e.n=7,this.loadTexture("assets/images/".concat(d));case 7:n=e.v;case 8:return this.textures[t]=n,this.currentScene=t,e.a(2,!0);case 9:return e.p=9,g=e.v,console.error("Failed to load scene:",g),e.a(2,!1)}},e,this,[[2,4],[0,9]])})),function(e){return a.apply(this,arguments)})},{key:"render",value:function(e){var t=this;if(this.gl){if(console.log("[WebGL] Rendering scene: ".concat(e)),this.currentScene!==e){if(!this.textures[e])return console.log("[WebGL] Loading scene texture for: ".concat(e)),void this.loadScene(e).then(function(){return t.render(e)});this.currentScene=e}if(this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.textures[e]){var n=45*Math.PI/180,r=this.canvas.clientWidth/this.canvas.clientHeight,i=d.create();d.perspective(i,n,r,.1,100);var a=d.create();d.translate(a,a,[0,0,-4]),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.vertexAttribPointer(this.programInfo.attribLocations.vertexPosition,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.programInfo.attribLocations.vertexPosition),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureCoordBuffer),this.gl.vertexAttribPointer(this.programInfo.attribLocations.textureCoord,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.programInfo.attribLocations.textureCoord),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),this.gl.useProgram(this.programInfo.program),this.gl.uniformMatrix4fv(this.programInfo.uniformLocations.projectionMatrix,!1,i),this.gl.uniformMatrix4fv(this.programInfo.uniformLocations.modelViewMatrix,!1,a),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[e]),this.gl.uniform1i(this.programInfo.uniformLocations.uSampler,0),this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0)}}}},{key:"setScene",value:function(e){if(e)if("string"==typeof e)this.currentScene=e,this.dynamicImage=null,this.render(e);else if(this.currentSceneData=e,e.background){var t=e.id||e.background.replace(/\.[^/.]+$/,"");this.currentScene=t,this.dynamicImage=null,this.render(t)}else e.id&&(this.currentScene=e.id,this.dynamicImage=null,this.render(e.id));else console.warn("[WebGL] No scene data provided to setScene")}},{key:"setDynamicSceneImage",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.gl){"string"!=typeof e&&null!==e||(e={url:e});var r=e,a=r.url,o=r.priority,s=void 0===o?"normal":o,l=r.persistent,c=void 0!==l&&l,u=r.transition,h=void 0===u?"fade":u,m=n.delay,d=void 0===m?100:m,g=n.preload,f=void 0!==g&&g,p=n.usePreloader,y=void 0===p||p;if(a)if(this.shouldSkipDueToLowerPriority({priority:s}))console.log("[WebGL] Skipping dynamic image due to lower priority: ".concat(a));else{if(this.currentDynamicConfig={url:a,priority:s,persistent:c,transition:h},y&&window.imagePreloader&&window.imagePreloader.getCachedImage(a))return void this.applyDynamicImage(a,i(i({},e),{},{cached:!0}));f&&this.queueImageForPreload(a),setTimeout(function(){t.loadTexture(a).then(function(n){n&&t.currentScene&&t.currentDynamicConfig&&t.currentDynamicConfig.url===a&&t.applyDynamicImage(a,i(i({},e),{},{texture:n}))}).catch(function(e){console.error("[WebGL] Failed to load dynamic image: ".concat(a),e),t.currentDynamicConfig&&t.currentDynamicConfig.url===a&&t.clearDynamicImage()})},d)}else this.clearDynamicImage()}}},{key:"shouldSkipDueToLowerPriority",value:function(e){if(!this.dynamicImage)return!1;var t={low:1,normal:2,high:3,critical:4},n=t[this.dynamicImage.priority]||2;return(t[e.priority]||2)<n}},{key:"clearDynamicImage",value:function(){this.currentDynamicConfig=null,this.restoreOriginalScene()}},{key:"forceDynamicSceneImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.currentDynamicConfig=null,this.dynamicImage=null;var n=i("string"==typeof e?{url:e,priority:"critical"}:i({priority:"critical"},e),t);this.setDynamicSceneImage(n)}},{key:"applyDynamicImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.texture,r=t.priority,i=void 0===r?"normal":r,a=t.persistent,o=void 0!==a&&a,s=t.transition,l=void 0===s?"fade":s,c=t.cached,u=void 0!==c&&c;this.currentScene&&(this.textures[this.currentScene+"_original"]||(this.textures[this.currentScene+"_original"]=this.textures[this.currentScene]),this.dynamicImage={url:e,priority:i,persistent:o,transition:l,cached:u,timestamp:Date.now()},n&&(this.textures[this.currentScene]=n),"fade"!==l||u||this.applyFadeInEffect(),this.render(this.currentScene))}},{key:"applyFadeInEffect",value:function(){this.gl&&(this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA))}},{key:"restoreOriginalScene",value:function(){var e=this;this.currentScene&&this.textures[this.currentScene+"_original"]?(this.textures[this.currentScene]=this.textures[this.currentScene+"_original"],delete this.textures[this.currentScene+"_original"],this.render(this.currentScene)):this.currentScene&&(delete this.textures[this.currentScene],this.loadScene(this.currentScene).then(function(){e.render(e.currentScene)})),this.dynamicImage=null,this.currentDynamicConfig=null}},{key:"queueImageForPreload",value:function(e){this.textures[e.split("/").pop().split(".")[0]]||this.preloadImages([e])}},{key:"clearDynamicImageIf",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.dynamicImage){var t=e.maxAge,n=e.priority;e.persistent,this.dynamicImage.persistent&&!e.forceClear||(t&&Date.now()-this.dynamicImage.timestamp>t||n&&this.dynamicImage.priority===n)&&this.restoreOriginalScene()}}},{key:"setMemoryFlashImage",value:function(e){this.memoryFlashImage=e}},{key:"updateMemoryFlash",value:function(e,t){if(this.memoryFlashProgress=e,this.currentMemoryData=t,this.gl&&this.currentScene){var n=.3*Math.sin(e*Math.PI);this.applyFlashOverlay(n)}}},{key:"clearMemoryFlash",value:function(){this.memoryFlashProgress=0,this.currentMemoryData=null,this.memoryFlashImage=null}},{key:"applyFlashOverlay",value:function(e){if(this.gl&&!(e<=0)){var t=this.gl.isEnabled(this.gl.BLEND);this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(1,1,1,e),t||this.gl.disable(this.gl.BLEND)}}},{key:"setConditionalSceneImage",value:function(e,n,r){for(var i=0,a=Object.entries(r);i<a.length;i++){var o=t(a[i],2),s=o[0],l=o[1];if(this.evaluateCondition(s,n))return void this.setDynamicSceneImage(l)}this.setScene(e)}},{key:"evaluateCondition",value:function(e,t){if(e.startsWith("!flag:")){var n=e.substring(6);return!t.getFlag(n)}if(e.startsWith("flag:")){var r=e.substring(5);return t.getFlag(r)}if(e.startsWith("npc:")){var i=e.substring(4),a=t.getCurrentLocationData();return a&&a.npcs&&a.npcs.includes(i)}if(e.startsWith("!npc:")){var o=e.substring(5),s=t.getCurrentLocationData();return!s||!s.npcs||!s.npcs.includes(o)}if(e.startsWith("location:")){var l=e.substring(9);return t.currentLocation===l}return e.startsWith("time:"),!1}},{key:"setTimeBasedScene",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"day",r="".concat(e,"_").concat(n);this.loadScene(r).then(function(n){n?t.render(r):t.setScene(e)})}},{key:"preloadImages",value:(r=c(o().m(function e(t){var n,r,i=this;return o().w(function(e){for(;;)switch(e.n){case 0:return n=t.map(function(e){var t=e.split("/").pop().split(".")[0];return i.loadTexture(e).then(function(e){return e&&(i.textures[t]=e),e}).catch(function(t){return console.warn("Failed to preload image: ".concat(e),t),null})}),e.n=1,Promise.all(n);case 1:return r=e.v,e.a(2,r.filter(function(e){return null!==e}))}},e)})),function(e){return r.apply(this,arguments)})},{key:"setNPCBasedScene",value:function(e,n,r){for(var i=0,a=Object.entries(r);i<a.length;i++){var o=t(a[i],2),s=o[0],l=o[1],c=t(s.split(":"),2),u=c[0],h=c[1];if(n.includes(u)&&(!h||"present"===h))return void this.setDynamicSceneImage(l)}this.setScene(e)}}],n&&u(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n,r,a}(),d={create:function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},perspective:function(e,t,n,r,i){var a=1/Math.tan(t/2),o=1/(r-i);return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(i+r)*o,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*i*r*o,e[15]=0,e},translate:function(e,t,n){var r,i,a,o,s,l,c,u,h,m,d,g,f=n[0],p=n[1],y=n[2];return t===e?(e[12]=t[0]*f+t[4]*p+t[8]*y+t[12],e[13]=t[1]*f+t[5]*p+t[9]*y+t[13],e[14]=t[2]*f+t[6]*p+t[10]*y+t[14],e[15]=t[3]*f+t[7]*p+t[11]*y+t[15]):(r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],c=t[6],u=t[7],h=t[8],m=t[9],d=t[10],g=t[11],e[0]=r,e[1]=i,e[2]=a,e[3]=o,e[4]=s,e[5]=l,e[6]=c,e[7]=u,e[8]=h,e[9]=m,e[10]=d,e[11]=g,e[12]=r*f+s*p+h*y+t[12],e[13]=i*f+l*p+m*y+t[13],e[14]=a*f+c*p+d*y+t[14],e[15]=o*f+u*p+g*y+t[15]),e}};function g(e){return new m(e)}function f(e){return f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},f(e)}function p(e){return function(e){if(Array.isArray(e))return b(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||v(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a,o,s=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,i=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw i}}return s}}(e,t)||v(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(e,t){if(e){if("string"==typeof e)return b(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?b(e,t):void 0}}function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function w(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function a(n,r,i,a){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return k(c,"_invoke",function(n,r,i){var a,s,l,c=0,u=i||[],h=!1,m={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,n){return a=t,s=0,l=e,m.n=n,o}};function d(n,r){for(s=n,l=r,t=0;!h&&c&&!i&&t<u.length;t++){var i,a=u[t],d=m.p,g=a[2];n>3?(i=g===r)&&(l=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=d&&((i=n<2&&d<a[1])?(s=0,m.v=r,m.n=a[1]):d<g&&(i=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,s=0))}if(i||n>1)return o;throw h=!0,r}return function(i,u,g){if(c>1)throw TypeError("Generator is already running");for(h&&1===u&&d(u,g),s=u,l=g;(t=s<2?e:l)||!h;){a||(s?s<3?(s>1&&(m.n=-1),d(s,l)):m.n=l:m.v=l);try{if(c=2,a){if(s||(i="next"),t=a[i]){if(!(t=t.call(a,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=a.return)&&t.call(a),s<2&&(l=TypeError("The iterator does not provide a '"+i+"' method"),s=1);a=e}else if((t=(h=m.n<0)?l:n.call(r,m))!==o)break}catch(t){a=e,s=1,l=t}finally{c=1}}return{value:t,done:h}}}(n,i,a),!0),c}var o={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(k(t={},r,function(){return this}),t),h=c.prototype=s.prototype=Object.create(u);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,k(e,i,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=c,k(h,"constructor",c),k(c,"constructor",l),l.displayName="GeneratorFunction",k(c,i,"GeneratorFunction"),k(h),k(h,i,"Generator"),k(h,r,function(){return this}),k(h,"toString",function(){return"[object Generator]"}),(w=function(){return{w:a,m}})()}function k(e,t,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}k=function(e,t,n,r){function a(t,n){k(e,t,function(e){return this._invoke(t,n,e)})}t?i?i(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},k(e,t,n,r)}function S(e,t,n,r,i,a,o){try{var s=e[a](o),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,i)}function T(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var a=e.apply(t,n);function o(e){S(a,r,i,o,s,"next",e)}function s(e){S(a,r,i,o,s,"throw",e)}o(void 0)})}}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,I(r.key),r)}}function I(e){var t=function(e){if("object"!=f(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=f(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==f(t)?t:t+""}var C=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.validatedImages=new Map,this.missingImages=new Set,this.imageBasePath="src/assets/images/"},t=[{key:"validateImageExists",value:(i=T(w().m(function e(t){var n,r,i;return w().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!this.validatedImages.has(t)){e.n=1;break}return e.a(2,this.validatedImages.get(t));case 1:return e.p=1,n=new Image,e.n=2,new Promise(function(e){n.onload=function(){return e(!0)},n.onerror=function(){return e(!1)},n.src="assets/images/".concat(t)});case 2:return r=e.v,this.validatedImages.set(t,r),r||(this.missingImages.add(t),console.warn("Image not found: ".concat(t))),e.a(2,r);case 3:return e.p=3,i=e.v,console.error("Error validating image ".concat(t,":"),i),this.validatedImages.set(t,!1),this.missingImages.add(t),e.a(2,!1)}},e,this,[[1,3]])})),function(e){return i.apply(this,arguments)})},{key:"validateLocationImages",value:(r=T(w().m(function e(t,n){var r,i,a,o,s,l;return w().w(function(e){for(;;)switch(e.n){case 0:if(r={valid:!0,missingImages:[],warnings:[]},t){e.n=1;break}return r.warnings.push("Location '".concat(n,"' has no image configuration")),e.a(2,r);case 1:if(!t.default){e.n=3;break}if(!this.isImageFile(t.default)){e.n=3;break}return e.n=2,this.validateImageExists(t.default);case 2:e.v||(r.valid=!1,r.missingImages.push({type:"default",path:t.default,location:n}));case 3:if(!t.conditions){e.n=7;break}i=0,a=Object.entries(t.conditions);case 4:if(!(i<a.length)){e.n=7;break}if(o=y(a[i],2),s=o[0],l=o[1],!this.isImageFile(l)){e.n=6;break}return e.n=5,this.validateImageExists(l);case 5:e.v||(r.valid=!1,r.missingImages.push({type:"conditional",condition:s,path:l,location:n}));case 6:i++,e.n=4;break;case 7:return e.a(2,r)}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"validateAllLocationImages",value:(n=T(w().m(function e(t){var n,r,i,a,o,s,l,c;return w().w(function(e){for(;;)switch(e.n){case 0:n={totalLocations:0,locationsWithImages:0,locationsWithoutImages:[],validLocations:[],invalidLocations:[],allMissingImages:[],summary:""},r=0,i=Object.entries(t.locations);case 1:if(!(r<i.length)){e.n=5;break}if(a=y(i[r],2),o=a[0],s=a[1],n.totalLocations++,s.images){e.n=2;break}return n.locationsWithoutImages.push(o),e.a(3,4);case 2:return n.locationsWithImages++,e.n=3,this.validateLocationImages(s.images,o);case 3:(l=e.v).valid?n.validLocations.push(o):(n.invalidLocations.push({locationId:o,missingImages:l.missingImages}),(c=n.allMissingImages).push.apply(c,p(l.missingImages)));case 4:r++,e.n=1;break;case 5:return n.summary=this.generateValidationSummary(n),e.a(2,n)}},e,this)})),function(e){return n.apply(this,arguments)})},{key:"isImageFile",value:function(e){return/\.(png|jpg|jpeg|gif|svg|webp)$/i.test(e)}},{key:"generateValidationSummary",value:function(e){var t="Image Validation Report:\n";return t+="- Total locations: ".concat(e.totalLocations,"\n"),t+="- Locations with image config: ".concat(e.locationsWithImages,"\n"),t+="- Locations without image config: ".concat(e.locationsWithoutImages.length,"\n"),t+="- Valid image configurations: ".concat(e.validLocations.length,"\n"),t+="- Invalid image configurations: ".concat(e.invalidLocations.length,"\n"),t+="- Total missing images: ".concat(e.allMissingImages.length,"\n"),e.locationsWithoutImages.length>0&&(t+="\nLocations without image config:\n",e.locationsWithoutImages.forEach(function(e){t+="  - ".concat(e,"\n")})),e.allMissingImages.length>0&&(t+="\nMissing images:\n",e.allMissingImages.forEach(function(e){t+="  - ".concat(e.path," (").concat(e.type," for ").concat(e.location,")\n")})),t}},{key:"getSuggestions",value:function(e){var t=[],n=this.getAvailableImages();return e.forEach(function(e){var r={missing:e.path,location:e.location,suggestions:[]},i=e.path.replace(/\.[^/.]+$/,"").toLowerCase();n.forEach(function(e){var t=e.replace(/\.[^/.]+$/,"").toLowerCase();(t.includes(i)||i.includes(t))&&r.suggestions.push(e)}),t.push(r)}),t}},{key:"clearCache",value:function(){this.validatedImages.clear(),this.missingImages.clear()}},{key:"getMissingImages",value:function(){return new Set(this.missingImages)}}],t&&_(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,i}(),E=new C;function x(e){return x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},x(e)}function A(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function a(n,r,i,a){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return O(c,"_invoke",function(n,r,i){var a,s,l,c=0,u=i||[],h=!1,m={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,n){return a=t,s=0,l=e,m.n=n,o}};function d(n,r){for(s=n,l=r,t=0;!h&&c&&!i&&t<u.length;t++){var i,a=u[t],d=m.p,g=a[2];n>3?(i=g===r)&&(l=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=d&&((i=n<2&&d<a[1])?(s=0,m.v=r,m.n=a[1]):d<g&&(i=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,s=0))}if(i||n>1)return o;throw h=!0,r}return function(i,u,g){if(c>1)throw TypeError("Generator is already running");for(h&&1===u&&d(u,g),s=u,l=g;(t=s<2?e:l)||!h;){a||(s?s<3?(s>1&&(m.n=-1),d(s,l)):m.n=l:m.v=l);try{if(c=2,a){if(s||(i="next"),t=a[i]){if(!(t=t.call(a,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=a.return)&&t.call(a),s<2&&(l=TypeError("The iterator does not provide a '"+i+"' method"),s=1);a=e}else if((t=(h=m.n<0)?l:n.call(r,m))!==o)break}catch(t){a=e,s=1,l=t}finally{c=1}}return{value:t,done:h}}}(n,i,a),!0),c}var o={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(O(t={},r,function(){return this}),t),h=c.prototype=s.prototype=Object.create(u);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,O(e,i,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=c,O(h,"constructor",c),O(c,"constructor",l),l.displayName="GeneratorFunction",O(c,i,"GeneratorFunction"),O(h),O(h,i,"Generator"),O(h,r,function(){return this}),O(h,"toString",function(){return"[object Generator]"}),(A=function(){return{w:a,m}})()}function O(e,t,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}O=function(e,t,n,r){function a(t,n){O(e,t,function(e){return this._invoke(t,n,e)})}t?i?i(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},O(e,t,n,r)}function j(e,t,n,r,i,a,o){try{var s=e[a](o),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,i)}function L(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var a=e.apply(t,n);function o(e){j(a,r,i,o,s,"next",e)}function s(e){j(a,r,i,o,s,"throw",e)}o(void 0)})}}function P(e,t,n){return(t=G(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function M(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a,o,s=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,i=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw i}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return F(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?F(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function F(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function H(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,G(r.key),r)}}function W(e,t,n){return t&&H(e.prototype,t),n&&H(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function G(e){var t=function(e){if("object"!=x(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=x(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==x(t)?t:t+""}var Y=function(){return W(function e(){D(this,e),this.imageExtensions=[".png",".jpg",".jpeg",".svg",".gif",".webp"],this.standardConditions={DAY:"time:day",NIGHT:"time:night",DAWN:"time:dawn",DUSK:"time:dusk",SAVED_CHILDREN:"flag:savedChildren",DEFEATED_CAVE_CREATURE:"flag:defeatedCaveCreature",REMEMBERED_AMBUSH:"flag:rememberedAmbush",VISITED_VILLAGE:"flag:visitedVillage",HAS_WOLF:"npc:small_creature",HAS_ELDER:"npc:village_elder",HAS_BLACKSMITH:"npc:blacksmith"}},[{key:"createSimpleImageConfig",value:function(e){return{default:this.ensureImageExtension(e)}}},{key:"createConditionalImageConfig",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={default:this.ensureImageExtension(e)};if(Object.keys(t).length>0){n.conditions={};for(var r=0,i=Object.entries(t);r<i.length;r++){var a=M(i[r],2),o=a[0],s=a[1],l=this.standardizeCondition(o);n.conditions[l]=this.ensureImageExtension(s)}}return n}},{key:"createTimeBasedImageConfig",value:function(e,t){return this.createConditionalImageConfig(e,P({},this.standardConditions.NIGHT,t))}},{key:"createEventBasedImageConfig",value:function(e,t,n){var r="flag:".concat(t);return this.createConditionalImageConfig(e,P({},r,n))}},{key:"createNPCBasedImageConfig",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={},r=0,i=Object.entries(t);r<i.length;r++){var a=M(i[r],2),o=a[0],s=a[1];n["npc:".concat(o)]=s}return this.createConditionalImageConfig(e,n)}},{key:"ensureImageExtension",value:function(e){return e?this.imageExtensions.some(function(t){return e.toLowerCase().endsWith(t)})?e:"".concat(e,".png"):e}},{key:"standardizeCondition",value:function(e){if(e.includes(":"))return e;var t=e.toUpperCase();return this.standardConditions[t]?this.standardConditions[t]:"flag:".concat(e)}},{key:"generateImageSuggestions",value:function(e){var t=this.locationIdToImageName(e);return{default:"".concat(t,".png"),night:"".concat(t,"_night.png"),day:"".concat(t,"_day.png"),empty:"".concat(t,"_empty.png"),populated:"".concat(t,"_populated.png"),before:"".concat(t,"_before.png"),after:"".concat(t,"_after.png"),peaceful:"".concat(t,"_peaceful.png"),dangerous:"".concat(t,"_dangerous.png")}}},{key:"locationIdToImageName",value:function(e){return e.split("_").map(function(e){return e.charAt(0).toUpperCase()+e.slice(1)}).join("_")}},{key:"addImageConfigToLocation",value:(t=L(A().m(function e(t,n,r){var i;return A().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,E.validateLocationImages(n,r);case 1:return(i=e.v).valid?(t.images=n,console.log("✅ Added image configuration to location '".concat(r,"'"))):(console.warn("⚠️ Image configuration for '".concat(r,"' has missing images:"),i.missingImages),t.images=n),e.a(2,i)}},e)})),function(e,n,r){return t.apply(this,arguments)})},{key:"quickAddImage",value:(e=L(A().m(function e(t,n,r){var i,a,o;return A().w(function(e){for(;;)switch(e.n){case 0:if(i=t.locations[n]){e.n=1;break}return console.error("❌ Location '".concat(n,"' not found")),e.a(2,!1);case 1:return a=this.createSimpleImageConfig(r),e.n=2,this.addImageConfigToLocation(i,a,n);case 2:return o=e.v,e.a(2,o.valid)}},e,this)})),function(t,n,r){return e.apply(this,arguments)})},{key:"getAvailableImages",value:function(){return["Village_Entrance.png","Cottage.png","Forest_Path.png","Wolf_Children.png","crossroads.png","village_outskirts.png","cave_entrance.png","cave_interior.png","forest_clearing.png"]}},{key:"getDocumentation",value:function(){return"\n# Image Configuration Guide\n\n## Quick Setup (Most Common)\n```javascript\n// Add a simple image to a location\nimageHelpers.quickAddImage(gameData, 'my_location', 'My_Location.png');\n\n// Or manually create simple config\nlocation.images = imageHelpers.createSimpleImageConfig('My_Location.png');\n```\n\n## Conditional Images\n```javascript\n// Time-based (day/night)\nlocation.images = imageHelpers.createTimeBasedImageConfig(\n  'Village_Day.png',\n  'Village_Night.png'\n);\n\n// Event-based (before/after)\nlocation.images = imageHelpers.createEventBasedImageConfig(\n  'Cave_Entrance.png',\n  'defeatedCaveCreature',\n  'Cave_Entrance_Cleared.png'\n);\n\n// NPC-based\nlocation.images = imageHelpers.createNPCBasedImageConfig(\n  'Village_Empty.png',\n  { 'village_elder': 'Village_With_Elder.png' }\n);\n\n// Custom conditions\nlocation.images = imageHelpers.createConditionalImageConfig(\n  'Default.png',\n  {\n    'savedChildren': 'After_Rescue.png',\n    'NIGHT': 'Night_Version.png'\n  }\n);\n```\n\n## Image Naming Conventions\n- Use PascalCase with underscores: `Village_Entrance.png`\n- Add descriptive suffixes: `_night`, `_empty`, `_after`, `_peaceful`\n- Extensions are optional (defaults to .png)\n\n## Validation\n```javascript\n// Validate all location images\nconst report = await imageValidator.validateAllLocationImages(gameData);\nconsole.log(report.summary);\n```\n"}}]);var e,t}(),R=function(){return W(function e(){D(this,e),this.cache=new Map,this.loadingPromises=new Map,this.commonImages=["src/assets/images/Wolf_Children.png","src/assets/images/Wolf_Attacks.png","src/assets/images/Forest_Path.png","src/assets/images/Cottage.png","src/assets/images/Village_Entrance.png"]},[{key:"preload",value:function(e){var t=this;if(this.cache.has(e))return Promise.resolve(this.cache.get(e));if(this.loadingPromises.has(e))return this.loadingPromises.get(e);var n=new Promise(function(n,r){var i=new Image;i.onload=function(){t.cache.set(e,i),t.loadingPromises.delete(e),n(i)},i.onerror=function(){t.loadingPromises.delete(e),r(new Error("Failed to load image: ".concat(e)))},i.src=e});return this.loadingPromises.set(e,n),n}},{key:"preloadCommonImages",value:(t=L(A().m(function e(){var t,n=this;return A().w(function(e){for(;;)switch(e.n){case 0:return t=this.commonImages.map(function(e){return n.preload(e).catch(function(t){return console.warn("Failed to preload common image: ".concat(e),t),null})}),e.n=1,Promise.all(t);case 1:console.log("Preloaded ".concat(this.cache.size," common images"));case 2:return e.a(2)}},e,this)})),function(){return t.apply(this,arguments)})},{key:"preloadLocationImages",value:(e=L(A().m(function e(t,n){var r,i,a=this;return A().w(function(e){for(;;)switch(e.n){case 0:if(t.images){e.n=1;break}return e.a(2);case 1:return r=[],t.images.default&&r.push(t.images.default),Object.entries(t.images).forEach(function(e){var t=M(e,2),n=t[0],i=t[1];"default"!==n&&i&&r.push(i)}),i=r.map(function(e){return a.preload(e).catch(function(t){return console.warn("Failed to preload location image: ".concat(e),t.message||t),null})}),e.n=2,Promise.all(i);case 2:return e.a(2)}},e)})),function(t,n){return e.apply(this,arguments)})},{key:"getCached",value:function(e){return this.cache.get(e)||null}},{key:"isCached",value:function(e){return this.cache.has(e)}},{key:"clear",value:function(){this.cache.clear(),this.loadingPromises.clear()}},{key:"getStats",value:function(){return{cachedImages:this.cache.size,loadingImages:this.loadingPromises.size,totalMemoryUsage:Array.from(this.cache.values()).reduce(function(e,t){return e+t.width*t.height*4},0)}}}]);var e,t}(),q=new Y,N=new R;function B(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function z(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?B(Object(n),!0).forEach(function(t){V(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):B(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function V(e,t,n){return(t=re(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function U(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=X(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function $(e){return $="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$(e)}function K(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a,o,s=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,i=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw i}}return s}}(e,t)||X(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function X(e,t){if(e){if("string"==typeof e)return Q(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Q(e,t):void 0}}function Q(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function J(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function a(n,r,i,a){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return Z(c,"_invoke",function(n,r,i){var a,s,l,c=0,u=i||[],h=!1,m={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,n){return a=t,s=0,l=e,m.n=n,o}};function d(n,r){for(s=n,l=r,t=0;!h&&c&&!i&&t<u.length;t++){var i,a=u[t],d=m.p,g=a[2];n>3?(i=g===r)&&(l=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=d&&((i=n<2&&d<a[1])?(s=0,m.v=r,m.n=a[1]):d<g&&(i=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,s=0))}if(i||n>1)return o;throw h=!0,r}return function(i,u,g){if(c>1)throw TypeError("Generator is already running");for(h&&1===u&&d(u,g),s=u,l=g;(t=s<2?e:l)||!h;){a||(s?s<3?(s>1&&(m.n=-1),d(s,l)):m.n=l:m.v=l);try{if(c=2,a){if(s||(i="next"),t=a[i]){if(!(t=t.call(a,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=a.return)&&t.call(a),s<2&&(l=TypeError("The iterator does not provide a '"+i+"' method"),s=1);a=e}else if((t=(h=m.n<0)?l:n.call(r,m))!==o)break}catch(t){a=e,s=1,l=t}finally{c=1}}return{value:t,done:h}}}(n,i,a),!0),c}var o={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(Z(t={},r,function(){return this}),t),h=c.prototype=s.prototype=Object.create(u);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Z(e,i,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=c,Z(h,"constructor",c),Z(c,"constructor",l),l.displayName="GeneratorFunction",Z(c,i,"GeneratorFunction"),Z(h),Z(h,i,"Generator"),Z(h,r,function(){return this}),Z(h,"toString",function(){return"[object Generator]"}),(J=function(){return{w:a,m}})()}function Z(e,t,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}Z=function(e,t,n,r){function a(t,n){Z(e,t,function(e){return this._invoke(t,n,e)})}t?i?i(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},Z(e,t,n,r)}function ee(e,t,n,r,i,a,o){try{var s=e[a](o),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,i)}function te(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var a=e.apply(t,n);function o(e){ee(a,r,i,o,s,"next",e)}function s(e){ee(a,r,i,o,s,"throw",e)}o(void 0)})}}function ne(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,re(r.key),r)}}function re(e){var t=function(e){if("object"!=$(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=$(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==$(t)?t:t+""}var ie=function(){return e=function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.gameState=t,this.terminal=n,this.webglRenderer=r,this.locations={},this.items={},this.npcs={},this.combatSystem=null,this.memorySystem=null,this.preloadedImages=new Set,this.preloadQueue=[],this.ambientCreatures=this.initializeAmbientCreatures(),this.inConversation=!1,this.currentConversation=null,this.originalHandlers=null,this.initializeCommandHandlers()},t=[{key:"initializeAmbientCreatures",value:function(){return["A bird flies out of a nearby tree. It seems like it stares at you before it flies out of sight.","A small shadow figure darts across the path in front of you. You can't identify what it was but it leaves you with an uneasy feeling.","A rustling in the bushes catches your attention, but when you look, nothing is there.","A distant howl echoes through the area, sending a chill down your spine.","Something scurries through the underbrush nearby, too quick to see clearly.","A pair of glowing eyes watches you from the darkness before disappearing.","The sound of wings flapping overhead draws your gaze upward, but you see nothing.","A twig snaps somewhere behind you, but when you turn around, the area is empty.","A strange chittering sound comes from somewhere nearby, then falls silent.","You catch a glimpse of movement in your peripheral vision, but it vanishes when you look directly.","A low growl rumbles from somewhere in the distance, barely audible.","Something brushes against your leg briefly before darting away into the shadows.","The faint sound of padded footsteps follows you for a moment, then stops.","A small creature skitters across your path, disappearing into a crevice before you can identify it.","You hear the soft hoot of an owl, though you can't see it anywhere.","A gentle breeze carries an unfamiliar scent, wild and untamed.","The grass rustles as if something small is moving through it, just out of sight.","A shadow passes overhead, but when you look up, the sky appears empty.","You hear the distant splash of something entering water, though no water source is visible.","A soft whimpering sound drifts from somewhere nearby, then fades away."]}},{key:"initializeCommandHandlers",value:function(){var e=this;this.terminal.registerCommand("^(go|move|walk|run|travel) (to )?(north|south|east|west|n|s|e|w)",function(t){var n=t.match(/(north|south|east|west|n|s|e|w)/i)[0].toLowerCase();e.handleMovement(n)}),this.terminal.registerCommand("^(north|south|east|west|n|s|e|w)$",function(t){var n=t.trim().toLowerCase();e.handleMovement(n)}),this.terminal.registerCommand("^(look|examine|inspect|l)( around)?$",function(){e.describeCurrentLocation()}),this.terminal.registerCommand("^(look|examine|inspect|l) (at )?(.+)$",function(t){var n=t.match(/^(?:look|examine|inspect|l)(?: at)?\s+(.+)$/i)[1].toLowerCase();e.examineObject(n)}),this.terminal.registerCommand("^(take|get|grab|pick up) (.+)$",function(t){var n=t.match(/^(?:take|get|grab|pick up)\s+(.+)$/i)[1].toLowerCase();e.takeItem(n)}),this.terminal.registerCommand("^(drop|discard|throw away) (.+)$",function(t){var n=t.match(/^(?:drop|discard|throw away)\s+(.+)$/i)[1].toLowerCase();e.dropItem(n)}),this.terminal.registerCommand("^(use|activate|apply) (.+)$",function(t){var n=t.match(/^(?:use|activate|apply)\s+(.+)$/i)[1].toLowerCase();e.useItem(n)}),this.terminal.registerCommand("^(equip|wear|wield) (.+)$",function(t){var n=t.match(/^(?:equip|wear|wield)\s+(.+)$/i)[1].toLowerCase();e.equipItem(n)}),this.terminal.registerCommand("^(inventory|inv|i)$",function(){e.showInventory()}),this.terminal.registerCommand("^(talk|speak|chat) (to|with) (.+)$",function(t){var n=t.match(/^(?:talk|speak|chat) (?:to|with) (.+)$/i)[1].toLowerCase();e.talkToNPC(n)}),this.terminal.registerCommand("^(talk|speak|chat) (.+)$",function(t){var n=t.match(/^(?:talk|speak|chat) (.+)$/i)[1].toLowerCase();e.talkToNPC(n)}),this.terminal.registerCommand("^(attack|fight|hit) (.+)$",function(t){var n=t.match(/^(?:attack|fight|hit) (.+)$/i)[1].toLowerCase();e.attackTarget(n)}),this.terminal.registerCommand("^(help|\\?)$",function(){e.showHelp()}),this.terminal.registerCommand("^(status|stats|health|condition)$",function(){e.showStatus()}),this.terminal.registerCommand("^(save)$",function(){e.gameState.saveGame()?e.terminal.print("Game saved successfully.","system-message"):e.terminal.print("Failed to save game.","error-message")}),this.terminal.registerCommand("^(search|loot) (.+)$",function(t){var n=t.match(/^(?:search|loot)\s+(.+)$/i)[1].toLowerCase();e.searchTarget(n)})}},{key:"registerLocation",value:function(e,t){this.locations[e]=t}},{key:"registerItem",value:function(e,t){this.items[e]=t}},{key:"registerNPC",value:function(e,t){this.npcs[e]=t}},{key:"setCombatSystem",value:function(e){this.combatSystem=e}},{key:"setMemorySystem",value:function(e){this.memorySystem=e}},{key:"start",value:(r=te(J().m(function e(){return J().w(function(e){for(;;)switch(e.n){case 0:return this.showIntroduction(),e.n=1,N.preloadCommonImages();case 1:this.describeCurrentLocation();case 2:return e.a(2)}},e,this)})),function(){return r.apply(this,arguments)})},{key:"showIntroduction",value:function(){this.terminal.print("You awaken on a dirt road, your head throbbing. Your clothes are torn and stained with blood and dirt. You have no memory of who you are or how you got here.","story-text"),this.terminal.print("As you struggle to your feet, you find yourself at a crossroads. The world around you seems both familiar and strange.","story-text"),this.terminal.print("\nType 'help' for a list of commands.","system-message")}},{key:"setLocationImage",value:function(e,t){var n=e.images,r=n.default;if(n.conditions)for(var i=0,a=Object.entries(n.conditions);i<a.length;i++){var o=K(a[i],2),s=o[0],l=o[1];if(this.webglRenderer.evaluateCondition){if(this.webglRenderer.evaluateCondition(s,this.gameState)){r=l;break}}else if(this.evaluateImageCondition(s,t)){r=l;break}}r.includes(".png")||r.includes(".jpg")||r.includes(".svg")?(this.webglRenderer.setScene(e.scene),this.webglRenderer.setDynamicSceneImage(r)):(this.webglRenderer.setScene(r),this.webglRenderer.setDynamicSceneImage(null))}},{key:"evaluateImageCondition",value:function(e,t){if(e.startsWith("flag:")){var n=e.substring(5);return this.gameState.getFlag(n)}if(e.startsWith("!flag:")){var r=e.substring(6);return!this.gameState.getFlag(r)}if(e.startsWith("npc:")){var i=e.substring(4),a=this.gameState.getCurrentLocationData();return a&&a.npcs&&a.npcs.includes(i)}if(e.startsWith("!npc:")){var o=e.substring(5),s=this.gameState.getCurrentLocationData();return!s||!s.npcs||!s.npcs.includes(o)}return e.startsWith("time:"),!1}},{key:"describeCurrentLocation",value:function(){var e=this,t=this.gameState.currentLocation,n=this.locations[t];if(n){if(this.updateCorpseDecay(t),n.images?this.setLocationImage(n,t):(this.webglRenderer.setScene(n.scene),this.webglRenderer.setDynamicSceneImage(null)),this.terminal.print("\n".concat(n.name),"location-name"),this.terminal.print(n.description,"location-description"),n.exits&&Object.keys(n.exits).length>0){var r=Object.keys(n.exits).map(function(e){return e}).join(", ");this.terminal.print("Exits: ".concat(r),"exits-list")}else this.terminal.print("There are no obvious exits.","exits-list");if(n.items&&n.items.length>0){var i=n.items.filter(function(t){var n=e.items[t];return n&&(!n.hidden||e.gameState.flags[n.revealFlag])});if(i.length>0){var a=i.map(function(t){return e.items[t].name});this.terminal.print("You can see: ".concat(a.join(", "),"."),"items-list")}}if(n.npcs&&n.npcs.length>0){var o=n.npcs.filter(function(t){var n=e.npcs[t];return n&&(!n.hidden||e.gameState.flags[n.revealFlag])});o.length>0&&o.forEach(function(t){var n=e.npcs[t];e.terminal.print(n.presenceDescription,"npc-description")})}this.gameState.hasVisitedLocation(t)&&!n.alwaysTriggerEvent||n.onFirstVisit&&n.onFirstVisit(this.gameState,this.terminal)}else this.terminal.print("Error: Location '".concat(t,"' not found."),"error-message")}},{key:"handleMovement",value:(n=te(J().m(function e(t){var n,r,i,a,o,s,l,c;return J().w(function(e){for(;;)switch(e.n){case 0:if(n=this.gameState.currentLocation,r=this.locations[n]){e.n=1;break}return this.terminal.print("Error: Current location '".concat(n,"' not found."),"error-message"),e.a(2);case 1:if(i={n:"north",s:"south",e:"east",w:"west"}[t]||t,r.exits&&r.exits[i]){e.n=2;break}return this.terminal.print("You cannot go ".concat(i," from here."),"error-message"),e.a(2);case 2:if("object"!==$(a=r.exits[i])||!a.condition){e.n=6;break}if(console.log("Checking exit condition for direction:",i),s=a.condition(this.gameState,this),console.log("Exit condition result:",s),s){e.n=5;break}if(l=this.gameState.getFlag("triggerWolfDeathStory"),console.log("triggerWolfDeathStory flag:",l),!l){e.n=3;break}return console.log("*** TRIGGERING WOLF DEATH STORY ***"),this.triggerWolfDeathStory(),e.a(2);case 3:console.log("*** triggerWolfDeathStory flag is false, not triggering story ***");case 4:return console.log("Movement blocked, showing blocked message"),this.terminal.print(a.blockedMessage||"You cannot go ".concat(i," from here."),"error-message"),e.a(2);case 5:o=a.locationId,e.n=7;break;case 6:o=a;case 7:if(!(c=this.locations[o])){e.n=8;break}return e.n=8,N.preloadLocationImages(c,this.gameState);case 8:this.gameState.changeLocation(o),this.terminal.print("You go ".concat(i,"."),"action-result"),this.checkAmbientCreatureEncounter(o),this.describeCurrentLocation();case 9:return e.a(2)}},e,this)})),function(e){return n.apply(this,arguments)})},{key:"examineObject",value:function(e){var t=this.gameState.currentLocation,n=this.locations[t];if(n){if(n.features){var r,i=U(n.features);try{for(i.s();!(r=i.n()).done;){var a=r.value;if(a.keywords.some(function(t){return e.includes(t)})){if(this.terminal.print(a.description,"examine-result"),this.memorySystem&&this.memorySystem.checkTriggers("examine",e,{feature:a}),a.revealsItem){var o=a.revealsItem,s=this.items[o];s&&s.hidden&&(s.hidden=!1,this.terminal.print("You found ".concat(s.name,"!"),"item-found"),a.autoTake&&(this.gameState.addToInventory(z({id:o},s)),this.terminal.print("You take the ".concat(s.name,"."),"action-result")))}return}}}catch(e){i.e(e)}finally{i.f()}}if(n.items){var l,c=U(n.items);try{for(c.s();!(l=c.n()).done;){var u=l.value,h=this.items[u];if(h&&(!h.hidden||this.gameState.flags[h.revealFlag])&&h.keywords.some(function(t){return e.includes(t)}))return void this.terminal.print(h.description,"examine-result")}}catch(e){c.e(e)}finally{c.f()}}if(n.npcs){var m,d=U(n.npcs);try{for(d.s();!(m=d.n()).done;){var g=m.value,f=this.npcs[g];if(f&&(!f.hidden||this.gameState.flags[f.revealFlag])&&f.keywords.some(function(t){return e.includes(t)}))return void this.terminal.print(f.description,"examine-result")}}catch(e){d.e(e)}finally{d.f()}}var p,y=U(this.gameState.inventory);try{for(y.s();!(p=y.n()).done;){var v=p.value;if(v.keywords.some(function(t){return e.includes(t)}))return void this.terminal.print(v.description,"examine-result")}}catch(e){y.e(e)}finally{y.f()}this.terminal.print("You don't see anything special about the ".concat(e,"."),"error-message")}else this.terminal.print("Error: Location '".concat(t,"' not found."),"error-message")}},{key:"takeItem",value:function(e){var t=this.gameState.currentLocation,n=this.locations[t];if(n&&n.items){for(var r=0;r<n.items.length;r++){var i=n.items[r],a=this.items[i];if(a&&(!a.hidden||this.gameState.flags[a.revealFlag])&&a.keywords.some(function(t){return e.includes(t)}))return!1===a.takeable?void this.terminal.print(a.cantTakeMessage||"You can't take the ".concat(a.name,"."),"error-message"):(n.items.splice(r,1),this.gameState.addToInventory(z({id:i},a)),this.terminal.print("You take the ".concat(a.name,"."),"action-result"),this.memorySystem&&this.memorySystem.checkTriggers("take",i,{item:a}),void(a.onTake&&a.onTake(this.gameState,this.terminal)))}this.terminal.print("You don't see any ".concat(e," here."),"error-message")}else this.terminal.print("There's nothing here to take.","error-message")}},{key:"dropItem",value:function(e){for(var t=0;t<this.gameState.inventory.length;t++){var n=this.gameState.inventory[t];if(n.keywords.some(function(t){return e.includes(t)})){if(!1===n.droppable)return void this.terminal.print(n.cantDropMessage||"You can't drop the ".concat(n.name,"."),"error-message");this.gameState.removeFromInventory(n.id);var r=this.gameState.currentLocation,i=this.locations[r];return i.items||(i.items=[]),i.items.push(n.id),this.terminal.print("You drop the ".concat(n.name,"."),"action-result"),void(n.onDrop&&n.onDrop(this.gameState,this.terminal,r))}}this.terminal.print("You don't have any ".concat(e,"."),"error-message")}},{key:"useItem",value:function(e){var t,n=U(this.gameState.inventory);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.keywords.some(function(t){return e.includes(t)}))return!1===r.usable?void this.terminal.print(r.cantUseMessage||"You can't use the ".concat(r.name,"."),"error-message"):r.onUse?void r.onUse(this.gameState,this.terminal,this):void this.terminal.print("You're not sure how to use the ".concat(r.name,"."),"error-message")}}catch(e){n.e(e)}finally{n.f()}var i=this.gameState.currentLocation,a=this.locations[i];if(a&&a.items){var o,s=U(a.items);try{for(s.s();!(o=s.n()).done;){var l=o.value,c=this.items[l];if(c&&(!c.hidden||this.gameState.flags[c.revealFlag])&&c.keywords.some(function(t){return e.includes(t)}))return!1===c.usable?void this.terminal.print(c.cantUseMessage||"You can't use the ".concat(c.name,"."),"error-message"):c.onUse?void c.onUse(this.gameState,this.terminal,this):void this.terminal.print("You're not sure how to use the ".concat(c.name,"."),"error-message")}}catch(e){s.e(e)}finally{s.f()}}this.terminal.print("You don't see any ".concat(e," that you can use."),"error-message")}},{key:"equipItem",value:function(e){var t,n=U(this.gameState.inventory);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.keywords.some(function(t){return e.includes(t)}))return"weapon"!==r.type&&"armor"!==r.type?void this.terminal.print("You can't equip the ".concat(r.name,"."),"error-message"):("weapon"===r.type?(this.gameState.equipWeapon(r.id),this.terminal.print("You equip the ".concat(r.name,"."),"action-result")):"armor"===r.type&&(this.gameState.equipArmor(r.id),this.terminal.print("You equip the ".concat(r.name,"."),"action-result")),void(r.onEquip&&r.onEquip(this.gameState,this.terminal)))}}catch(e){n.e(e)}finally{n.f()}this.terminal.print("You don't have any ".concat(e," to equip."),"error-message")}},{key:"showInventory",value:function(){if(0!==this.gameState.inventory.length){this.terminal.print("You are carrying:","inventory-header");var e,t=U(this.gameState.inventory);try{for(t.s();!(e=t.n()).done;){var n=e.value,r="- ".concat(n.name);this.gameState.equippedWeapon&&this.gameState.equippedWeapon.id===n.id?r+=" (equipped as weapon)":this.gameState.equippedArmor&&this.gameState.equippedArmor.id===n.id&&(r+=" (equipped as armor)"),this.terminal.print(r,"inventory-item")}}catch(e){t.e(e)}finally{t.f()}}else this.terminal.print("You aren't carrying anything.","inventory-empty")}},{key:"talkToNPC",value:function(e){var t=this.gameState.currentLocation,n=this.locations[t];if(n&&n.npcs){var r,i=U(n.npcs);try{for(i.s();!(r=i.n()).done;){var a=r.value,o=this.npcs[a];if(o&&(!o.hidden||this.gameState.flags[o.revealFlag])&&o.keywords.some(function(t){return e.includes(t)}))return!1===o.talkable?void this.terminal.print(o.cantTalkMessage||"".concat(o.name," doesn't seem interested in talking."),"error-message"):o.conversation?void this.startConversation(o):o.onTalk?void o.onTalk(this.gameState,this.terminal,this):void this.terminal.print("".concat(o.name," has nothing to say."),"error-message")}}catch(e){i.e(e)}finally{i.f()}this.terminal.print("You don't see anyone called ".concat(e," here."),"error-message")}else this.terminal.print("There's no one here to talk to.","error-message")}},{key:"attackTarget",value:function(e){var t=this.gameState.currentLocation,n=this.locations[t];if(n&&n.npcs){var r,i=U(n.npcs);try{for(i.s();!(r=i.n()).done;){var a=r.value,o=this.npcs[a];if(o&&(!o.hidden||this.gameState.flags[o.revealFlag])&&o.keywords.some(function(t){return e.includes(t)}))return!1===o.attackable?void this.terminal.print(o.cantAttackMessage||"You can't attack ".concat(o.name,"."),"error-message"):this.combatSystem?void this.combatSystem.initiateCombat(o):o.onAttack?void o.onAttack(this.gameState,this.terminal,this):void this.terminal.print("You attack ".concat(o.name," but nothing happens."),"error-message")}}catch(e){i.e(e)}finally{i.f()}this.terminal.print("You don't see anyone called ".concat(e," here."),"error-message")}else this.terminal.print("There's no one here to attack.","error-message")}},{key:"searchTarget",value:function(e){var t=this.gameState.currentLocation,n=this.locations[t];if(n&&n.npcs){var r,i=U(n.npcs);try{for(i.s();!(r=i.n()).done;){var a=r.value,o=this.npcs[a];if(o&&(!o.hidden||this.gameState.flags[o.revealFlag])&&o.keywords.some(function(t){return e.includes(t)}))return o.isCorpse?o.loot&&0!==o.loot.length?void this.showLootMenu(o):void this.terminal.print("You have already looted everything from the ".concat(o.name,"."),"action-result"):void this.terminal.print("You can't search ".concat(o.name,"."),"error-message")}}catch(e){i.e(e)}finally{i.f()}this.terminal.print("You don't see any ".concat(e," here to search."),"error-message")}else this.terminal.print("There's nothing here to search.","error-message")}},{key:"triggerWolfDeathStory",value:function(){var e=this;this.gameState.setFlag("triggerWolfDeathStory",!1),this.webglRenderer.setDynamicSceneImage("assets/images/Wolf_Attacks.png"),this.terminal.print("\n","story-text"),this.terminal.print("As you turn your back on the terrified children and attempt to flee...","story-text"),setTimeout(function(){e.terminal.print("\nThe twisted wolf's eyes gleam with predatory hunger. It sees your cowardice.","story-text")},1500),setTimeout(function(){e.terminal.print("\nWith lightning speed, the beast lunges forward, its massive jaws clamping down on your leg.","story-text")},3e3),setTimeout(function(){e.terminal.print("\nYou scream in agony as razor-sharp teeth tear through flesh and bone.","story-text")},4500),setTimeout(function(){e.terminal.print("\nThe children's cries echo behind you as the wolf drags you into the darkness.","story-text")},6e3),setTimeout(function(){e.terminal.print("\nYour vision fades as the creature's claws rake across your chest...","story-text")},7500),setTimeout(function(){e.terminal.print("\nIn your final moments, you hear the wolf's satisfied growl and the children's screams growing distant.","story-text")},9e3),setTimeout(function(){e.terminal.print("\nYou have failed them. You have failed yourself.","story-text")},10500),setTimeout(function(){e.terminal.print("\n*** YOU HAVE DIED ***","error-message"),e.gameOverReturnToTitle()},12e3)}},{key:"startConversation",value:function(e){this.inConversation=!0,this.currentConversation=e,this.originalHandlers=z({},this.terminal.commandHandlers),this.terminal.commandHandlers={},this.processConversationNode(e.conversation.start)}},{key:"processConversationNode",value:function(e){var t=this,n=this.currentConversation.conversation.nodes[e];if(n){if(n.npcText){var r="function"==typeof n.npcText?n.npcText(this.gameState):n.npcText;this.terminal.print(r,"npc-dialog")}n.onEnter&&n.onEnter(this.gameState,this.terminal,this),n.choices&&n.choices.length>0?(this.terminal.print("\nYou can say:","conversation-prompt"),n.choices.forEach(function(e,n){e.condition&&!e.condition(t.gameState,t.terminal,t)||t.terminal.print("".concat(n+1,". ").concat(e.text),"conversation-choice")}),this.setupConversationChoiceHandlers(n)):this.endConversation()}else this.endConversation()}},{key:"setupConversationChoiceHandlers",value:function(e){var t=this;this.terminal.commandHandlers={},e.choices.forEach(function(e,n){e.condition&&!e.condition(t.gameState,t.terminal,t)||t.terminal.registerCommand("^".concat(n+1,"$"),function(){t.handleConversationChoice(e)})}),e.choices.forEach(function(e){if(e.keywords&&(!e.condition||e.condition(t.gameState,t.terminal,t))){var n=e.keywords.map(function(e){return e.toLowerCase()}).join("|");t.terminal.registerCommand("^.*(".concat(n,").*$"),function(){t.handleConversationChoice(e)})}}),this.terminal.registerCommand("^(exit|leave|goodbye|bye|quit|stop|end)$",function(){t.endConversation()}),this.terminal.registerCommand("^(help|?)$",function(){t.terminal.print("\nConversation Options:","conversation-prompt"),e.choices.forEach(function(e,n){e.condition&&!e.condition(t.gameState,t.terminal,t)||t.terminal.print("".concat(n+1,". ").concat(e.text),"conversation-choice")}),t.terminal.print("\nYou can also type 'exit', 'quit', or 'end' to leave the conversation.","conversation-prompt")})}},{key:"handleConversationChoice",value:function(e){e.playerText&&this.terminal.print('You say: "'.concat(e.playerText,'"'),"player-dialog"),e.onSelect&&e.onSelect(this.gameState,this.terminal,this),e.nextNode?this.processConversationNode(e.nextNode):this.endConversation()}},{key:"endConversation",value:function(){this.inConversation=!1,this.currentConversation=null,this.originalHandlers&&(this.terminal.commandHandlers=this.originalHandlers,this.originalHandlers=null),this.terminal.print("\n[Conversation ended]\n","system-message")}},{key:"gameOverReturnToTitle",value:function(){this.terminal.print("\nPress Enter to return to title screen...","game-over-message"),this.setupGameOverHandler()}},{key:"setupGameOverHandler",value:function(){var e=this;this.terminal.commandHandlers={},this.terminal.registerCommand("^$",function(){e.returnToTitleScreen()}),this.terminal.registerCommand(".*",function(){e.returnToTitleScreen()}),this.terminal.inputElement.focus()}},{key:"returnToTitleScreen",value:function(){this.terminal.enable(),this.terminal.clear(),this.terminal.commandHandlers={},this.gameState&&this.gameState.reset(),document.querySelectorAll(".screen").forEach(function(e){return e.classList.remove("active")});var e=document.getElementById("title-screen");e&&e.classList.add("active")}},{key:"showLootMenu",value:function(e){this.terminal.print("\nWhat do you want to loot from the ".concat(e.name,"?"),"loot-menu-header"),this.currentLootCorpse=e;for(var t=0;t<e.loot.length;t++){var n=e.loot[t],r=this.items[n.id];r&&this.terminal.print("".concat(t+1,". ").concat(r.name),"loot-option")}this.terminal.print("".concat(e.loot.length+1,". Take All"),"loot-option"),this.terminal.print("\nEnter the number of your choice:","loot-prompt"),this.setupLootSelectionHandlers()}},{key:"setupLootSelectionHandlers",value:function(){var e=this;this.originalHandlers=z({},this.terminal.commandHandlers),this.terminal.commandHandlers={},this.terminal.registerCommand("^([0-9]+)$",function(t){var n=parseInt(t.trim());e.handleLootSelection(n)}),this.terminal.registerCommand("^(cancel|exit|quit)$",function(){e.cancelLootSelection()})}},{key:"handleLootSelection",value:function(e){if(this.currentLootCorpse&&this.currentLootCorpse.loot){var t=this.currentLootCorpse,n=t.loot.length+1;e<1||e>n?this.terminal.print("Invalid choice. Please enter a number between 1 and ".concat(n,"."),"error-message"):(e===n?this.takeAllLoot(t):this.takeLootItem(t,e-1),t.loot.length>0&&this.terminal.print("\nThere are still items remaining. Search the corpse again to continue looting.","action-hint"),this.restoreOriginalHandlers())}else this.restoreOriginalHandlers()}},{key:"takeAllLoot",value:function(e){for(this.terminal.print("You take everything from the ".concat(e.name,":"),"action-result");e.loot.length>0;){var t=e.loot[0],n=this.items[t.id];n&&(this.gameState.addToInventory(z({id:t.id},n)),this.terminal.print("- ".concat(n.name),"item-found")),e.loot.shift()}}},{key:"takeLootItem",value:function(e,t){if(t>=0&&t<e.loot.length){var n=e.loot[t],r=this.items[n.id];r&&(this.gameState.addToInventory(z({id:n.id},r)),this.terminal.print("You take the ".concat(r.name,"."),"action-result"),e.loot.splice(t,1))}}},{key:"cancelLootSelection",value:function(){this.terminal.print("You decide not to loot anything right now.","action-result"),this.restoreOriginalHandlers()}},{key:"restoreOriginalHandlers",value:function(){this.originalHandlers&&(this.terminal.commandHandlers=this.originalHandlers,this.originalHandlers=null),this.currentLootCorpse=null}},{key:"updateCorpseDecay",value:function(e){var t=this.locations[e];if(t&&t.npcs){for(var n=this.gameState.getLocationVisitCount(e),r=[],i=t.npcs.length-1;i>=0;i--){var a=t.npcs[i],o=this.npcs[a];if(o&&o.isCorpse&&o.createdAtLocation===e){var s=n-o.createdAtVisitCount;s>=3?r.push({index:i,npcId:a,npc:o}):s>=2?this.updateCorpseToDecayState(o,"decayed"):s>=1&&this.updateCorpseToDecayState(o,"rotting")}}for(var l=0,c=r;l<c.length;l++){var u=c[l];t.npcs.splice(u.index,1),delete this.npcs[u.npcId]}}}},{key:"updateCorpseToDecayState",value:function(e,t){if(e.decayState!==t){e.decayState=t;var n=e.originalEnemy.toLowerCase();switch(t){case"rotting":e.name="Rotting ".concat(e.originalEnemy," Corpse"),e.description="The decomposing remains of the ".concat(n,". The smell is becoming quite unpleasant, and flies buzz around the body."),e.presenceDescription="The rotting corpse of the ".concat(n," lies here, emanating a foul odor.");break;case"decayed":e.name="Severely Decayed ".concat(e.originalEnemy," Remains"),e.description="What's left of the ".concat(n," is barely recognizable. The advanced state of decay makes it difficult to look at for long."),e.presenceDescription="The severely decayed remains of the ".concat(n," are scattered here, reeking terribly.")}e.onExamine=function(r,i,a){var o;switch(t){case"rotting":o="The ".concat(n," corpse is in an advanced state of decomposition. The smell is overwhelming.");break;case"decayed":o="The ".concat(n," remains are barely identifiable. Nature is quickly reclaiming what's left.");break;default:o="The ".concat(n," lies motionless. Its body shows the wounds from your battle.")}i.print(o,"examine-result"),e.loot&&e.loot.length>0?"decayed"===t?i.print("You might still find something in the remains, though it's quite unpleasant to search.","examine-result"):i.print("You might find something useful if you search the corpse.","examine-result"):i.print("The corpse appears to have nothing of value.","examine-result")}}}},{key:"showHelp",value:function(){this.terminal.print("Available commands:","help-header"),this.terminal.print("- look / examine [object]: Look around or examine something specific","help-item"),this.terminal.print("- go/move [direction]: Move in a direction (north, south, east, west)","help-item"),this.terminal.print("- take/get [item]: Pick up an item","help-item"),this.terminal.print("- drop [item]: Drop an item from your inventory","help-item"),this.terminal.print("- use [item]: Use an item","help-item"),this.terminal.print("- equip [item]: Equip a weapon or armor","help-item"),this.terminal.print("- inventory/inv: Check what you're carrying","help-item"),this.terminal.print("- talk to [person]: Talk to someone","help-item"),this.terminal.print("- attack [target]: Attack a creature or person","help-item"),this.terminal.print("- search/loot [target]: Search a corpse for items","help-item"),this.terminal.print("- status: Check your health and condition","help-item"),this.terminal.print("- save: Save your game progress","help-item")}},{key:"showStatus",value:function(){this.terminal.print("Name: ".concat(this.gameState.playerName),"status-item"),this.terminal.print("Health: ".concat(this.gameState.playerHealth,"/").concat(this.gameState.playerMaxHealth),"status-item"),this.gameState.equippedWeapon?this.terminal.print("Weapon: ".concat(this.gameState.equippedWeapon.name),"status-item"):this.terminal.print("Weapon: None","status-item"),this.gameState.equippedArmor?this.terminal.print("Armor: ".concat(this.gameState.equippedArmor.name),"status-item"):this.terminal.print("Armor: None","status-item"),this.terminal.print("Memory recovered: ".concat(this.gameState.memoryRecovered,"%"),"status-item")}},{key:"checkAmbientCreatureEncounter",value:function(e){if("crossroads"!==e&&Math.random()<.25){var t=Math.floor(Math.random()*this.ambientCreatures.length),n=this.ambientCreatures[t];this.terminal.print(n,"ambient-creature")}}},{key:"update",value:function(){}}],t&&ne(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r}();function ae(e){return ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ae(e)}function oe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function se(e,t,n){return(t=function(e){var t=function(e){if("object"!=ae(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=ae(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==ae(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var le={locations:{crossroads:{name:"Crossroads",scene:"crossroads",images:{default:"/assets/images/Forest_Path.png"},description:"You stand at a dusty crossroads. The dirt beneath your feet is stained with what appears to be dried blood—your blood. Your head throbs with pain, and your memory is a fog. Paths lead in four directions through the surrounding forest.",exits:{north:"forest_path_north",south:"forest_path_south",east:"forest_path_east",west:"forest_path_west"},features:[{keywords:["blood","stain","stains"],description:"Dark, dried blood stains the dirt. It seems to be yours, though you have no memory of how you were injured."},{keywords:["path","paths","road","roads"],description:"Dirt paths extend in all four directions, disappearing into the dense forest."},{keywords:["forest","trees","woods"],description:"A thick forest surrounds the crossroads, with tall trees blocking much of the sunlight."},{keywords:["ground","dirt","earth"],description:"The ground is disturbed, as if there was a struggle here. Scuff marks and overturned stones tell a story of violence.",onExamine:function(e,t){e.memoryFragments.includes("crossroads_battle")?t.print("The signs of your desperate battle are still visible in the disturbed earth.","description"):(e.memoryFragments.push("crossroads_battle"),t.print("As you examine the ground more closely, a memory flashes: You see yourself fighting multiple shadowy figures here, your sword flashing in the moonlight before something strikes you from behind.","memory-flash"),e.setFlag("rememberedAmbush",!0))}}],onFirstVisit:function(e,t){t.print("Your head pounds as you try to remember who you are and how you got here. Nothing comes to mind except a vague sense of urgency.","memory-flash")}},forest_path_west:{name:"Forest Path - West",scene:"forest_path",description:"The forest path winds westward. The trees grow closer together here, and the air feels cooler. You hear faint sounds of distress in the distance.",exits:{east:"crossroads",west:"village_outskirts"},features:[{keywords:["sounds","distress","noise","cries"],description:"The sounds seem to be coming from further west—perhaps children in trouble?"},{keywords:["trees","forest"],description:"The forest is dense here, with ancient trees towering overhead."},{keywords:["path"],description:"The dirt path continues west, leading deeper into the forest."}]},village_outskirts:{name:"Village Outskirts",scene:"village_outskirts",images:{default:"/assets/images/Village_Entrance.png",conditions:{"flag:savedChildren":"/assets/images/Forest_Path.png","npc:small_creature":"/assets/images/Wolf_Children.png"}},description:"The forest thins as the path approaches what appears to be a small village. Nearby, you hear children screaming in terror.",exits:{east:{locationId:"forest_path_west",condition:function(e,t){console.log("East exit condition - savedChildren:",e.getFlag("savedChildren"));var n=t.locations.village_outskirts;console.log("East exit condition - NPCs in village_outskirts:",n.npcs);var r=n.npcs.includes("small_creature");return console.log("East exit condition - hasWolf:",r),!e.getFlag("savedChildren")&&r?(console.log("East exit condition - Setting triggerWolfDeathStory to true"),e.setFlag("triggerWolfDeathStory",!0),!1):(console.log("East exit condition - Allowing movement"),!0)},blockedMessage:""},west:{locationId:"village_entrance",condition:function(e,t){console.log("West exit condition - savedChildren:",e.getFlag("savedChildren"));var n=t.locations.village_outskirts;console.log("West exit condition - NPCs in village_outskirts:",n.npcs);var r=n.npcs.includes("small_creature");return console.log("West exit condition - hasWolf:",r),!e.getFlag("savedChildren")&&r?(console.log("West exit condition - Setting triggerWolfDeathStory to true"),e.setFlag("triggerWolfDeathStory",!0),!1):(console.log("West exit condition - Allowing movement"),!0)},blockedMessage:""}},npcs:["child1","child2","small_creature"],items:["branch"],features:[{keywords:["village"],description:"A small village lies to the west, with simple wooden buildings visible through the trees."}],onFirstVisit:function(e,t){t.print("Two children are being attacked by a twisted, snarling creature! Without thinking, you look for something to use as a weapon.","story-event"),e.setFlag("metChildren",!0)}},village_entrance:{name:"Village Entrance",scene:"village_entrance",images:{default:"/assets/images/Village_Entrance.png"},description:"You stand at the entrance to a modest village. Simple wooden buildings line a central dirt road. Villagers move about, though they seem wary and on edge.",exits:{east:"village_outskirts",west:"village_square",north:"village_smithy",south:"village_inn"},features:[{keywords:["buildings","houses"],description:"The buildings are simple but sturdy, made of wood with thatched roofs."},{keywords:["villagers","people"],description:"The villagers glance at you with a mixture of hope and suspicion. They seem troubled by something."}],onFirstVisit:function(e,t){e.getFlag("savedChildren")?(t.print("As you enter the village, people turn to look at you. Word of your rescue of the children has already spread.","story-event"),t.print("An older man approaches you. 'You saved those children! Please, our village needs help with another creature that's been terrorizing us.'","npc-dialog"),e.setFlag("visitedVillage",!0)):(t.print("The villagers eye you warily as you enter. You hear whispers about children being attacked outside the village.","story-event"),e.setFlag("visitedVillage",!0))}},village_square:{name:"Village Square",scene:"village_square",images:{default:"/assets/images/Cottage.png"},description:"The central square of the village. A well sits in the middle, and villagers gather in small groups, speaking in hushed tones. A village elder stands near the well.",exits:{east:"village_entrance",north:"village_elder_house",south:"village_market"},npcs:["village_elder"],features:[{keywords:["well"],description:"A stone well stands in the center of the square, providing water for the village."},{keywords:["villagers","people","groups"],description:"The villagers speak quietly among themselves, occasionally glancing in your direction."}]},village_smithy:{name:"Village Smithy",scene:"village_smithy",description:"The village blacksmith's shop. The forge is hot, and the sound of hammering fills the air. Tools and weapons line the walls.",exits:{south:"village_entrance"},npcs:["blacksmith"],items:["rusty_sword"],features:[{keywords:["forge","furnace"],description:"The forge glows with hot coals, ready for metalworking."},{keywords:["tools","weapons"],description:"Various tools and simple weapons hang on the walls or rest on racks."}]},village_inn:{name:"Village Inn",scene:"village_inn",description:"A cozy inn with a few tables and a small bar. A fire crackles in the hearth, providing warmth and light.",exits:{north:"village_entrance"},npcs:["innkeeper"],features:[{keywords:["fire","hearth","fireplace"],description:"A warm fire burns in the stone hearth, casting flickering shadows around the room."},{keywords:["tables","chairs"],description:"Wooden tables and chairs are arranged around the room, most of them empty."},{keywords:["bar"],description:"A simple wooden bar stands along one wall, with a few bottles and mugs behind it."}]},village_elder_house:{name:"Village Elder's House",scene:"village_elder_house",description:"The home of the village elder. It's larger than most houses in the village, with bookshelves lining the walls and a large table in the center with a map spread across it.",exits:{south:"village_square"},items:["leather_armor"],features:[{keywords:["bookshelves","books"],description:"The bookshelves contain old tomes and scrolls, many of them appearing to be historical records."},{keywords:["table"],description:"A large wooden table dominates the center of the room, with a map of the surrounding area spread across it."},{keywords:["map"],description:"The map shows the village and surrounding forest. A location to the north is marked with a red X and labeled 'Creature's Den'. The map indicates you should go to the crossroads and head north to find the path to the creature's den.",revealsItem:"map_to_den",autoTake:!0},{keywords:["scroll","scrolls","parchment"],description:"Among the scrolls, one catches your eye. It bears a royal seal and mentions something about a 'Knight Commander'.",onExamine:function(e,t){e.memoryFragments.includes("royal_scroll")?t.print("The royal scroll still bears the seal of your former queen.","description"):(e.memoryFragments.push("royal_scroll"),t.print("As you read the scroll, a memory flashes: You see yourself kneeling before a throne, receiving a sword from a crowned woman. 'Protect the realm, Sir Knight,' she says.","memory-flash"),e.setFlag("rememberedKnighthood",!0))}}]},village_market:{name:"Village Market",scene:"village_market",description:"The village market area. Several stalls are set up, though many are empty or abandoned. A few villagers browse the remaining goods.",exits:{north:"village_square"},npcs:["merchant"],features:[{keywords:["stalls","stands"],description:"Most of the market stalls are empty or in disrepair. The few that remain open offer basic goods."},{keywords:["goods","wares","merchandise"],description:"The available goods are simple: some food, cloth, and basic tools. Nothing particularly valuable."}]},forest_path_north:{name:"Forest Path - North",scene:"forest_path",description:"The forest path continues northward. The trees are thinner here, allowing more sunlight to filter through.",exits:{south:"crossroads",north:{locationId:"creature_den_entrance",condition:function(e){return e.hasItem("map_to_den")},blockedMessage:"The path seems to continue north, but you're not sure where it leads. Perhaps someone in the village would know."}},features:[{keywords:["trees","forest"],description:"The forest is less dense here, with more space between the trees."},{keywords:["path"],description:"The dirt path winds northward through the forest."},{keywords:["sunlight","light"],description:"Sunlight filters through the canopy, creating dappled patterns on the ground."}]},creature_den_entrance:{name:"Creature's Den - Entrance",scene:"cave_entrance",images:{default:"/assets/images/placeholder.svg"},description:"A dark cave mouth opens in the side of a small hill. Strange scratches mark the rocks around the entrance, and an unnatural silence hangs in the air.",exits:{south:"forest_path_north",north:"creature_den_interior"},features:[{keywords:["cave","entrance","mouth"],description:"The cave entrance is roughly circular, about seven feet in diameter. Claw marks surround the opening."},{keywords:["scratches","marks","claw","claws"],description:"Deep gouges in the stone suggest a creature with formidable claws. Some marks are fresh."},{keywords:["hill"],description:"The hill is small but steep, covered in sparse vegetation. The cave appears to go deep inside."}]},creature_den_interior:{name:"Creature's Den - Interior",scene:"cave_interior",images:{default:"cave_interior",conditions:{"npc:cave_creature":"cave_interior_creature","flag:defeatedCaveCreature":"cave_interior_empty"}},description:"The inside of the cave is damp and dark. Bones litter the floor, and a foul smell permeates the air. At the back of the cave, a large creature stirs.",exits:{south:"creature_den_entrance"},npcs:["cave_creature"],items:[],features:[{keywords:["bones","remains"],description:"Animal bones are scattered across the floor, picked clean. Some appear to be from livestock, others from forest animals."},{keywords:["smell","odor","stench"],description:"A putrid smell fills the cave—a mixture of rotting meat and something else, something unnatural."}],onFirstVisit:function(e,t){t.print("As your eyes adjust to the darkness, you see a large, twisted creature at the back of the cave. It was once a bear, but now it's something else—its form warped by dark magic, with extra limbs and glowing red eyes.","story-event"),t.print("The creature growls as it notices you, rising to its feet and preparing to attack!","story-event")}},forest_path_east:{name:"Forest Path - East",scene:"forest_path",description:"The forest path extends eastward. The trees here are older and taller, with thick canopies that block much of the sunlight.",exits:{west:"crossroads",east:"forest_clearing"},features:[{keywords:["trees","forest"],description:"Ancient trees tower overhead, their massive trunks covered in moss and lichen."},{keywords:["path"],description:"The dirt path winds through the massive trees, occasionally obscured by roots and undergrowth."},{keywords:["canopy","leaves"],description:"The dense canopy high above allows only occasional shafts of sunlight to reach the forest floor."}]},forest_clearing:{name:"Forest Clearing",scene:"forest_clearing",description:"A circular clearing in the forest. Sunlight streams down, illuminating a small pond in the center. The water reflects the sky above, unnaturally still and clear.",exits:{west:"forest_path_east",east:"deep_forest"},features:[{keywords:["pond","water","pool"],description:"The pond's surface is mirror-like, reflecting the sky perfectly. As you look closer, you see not just the sky's reflection, but fleeting images—a castle, a crowned woman, a man in armor...",onExamine:function(e,t){e.memoryFragments||(e.memoryFragments=[]),e.memoryFragments.includes("pond_visions")?e.memoryFragments.length>=3?(t.print("The pond shows you more: A dark wizard casting a spell, your memories being torn away as you fall unconscious. You remember now—you were sent to stop him!","memory-flash"),e.memoryFragments.includes("wizard_betrayal")||(e.memoryFragments.push("wizard_betrayal"),e.setFlag("rememberedMission",!0))):t.print("The pond's surface ripples gently, but the visions remain unclear. Perhaps more memories would help focus what you see here.","description"):(e.memoryFragments.push("pond_visions"),t.print("The images in the water become clearer: You see yourself in shining armor, standing in a great hall. A beautiful queen speaks: 'Rise, Sir Knight. The kingdom needs your courage.'","memory-flash"),e.setFlag("rememberedKnight",!0),t.print("You remember now—you are a knight! But why were you on that road, and what happened to your armor and weapons?","memory-flash"))}},{keywords:["clearing"],description:"The clearing is a perfect circle, as if deliberately created rather than naturally formed."},{keywords:["sunlight","light"],description:"Sunlight fills the clearing, warm and bright compared to the shadowy forest around it."}]},deep_forest:{name:"Deep Forest",scene:"deep_forest",description:"The deepest part of the forest. The trees here are ancient and massive, their roots creating a maze on the forest floor. Strange glowing fungi grow on the trees, providing an eerie blue light.",exits:{west:"forest_clearing",east:{locationId:"wizard_tower_base",condition:function(e){return e.getFlag("rememberedWizard")},blockedMessage:"The forest seems to continue eastward, but something makes you hesitate. You feel you're not ready to go that way yet."}},features:[{keywords:["trees","forest"],description:"The trees here must be centuries old, with trunks wider than a man is tall. They seem to watch you with ancient awareness."},{keywords:["roots"],description:"Massive roots snake across the ground, creating natural steps and barriers."},{keywords:["fungi","mushrooms","glow"],description:"Bioluminescent fungi grow on the trees and roots, emitting a soft blue glow that illuminates the forest with otherworldly light.",onExamine:function(e,t){e.getFlag("rememberedWizard")||(t.print("As you touch one of the glowing mushrooms, another memory flashes in your mind: a tall man in flowing robes, his hands crackling with energy. 'Your queen cannot protect you now, knight,' he sneers. 'My magic will twist this land until it bows to me!'","memory-flash"),e.setFlag("rememberedWizard",!0),t.print("The wizard! He attacked you... he must have taken the queen! You must find his tower and stop him before his corruption spreads further.","memory-flash"))}}]},wizard_tower_base:{name:"Wizard's Tower - Base",scene:"wizard_tower_exterior",description:"A tall, twisted tower rises before you, its black stone seeming to absorb the light around it. The forest has been cleared in a perfect circle around the structure, and the ground is barren and cracked.",exits:{west:"deep_forest",enter:"wizard_tower_entrance"},features:[{keywords:["tower","structure"],description:"The tower spirals upward, its architecture defying natural laws. Windows glow with an unnatural purple light at irregular intervals along its height."},{keywords:["ground","earth","soil"],description:"The ground around the tower is dead and cracked, as if all life has been drained from it."},{keywords:["door","entrance"],description:"A heavy iron door stands at the base of the tower, covered in strange arcane symbols."},{keywords:["symbols","runes","markings"],description:"The arcane symbols pulse with a faint purple light. As you study them, they seem familiar...",onExamine:function(e,t){e.getFlag("rememberedMission")&&!e.memoryFragments.includes("tower_symbols")?(e.memoryFragments.push("tower_symbols"),t.print("The symbols trigger a memory: You remember studying these same runes in the royal library, preparing for your mission to stop the dark wizard Malachar!","memory-flash"),e.setFlag("rememberedWizardName",!0)):e.getFlag("rememberedMission")?t.print("The symbols of Malachar's dark magic. You know what lies beyond this door.","description"):t.print("The symbols seem familiar, but you can't quite place where you've seen them before.","description")}}],onFirstVisit:function(e,t){t.print("As you approach the tower, your final memories return in a rush: You led a group of knights to confront the wizard after he threatened the queen. There was a battle... your companions fell... and the wizard struck you down with a spell that sent you flying through the air.","memory-flash"),t.print("You remember crashing to the ground at the crossroads, your armor shattered, your mind wiped clean by the impact. But now you remember everything—and the queen is still in danger.","memory-flash"),e.setFlag("rememberedQueen",!0),e.setFlag("foundTower",!0)}},forest_path_south:{name:"Forest Path - South",scene:"forest_path",description:"The forest path leads southward. The trees thin out slightly here, and you can see rolling hills in the distance.",exits:{north:"crossroads",south:"hillside"},features:[{keywords:["trees","forest"],description:"The forest is less dense here, with more space between the trees."},{keywords:["path"],description:"The dirt path winds southward toward the hills."},{keywords:["hills","distance"],description:"Rolling hills can be seen to the south, their slopes covered in tall grass."}]},hillside:{name:"Hillside",scene:"hillside",description:"You stand on a grassy hillside overlooking a vast valley. In the far distance, you can see what appears to be a castle or large stone structure.",exits:{north:"forest_path_south"},features:[{keywords:["hills","hillside","grass"],description:"The hills are covered in tall grass that waves gently in the breeze."},{keywords:["valley"],description:"A wide valley stretches before you, with fields and small clusters of trees."},{keywords:["castle","structure","distance"],description:"In the far distance, you can make out what appears to be a castle or large stone structure. It's too far to reach from here, but seeing it triggers a sense of familiarity.",onExamine:function(e,t){e.getFlag("rememberedKnight")||t.print("As you gaze at the distant castle, you feel a strong sense of duty and belonging. Though you can't remember details, you know that place is important to you.","memory-flash")}}]}},items:{branch:{name:"Sturdy Branch",description:"A thick, sturdy branch that could serve as a makeshift weapon.",keywords:["branch","stick","weapon"],type:"weapon",damage:5,takeable:!0},rusty_sword:{name:"Rusty Sword",description:"An old sword with a rusty blade. Despite its condition, it's still sharp enough to be effective.",keywords:["sword","rusty","blade","weapon"],type:"weapon",damage:10,takeable:!0,hidden:!0,revealFlag:"visitedVillage"},leather_armor:{name:"Leather Armor",description:"A simple set of leather armor. It's worn but serviceable, offering basic protection.",keywords:["armor","leather","protection"],type:"armor",protection:3,speedPenalty:1,takeable:!0,hidden:!0,revealFlag:"visitedVillage"},map_to_den:{name:"Map to Creature's Den",description:"A rough map showing the location of a creature's den north of the village.",keywords:["map","parchment","paper"],type:"quest",takeable:!0,usable:!0,onUse:function(e,t){return t.print("You study the map. It shows a path leading north from the crossroads to a small cave in the hills. The cave is marked as 'Creature's Den'.","item-use"),!0}},steel_sword:{name:"Steel Sword",description:"A well-crafted steel sword with a sharp edge and good balance.",keywords:["sword","steel","blade","weapon"],type:"weapon",damage:15,takeable:!0},chainmail:{name:"Chainmail Armor",description:"A shirt of interlocking metal rings, providing good protection without sacrificing too much mobility.",keywords:["chainmail","armor","mail","chain"],type:"armor",protection:5,speedPenalty:2,takeable:!0},health_potion:{name:"Health Potion",description:"A small vial containing a red liquid that smells of herbs and magic.",keywords:["potion","health","vial","healing"],type:"consumable",takeable:!0,usable:!0,usableInCombat:!0,onUse:function(e,t){return e.heal(25),t.print("You drink the potion. A warm sensation spreads through your body as your wounds begin to close.","item-use"),t.print("Your health is now ".concat(e.playerHealth,"/").concat(e.playerMaxHealth,"."),"status-update"),e.removeFromInventory("health_potion"),!0},onCombatUse:function(e,t,n,r){return e.heal(25),t.print("You quickly drink the potion. A warm sensation spreads through your body as your wounds begin to close.","item-use"),t.print("Your health is now ".concat(e.playerHealth,"/").concat(e.playerMaxHealth,"."),"status-update"),e.removeFromInventory("health_potion"),!0}},knight_signet:{name:"Knight's Signet Ring",description:"A heavy gold ring bearing the royal coat of arms. It feels familiar in your hand.",keywords:["ring","signet","gold","royal"],type:"quest",takeable:!0,hidden:!0,revealFlag:"defeatedCaveCreature",onTake:function(e,t){e.memoryFragments.includes("knight_signet")||(e.memoryFragments.push("knight_signet"),t.print("As you slip the ring onto your finger, memories flood back: You remember your oath of service, your training in the royal guard, and your true name—Sir Aldric of Westmarch!","memory-flash"),e.setFlag("rememberedName",!0),e.playerName="Sir Aldric of Westmarch")}},memory_crystal:{name:"Memory Crystal",description:"A small, glowing crystal that pulses with inner light. It seems to resonate with your thoughts.",keywords:["crystal","memory","gem","stone"],type:"quest",takeable:!0,usable:!0,onUse:function(e,t){return e.memoryFragments.length>=5?(t.print("The crystal glows brightly as it absorbs your recovered memories. You feel your mind becoming clearer and more focused. Your maximum health increases!","memory-flash"),e.playerMaxHealth+=15,e.heal(15),!0):(t.print("The crystal glows faintly, but you need more memories to unlock its power.","description"),!1)}},wolf_pelt:{name:"Wolf Pelt",description:"A rough pelt from a twisted wolf. The fur is patchy and has an unnatural texture, but it might be useful for crafting.",keywords:["pelt","fur","hide","wolf"],type:"material",takeable:!0},twisted_claw:{name:"Twisted Claw",description:"A sharp claw from a corrupted creature. It's unnaturally hard and seems to shimmer with dark energy.",keywords:["claw","talon","twisted"],type:"material",takeable:!0},bear_hide:{name:"Bear Hide",description:"A thick hide from a massive bear. Despite the creature's corruption, the hide is still valuable and could be used for armor.",keywords:["hide","skin","bear"],type:"material",takeable:!0},bear_claws:{name:"Bear Claws",description:"Massive claws from a twisted bear. They're razor-sharp and could potentially be crafted into weapons.",keywords:["claws","talons","bear"],type:"material",takeable:!0}},npcs:{child1:{name:"Village Boy",description:"A young boy, no more than ten years old, with tousled hair and wide, frightened eyes.",presenceDescription:"A young boy cowers against a tree, trying to protect a smaller girl.",keywords:["boy","child","kid","children"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,n){e.getFlag("savedChildren")?t.print("'Thank you for saving us,' the boy says, still trembling. 'That thing came from the forest. There are more of them around the village lately.'","npc-dialog"):t.print("'Please help us!' the boy cries. 'That monster is going to eat us!'","npc-dialog")}},child2:{name:"Village Girl",description:"A small girl with braided hair, tears streaming down her face.",presenceDescription:"A little girl huddles close to the boy, sobbing quietly.",keywords:["girl","child","kid","children"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,n){e.getFlag("savedChildren")?(t.print("'Are you a knight?' the girl asks between sniffles. 'My papa says knights protect people from monsters.'","npc-dialog"),e.getFlag("rememberedKnight")||t.print("Something about her words resonates with you. Knight... The title feels right somehow.","memory-flash")):t.print("The girl is too frightened to speak, only sobbing and pointing at the creature.","npc-dialog")}},small_creature:{name:"Twisted Wolf",description:"What might once have been a wolf, now warped by dark magic. Its fur is patchy, revealing scaled skin underneath, and its eyes glow with an unnatural red light.",presenceDescription:"A twisted, wolf-like creature snarls and advances toward the children, its movements jerky and unnatural.",combatDescription:"The creature's jaws drip with saliva as it turns its attention to you, growling deeply.",keywords:["creature","monster","wolf","beast"],talkable:!1,attackable:!0,hidden:!1,health:20,maxHealth:20,damage:4,speed:6,onDefeat:function(e,t,n){t.print("The twisted wolf collapses, its unnatural red glow fading from its eyes. The children are safe!","combat-aftermath"),e.setFlag("savedChildren",!0);var r=n.locations.village_outskirts;r.description="The forest thins as the path approaches what appears to be a small village. The children you saved have run back to safety.";var i=r.npcs.indexOf("small_creature");-1!==i&&r.npcs.splice(i,1);var a=r.npcs.indexOf("child1");-1!==a&&r.npcs.splice(a,1);var o=r.npcs.indexOf("child2");-1!==o&&r.npcs.splice(o,1),t.print("'Thank you!' the boy cries, helping the girl to her feet. 'We need to get back to the village. You should come too—our elder will want to thank you.'","npc-dialog"),t.print("The children run toward the village to the west.","story-event")}},village_elder:{name:"Village Elder",description:"An elderly man with a long gray beard and kind eyes that have seen much hardship. He walks with the aid of a wooden staff.",presenceDescription:"An elderly man with a long gray beard stands near the well, watching you with interest.",keywords:["elder","old man","man","villager"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,n){e.getFlag("savedChildren")?(t.print("'You have our thanks for saving those children,' the elder says. 'These are dark times. Strange creatures have been appearing in the forest, twisted by some evil magic.'","npc-dialog"),t.print("'One larger beast has made its den north of here. It's been taking our livestock and threatening travelers. If you could deal with it, we would be most grateful. I've marked its location on a map in my house.'","npc-dialog"),e.getFlag("defeatedVillageMonster")&&t.print("'You've defeated the creature? Remarkable! You have the bearing of a warrior—perhaps even a knight. There are rumors that the royal knights were defeated by an evil wizard who has captured the queen. These twisted creatures began appearing after that.'","npc-dialog")):t.print("'Welcome, stranger,' the elder says. 'You seem lost. Our village has seen better days—we're plagued by strange creatures from the forest.'","npc-dialog")}},blacksmith:{name:"Village Blacksmith",description:"A muscular woman with soot-stained arms and a leather apron. Her hands are calloused from years of metalwork.",presenceDescription:"A strong-looking woman works at the forge, hammering a piece of metal.",keywords:["blacksmith","smith","woman"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,n){e.getFlag("savedChildren")?e.getFlag("blacksmithOfferedSword")?t.print("'I'm busy with my work,' the blacksmith says, wiping sweat from her brow. 'That sword's still there if you haven't taken it yet.'","npc-dialog"):(t.print("'Heard you saved those kids,' the blacksmith says, pausing her work. 'We need more people like you around here. Take that old sword if you want—it's not much, but it's better than nothing.'","npc-dialog"),n.items.rusty_sword.hidden=!1,e.setFlag("blacksmithOfferedSword",!0)):t.print("'Don't have time to chat,' the blacksmith says without looking up from her work. 'Unless you're buying something.'","npc-dialog")}},innkeeper:{name:"Innkeeper",description:"A portly man with a friendly face and a stained apron. He has the look of someone who enjoys sampling his own cooking.",presenceDescription:"A heavyset man stands behind the bar, wiping a mug with a cloth.",keywords:["innkeeper","barkeeper","bartender","man"],talkable:!0,attackable:!1,hidden:!1,conversation:{start:"greeting",nodes:{greeting:{npcText:"'Welcome to the Twisted Oak Inn,' the innkeeper says with a smile. 'Not many travelers these days, what with the strange creatures about. Can I get you something to drink?'",choices:[{text:"Yes, I'd like a drink",playerText:"Yes, I'd like a drink",keywords:["yes","drink","ale","beer"],nextNode:"offer_drink"},{text:"No, thank you",playerText:"No, thank you",keywords:["no","thanks"],nextNode:"no_drink"},{text:"Tell me about the creatures",playerText:"Tell me about these strange creatures",keywords:["creatures","monsters","beasts"],nextNode:"creature_info"},{text:"End conversation",playerText:"I should be going now",keywords:["end","leave","goodbye","bye"],nextNode:"end"}]},offer_drink:{npcText:function(e){return e.getFlag("defeatedVillageMonster")?"'You're the one who killed that beast in the cave? Drinks are on the house! We haven't had a proper hero around here since... well, since before the wizard took the queen.'":e.getFlag("savedChildren")?"'You're the one who saved those children from the twisted wolf! Drinks are on the house! Heroes like you deserve our gratitude.'":"'That'll be 5 gold pieces for a mug of our finest ale.'"},onEnter:function(e,t,n){(e.getFlag("defeatedVillageMonster")||e.getFlag("savedChildren"))&&(t.print("You enjoy a refreshing ale on the house. The warmth spreads through your body.","item-use"),e.heal(5),e.hasItem("health_potion")||(t.print("'Here, take this healing potion. A traveling merchant left it as payment. Might come in handy for someone like you.'","npc-dialog"),e.addToInventory(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?oe(Object(n),!0).forEach(function(t){se(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):oe(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({id:"health_potion"},n.items.health_potion)),t.print("You received: Health Potion","item-received")))},choices:[{text:"Thank you",playerText:"Thank you for the drink",keywords:["thanks","thank"],nextNode:"greeting"},{text:"Tell me about the creatures",playerText:"Tell me about these strange creatures",keywords:["creatures","monsters","beasts"],nextNode:"creature_info"},{text:"End conversation",playerText:"I should be going now",keywords:["end","leave","goodbye","bye"],nextNode:"end"}]},no_drink:{npcText:"'No problem at all. If you change your mind, I'll be here. These are dangerous times - stay safe out there.'",choices:[{text:"I will, thank you",playerText:"I will, thank you",keywords:["thanks","thank","will"],nextNode:"greeting"},{text:"Tell me about the creatures",playerText:"Tell me about these strange creatures",keywords:["creatures","monsters","beasts"],nextNode:"creature_info"},{text:"End conversation",playerText:"I should be going now",keywords:["end","leave","goodbye","bye"],nextNode:"end"}]},creature_info:{npcText:"'Aye, terrible things they are. Twisted beasts that were once normal animals, corrupted by dark magic. They started appearing after that wizard attacked the royal castle and took our queen.'",choices:[{text:"Tell me about the wizard",playerText:"Tell me more about this wizard",keywords:["wizard","magic","dark"],nextNode:"wizard_info"},{text:"Where do these creatures come from?",playerText:"Where do these creatures come from?",keywords:["where","come","from"],nextNode:"creature_origin"},{text:"Can I get a drink?",playerText:"Can I get a drink?",keywords:["drink","ale","beer"],nextNode:"offer_drink"},{text:"Go back",playerText:"Let me ask something else",keywords:["back","return","else"],nextNode:"greeting"},{text:"End conversation",playerText:"I should be going now",keywords:["end","leave","goodbye","bye"],nextNode:"end"}]},wizard_info:{npcText:"'They say he has a tower deep in the eastern forest. No one who's gone looking for it has returned. The creatures seem to be his doing - corrupting the natural order with his foul magic.'",choices:[{text:"Where do these creatures come from?",playerText:"Where do these creatures come from?",keywords:["where","come","from"],nextNode:"creature_origin"},{text:"Can I get a drink?",playerText:"Can I get a drink?",keywords:["drink","ale","beer"],nextNode:"offer_drink"},{text:"Go back",playerText:"Let me ask something else",keywords:["back","return","else"],nextNode:"creature_info"},{text:"End conversation",playerText:"I should be going now",keywords:["end","leave","goodbye","bye"],nextNode:"end"}]},creature_origin:{npcText:"'They come from the deep forest, but they weren't always monsters. That big bear that was terrorizing us? It used to be just a normal bear until the wizard's corruption reached it.'",choices:[{text:"Tell me about the wizard",playerText:"Tell me more about this wizard",keywords:["wizard","magic","dark"],nextNode:"wizard_info"},{text:"Can I get a drink?",playerText:"Can I get a drink?",keywords:["drink","ale","beer"],nextNode:"offer_drink"},{text:"Go back",playerText:"Let me ask something else",keywords:["back","return","else"],nextNode:"creature_info"},{text:"End conversation",playerText:"I should be going now",keywords:["end","leave","goodbye","bye"],nextNode:"end"}]},end:{npcText:"'Safe travels, friend. May the road be kind to you.'",choices:[]}}}},merchant:{name:"Traveling Merchant",description:"A thin woman with sharp eyes and colorful clothes. She has a small cart of goods beside her.",presenceDescription:"A merchant with a small cart watches you carefully, evaluating you as a potential customer.",keywords:["merchant","trader","seller","woman"],talkable:!0,attackable:!1,hidden:!1,onTalk:function(e,t,n){t.print("'Interested in trading?' the merchant asks. 'I don't have much these days—the roads are too dangerous with all these creatures about. I heard a wizard is responsible, twisting animals with dark magic.'","npc-dialog"),e.getFlag("rememberedWizard")&&(t.print("'A wizard, you say? Yes, I remember now. He attacked the royal castle and took the queen. I need to find his tower.'","player-dialog"),t.print("The merchant's eyes widen. 'The wizard's tower? They say it's deep in the eastern forest, but no one who's gone looking for it has returned. You'd have to be mad—or a hero—to go there.'","npc-dialog"))}},cave_creature:{name:"Twisted Bear",description:"A massive bear warped by dark magic. Its body is asymmetrical, with extra limbs growing from its torso, and its eyes glow with malevolent red light.",presenceDescription:"A huge, twisted bear-like creature growls at the back of the cave, its red eyes fixed on you.",combatDescription:"The monstrous bear rises to its full height, easily eight feet tall. Multiple limbs end in razor-sharp claws, and its jaws are filled with too many teeth.",keywords:["creature","monster","bear","beast"],talkable:!1,attackable:!0,hidden:!1,health:50,maxHealth:50,damage:8,speed:4,rewards:{healthIncrease:10,items:["chainmail","steel_sword","knight_signet"]},onDefeat:function(e,t,n){t.print("The twisted bear collapses with a final roar. As it dies, you notice its form seems to partially revert to that of a normal bear, though the corruption is too deep to fully disappear.","combat-aftermath"),e.setFlag("defeatedVillageMonster",!0),t.print("At the back of the cave, you find what appears to be the creature's hoard—items taken from its victims.","story-event");var r=n.locations.creature_den_interior,i=r.npcs.indexOf("cave_creature");-1!==i&&r.npcs.splice(i,1),r.description="The inside of the cave is damp and dark. Bones litter the floor, and a foul smell permeates the air. The twisted bear lies dead at the back of the cave."}}}};function ce(e){return ce="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ce(e)}function ue(e){return function(e){if(Array.isArray(e))return de(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||me(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function he(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=me(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function me(e,t){if(e){if("string"==typeof e)return de(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?de(e,t):void 0}}function de(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function ge(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function fe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ge(Object(n),!0).forEach(function(t){pe(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ge(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function pe(e,t,n){return(t=ve(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ye(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ve(r.key),r)}}function ve(e){var t=function(e){if("object"!=ce(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=ce(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==ce(t)?t:t+""}var be=function(){return e=function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.gameState=t,this.terminal=n,this.storyEngine=r,this.inCombat=!1,this.currentEnemy=null,this.playerTurn=!0},(t=[{key:"continueCombatInit",value:function(){this.setupCombatHandlers(),this.displayWeaponStatus(),this.terminal.print("".concat(this.currentEnemy.name,"'s Health: ").concat(this.currentEnemy.health,"/").concat(this.currentEnemy.maxHealth),"enemy-health"),this.terminal.print("Your Health: ".concat(this.gameState.playerHealth,"/").concat(this.gameState.playerMaxHealth),"combat-health"),this.showCombatActions()}},{key:"setupCombatHandlers",value:function(){var e=this;this.originalHandlers=fe({},this.terminal.commandHandlers),this.terminal.commandHandlers={},this.terminal.registerCommand("^(attack|fight|hit|strike)$",function(){e.inCombat&&e.playerTurn?e.playerAttack():e.inCombat?e.terminal.print("It's not your turn to attack.","error-message"):e.terminal.print("There's nothing to attack right now.","error-message")}),this.terminal.registerCommand("^(defend|block|parry)$",function(){e.inCombat&&e.playerTurn?e.playerDefend():e.inCombat?e.terminal.print("It's not your turn to defend.","error-message"):e.terminal.print("There's no need to defend right now.","error-message")}),this.terminal.registerCommand("^(use) (.+)$",function(t){if(e.inCombat&&e.playerTurn){var n=t.match(/^use\s+(.+)$/i)[1].toLowerCase();e.useItemInCombat(n)}else{if(!e.inCombat)return!1;e.terminal.print("It's not your turn to use an item.","error-message")}}),this.terminal.registerCommand("^(flee|escape|run)$",function(){e.inCombat&&e.playerTurn?e.attemptFlee():e.inCombat?e.terminal.print("It's not your turn to flee.","error-message"):e.terminal.print("There's nothing to flee from right now.","error-message")}),this.terminal.registerCommand("^(switch|change) weapon$",function(){e.inCombat&&e.playerTurn?e.showWeaponSwitchOptions():e.inCombat?e.terminal.print("It's not your turn to switch weapons.","error-message"):e.terminal.print("You can switch weapons outside of combat using 'equip [weapon name]'.","error-message")})}},{key:"displayWeaponStatus",value:function(){var e=this;this.terminal.print("\n--- WEAPON STATUS ---","combat-header"),this.gameState.equippedWeapon?this.terminal.print("Currently equipped: ".concat(this.gameState.equippedWeapon.name," (Damage: ").concat(this.gameState.equippedWeapon.damage,")"),"weapon-equipped"):this.terminal.print("Currently equipped: Bare hands (Damage: 5)","weapon-equipped");var t=this.getAvailableWeapons();t.length>0&&(this.terminal.print("\nWeapons in inventory:","weapon-list-header"),t.forEach(function(t,n){var r=e.gameState.equippedWeapon&&e.gameState.equippedWeapon.id===t.id?" (equipped)":"";e.terminal.print("- ".concat(t.name," (Damage: ").concat(t.damage,")").concat(r),"weapon-option")}),this.terminal.print("Type 'switch weapon' to change weapons during combat.","combat-hint"))}},{key:"showWeaponSwitchOptions",value:function(){var e=this,t=this.getAvailableWeapons();0!==t.length?(this.terminal.print("\nSelect a weapon to switch to:","combat-prompt"),t.forEach(function(t,n){var r=e.gameState.equippedWeapon&&e.gameState.equippedWeapon.id===t.id?" (currently equipped)":"";e.terminal.print("".concat(n+1,". ").concat(t.name," (Damage: ").concat(t.damage,")").concat(r),"weapon-option")}),this.terminal.print("\nType the number of the weapon to switch to it, or 'cancel' to return to combat:","combat-prompt"),this.setupWeaponSwitchHandlers(t)):this.terminal.print("You have no weapons in your inventory to switch to.","error-message")}},{key:"setupWeaponSwitchHandlers",value:function(e){var t=this;this.combatHandlers=fe({},this.terminal.commandHandlers),this.terminal.commandHandlers={};for(var n=function(){var n=r;t.terminal.registerCommand("^".concat(r+1,"$"),function(){var r=e[n];t.gameState.equippedWeapon&&t.gameState.equippedWeapon.id===r.id?t.terminal.print("You already have the ".concat(r.name," equipped."),"combat-info"):t.gameState.equipWeapon(r.id)?t.terminal.print("You switch to your ".concat(r.name,"."),"combat-equip"):t.terminal.print("Failed to equip the ".concat(r.name,"."),"error-message"),t.restoreCombatHandlers()})},r=0;r<e.length;r++)n();this.terminal.registerCommand("^(cancel|back|return)$",function(){t.terminal.print("You decide to keep your current weapon.","combat-choice"),t.restoreCombatHandlers()})}},{key:"restoreCombatHandlers",value:function(){this.terminal.commandHandlers=this.combatHandlers,this.combatHandlers=null}},{key:"promptBranchChoice",value:function(){this.terminal.print("\nYou're about to fight with your bare hands!","combat-warning"),this.terminal.print("You notice a branch nearby that could serve as a weapon.","combat-suggestion"),this.terminal.print("\nWhat would you like to do?","combat-prompt"),this.terminal.print("1. Take the branch and equip it","combat-option"),this.terminal.print("2. Fight with bare hands","combat-option"),this.terminal.print("\nType '1' or '2' to choose:","combat-prompt"),this.setupBranchChoiceHandlers()}},{key:"setupBranchChoiceHandlers",value:function(){var e=this;this.originalHandlers=fe({},this.terminal.commandHandlers),this.terminal.commandHandlers={},this.terminal.registerCommand("^1$",function(){e.restoreCommandHandlers(),e.takeBranchAndEquip()}),this.terminal.registerCommand("^2$",function(){e.restoreCommandHandlers(),e.terminal.print("You decide to fight with your bare hands. Brave, but dangerous!","combat-choice"),e.continueCombatInit()}),this.terminal.registerCommand(".*",function(){e.terminal.print("Please type '1' to take the branch or '2' to fight bare handed.","error-message")})}},{key:"takeBranchAndEquip",value:function(){var e=this.storyEngine.locations[this.gameState.currentLocation],t=this.storyEngine.items.branch,n=e.items.indexOf("branch");n>-1&&e.items.splice(n,1),this.gameState.addToInventory(fe({id:"branch"},t)),this.gameState.equipWeapon(fe({id:"branch"},t)),this.terminal.print("You quickly grab the ".concat(t.name.toLowerCase()," and ready it as a weapon!"),"action-result"),this.terminal.print("".concat(t.name," equipped!"),"equip-success"),this.continueCombatInit()}},{key:"getAvailableWeapons",value:function(){return this.gameState.inventory.filter(function(e){return"weapon"===e.type})}},{key:"promptWeaponEquip",value:function(e){var t=this;this.terminal.print("\nYou have no weapon equipped, but you have weapons in your inventory:","combat-warning"),e.forEach(function(e,n){t.terminal.print("".concat(n+1,". ").concat(e.name," (Damage: ").concat(e.damage,")"),"weapon-option")}),this.terminal.print("\nWould you like to equip a weapon before fighting?","combat-prompt"),this.terminal.print("Type the number of the weapon to equip it, or 'no' to fight unarmed:","combat-prompt"),this.setupWeaponSelectionHandlers(e)}},{key:"setupWeaponSelectionHandlers",value:function(e){var t=this;this.originalHandlers=fe({},this.terminal.commandHandlers),this.terminal.commandHandlers={};for(var n=function(){var n=r;t.terminal.registerCommand("^".concat(r+1,"$"),function(){var r=e[n];t.gameState.equipWeapon(r.id)&&(t.terminal.print("You equip the ".concat(r.name,"."),"combat-equip"),t.restoreCommandHandlers(),t.continueCombatInit())})},r=0;r<e.length;r++)n();this.terminal.registerCommand("^(no|n)$",function(){t.terminal.print("You decide to fight unarmed.","combat-choice"),t.restoreCommandHandlers(),t.continueCombatInit()})}},{key:"restoreCommandHandlers",value:function(){this.terminal.commandHandlers=this.originalHandlers,this.originalHandlers=null}},{key:"initiateCombat",value:function(e){if(this.inCombat=!0,this.currentEnemy=e,this.playerTurn=!0,"Twisted Wolf"===e.name&&this.storyEngine.webglRenderer.setDynamicSceneImage("assets/images/Wolf_Attacks.png"),this.terminal.print("\n--- COMBAT STARTED ---","combat-header"),this.terminal.print("You are fighting ".concat(e.name,"!"),"combat-start"),this.terminal.print(e.combatDescription||e.description,"combat-description"),!this.gameState.equippedWeapon){var t=this.getAvailableWeapons();if(t.length>0)return void this.promptWeaponEquip(t);var n=this.storyEngine.locations[this.gameState.currentLocation];if(n&&n.items&&n.items.includes("branch")){var r=this.storyEngine.items.branch;if(r&&(!r.hidden||this.gameState.flags[r.revealFlag]))return void this.promptBranchChoice()}}this.continueCombatInit()}},{key:"showCombatActions",value:function(){this.terminal.print("\nAvailable actions:","combat-actions-header"),this.terminal.print("- attack: Attack the enemy","combat-action"),this.terminal.print("- defend: Take a defensive stance to reduce damage","combat-action"),this.terminal.print("- use [item]: Use an item from your inventory","combat-action"),this.terminal.print("- flee: Attempt to escape from combat","combat-action"),this.terminal.print("- switch weapon: Change your equipped weapon","combat-action")}},{key:"playerAttack",value:function(){var e=this;if(!this.gameState.equippedWeapon){var t=this.storyEngine.locations[this.gameState.currentLocation];if(t&&t.items&&t.items.includes("branch")){var n=this.storyEngine.items.branch;!n||n.hidden&&!this.gameState.flags[n.revealFlag]||(this.terminal.print("You're fighting with your bare hands! You notice a ".concat(n.name.toLowerCase()," nearby that could serve as a weapon."),"combat-suggestion"),this.terminal.print("Try 'take branch' and then 'equip branch' to improve your combat effectiveness!","combat-suggestion"))}}var r=5,i=1;if(this.gameState.equippedWeapon&&(r=this.gameState.equippedWeapon.damage||10,this.gameState.equippedWeapon.effects)){var a,o=he(this.gameState.equippedWeapon.effects);try{for(o.s();!(a=o.n()).done;){var s=a.value;"damageMultiplier"===s.type&&(i*=s.value)}}catch(e){o.e(e)}finally{o.f()}}var l,c=.8+.4*Math.random(),u=Math.floor(r*i*c);if(this.currentEnemy.health-=u,this.gameState.equippedWeapon){var h=["You swing your ".concat(this.gameState.equippedWeapon.name," at ").concat(this.currentEnemy.name),"You strike ".concat(this.currentEnemy.name," with your ").concat(this.gameState.equippedWeapon.name),"You slash at ".concat(this.currentEnemy.name," with your ").concat(this.gameState.equippedWeapon.name),"You thrust your ".concat(this.gameState.equippedWeapon.name," toward ").concat(this.currentEnemy.name)];l=h[Math.floor(Math.random()*h.length)]}else{var m=["You punch ".concat(this.currentEnemy.name," with your fist"),"You strike ".concat(this.currentEnemy.name," with your bare hands"),"You throw a punch at ".concat(this.currentEnemy.name),"You lash out at ".concat(this.currentEnemy.name," with your fists")];l=m[Math.floor(Math.random()*m.length)]}this.terminal.print("".concat(l,", dealing ").concat(u," damage!"),"combat-damage"),this.currentEnemy.health<=0?this.enemyDefeated():(this.playerTurn=!1,this.terminal.print("".concat(this.currentEnemy.name,"'s Health: ").concat(this.currentEnemy.health,"/").concat(this.currentEnemy.maxHealth),"enemy-health"),setTimeout(function(){return e.enemyTurn()},1500))}},{key:"playerDefend",value:function(){var e=this;this.defending=!0,this.terminal.print("You take a defensive stance, preparing to block the next attack.","player-defend"),this.playerTurn=!1,setTimeout(function(){return e.enemyTurn()},1500)}},{key:"useItemInCombat",value:function(e){var t,n=this,r=he(this.gameState.inventory);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(i.keywords.some(function(t){return e.includes(t)})){if(!1===i.usableInCombat)return void this.terminal.print("You can't use the ".concat(i.name," during combat."),"error-message");if(i.onCombatUse){if(!1!==i.onCombatUse(this.gameState,this.terminal,this.currentEnemy,this)){if(this.playerTurn=!1,this.currentEnemy.health<=0)return void this.enemyDefeated();setTimeout(function(){return n.enemyTurn()},1500)}return}if(i.onUse){if(!1!==i.onUse(this.gameState,this.terminal,this.storyEngine)){if(this.playerTurn=!1,this.currentEnemy.health<=0)return void this.enemyDefeated();setTimeout(function(){return n.enemyTurn()},1500)}return}return void this.terminal.print("You're not sure how to use the ".concat(i.name," in combat."),"error-message")}}}catch(e){r.e(e)}finally{r.f()}this.terminal.print("You don't have any ".concat(e," to use."),"error-message")}},{key:"attemptFlee",value:function(){var e=this,t=this.currentEnemy.speed||5,n=5;this.gameState.equippedArmor&&(n-=this.gameState.equippedArmor.speedPenalty||0);var r=.5+.05*(n-t);Math.random()<r?(this.terminal.print("You successfully escape from combat!","combat-flee"),this.endCombat()):(this.terminal.print("You try to escape, but ".concat(this.currentEnemy.name," blocks your path!"),"combat-flee-fail"),this.playerTurn=!1,setTimeout(function(){return e.enemyTurn()},1500))}},{key:"enemyTurn",value:function(){var e=this.currentEnemy.damage||5,t=.8+.4*Math.random(),n=0;this.gameState.equippedArmor&&(n=this.gameState.equippedArmor.protection||0),this.defending&&(n+=5,this.terminal.print("Your defensive stance reduces the incoming damage!","combat-defend"),this.defending=!1);var r=Math.max(1,Math.floor(e*t-n));this.gameState.takeDamage(r);var i=["".concat(this.currentEnemy.name," lunges at you"),"".concat(this.currentEnemy.name," strikes you with its claws"),"".concat(this.currentEnemy.name," bites you viciously"),"".concat(this.currentEnemy.name," slashes at you"),"".concat(this.currentEnemy.name," attacks you ferociously")],a=i[Math.floor(Math.random()*i.length)];this.terminal.print("".concat(a,", dealing ").concat(r," damage!"),"combat-damage"),this.terminal.print("Your Health: ".concat(this.gameState.playerHealth,"/").concat(this.gameState.playerMaxHealth),"combat-health"),this.gameState.playerHealth<=0?this.playerDefeated():(this.playerTurn=!0,this.showCombatActions())}},{key:"enemyDefeated",value:function(){if(this.terminal.print("\nYou have defeated ".concat(this.currentEnemy.name,"!"),"combat-victory"),this.currentEnemy.rewards&&(this.currentEnemy.rewards.healthIncrease&&(this.gameState.playerMaxHealth+=this.currentEnemy.rewards.healthIncrease,this.gameState.playerHealth+=this.currentEnemy.rewards.healthIncrease,this.terminal.print("Your maximum health increases by ".concat(this.currentEnemy.rewards.healthIncrease,"!"),"reward")),this.currentEnemy.rewards.items)){var e,t=he(this.currentEnemy.rewards.items);try{for(t.s();!(e=t.n()).done;){var n=e.value,r=this.storyEngine.items[n];r&&(this.gameState.addToInventory(fe({id:n},r)),this.terminal.print("You found: ".concat(r.name),"reward"))}}catch(e){t.e(e)}finally{t.f()}}var i=!1;if(this.currentEnemy.onDefeat){var a=this.currentEnemy.onDefeat(this.gameState,this.terminal,this.storyEngine);a&&a.preventCorpse&&(i=!0)}i||this.createCorpse(),this.endCombat()}},{key:"createCorpse",value:function(){var e=this,t=this.storyEngine.locations[this.gameState.currentLocation];if(t){var n="".concat(this.currentEnemy.name.toLowerCase().replace(/\s+/g,"_"),"_corpse"),r=[],i=this.currentEnemy.name.toLowerCase();i.includes("wolf")?r=[{id:"wolf_pelt"},{id:"twisted_claw"}]:i.includes("bear")&&(r=[{id:"bear_hide"},{id:"bear_claws"}]);var a={name:"".concat(this.currentEnemy.name," Corpse"),description:"The lifeless body of the ".concat(this.currentEnemy.name.toLowerCase(),". You might be able to find something useful on it."),presenceDescription:"The corpse of the ".concat(this.currentEnemy.name.toLowerCase()," lies here."),keywords:["corpse","body","remains"].concat(ue(this.currentEnemy.keywords)),talkable:!1,attackable:!1,hidden:!1,isCorpse:!0,searched:!1,originalEnemy:this.currentEnemy.name,loot:r,createdAtLocation:this.gameState.currentLocation,createdAtVisitCount:this.gameState.getLocationVisitCount(this.gameState.currentLocation),decayState:"fresh",onExamine:function(t,n,r){n.print("The ".concat(e.currentEnemy.name.toLowerCase()," lies motionless. Its body shows the wounds from your battle."),"examine-result"),a.loot&&a.loot.length>0?n.print("You might find something useful if you search the corpse.","examine-result"):n.print("The corpse appears to have nothing of value.","examine-result")}};this.storyEngine.npcs[n]=a,t.npcs||(t.npcs=[]),t.npcs.push(n);var o=t.npcs.indexOf(this.currentEnemy.id||this.currentEnemy.name.toLowerCase().replace(/\s+/g,"_"));-1!==o&&t.npcs.splice(o,1)}}},{key:"playerDefeated",value:function(){this.terminal.print("\nYou have been defeated!","combat-defeat"),this.currentEnemy.onPlayerDefeat?this.currentEnemy.onPlayerDefeat(this.gameState,this.terminal,this.storyEngine):(this.terminal.print("\nGAME OVER","game-over"),this.terminal.print("\nPress Enter to return to title screen...","game-over-message"),this.setupGameOverHandler()),this.inCombat=!1,this.currentEnemy=null,this.playerTurn=!1,this.defending=!1}},{key:"setupGameOverHandler",value:function(){var e=this;this.terminal.commandHandlers={},this.terminal.registerCommand("^$",function(){e.returnToTitleScreen()}),this.terminal.registerCommand(".*",function(){e.returnToTitleScreen()}),this.terminal.inputElement.focus()}},{key:"returnToTitleScreen",value:function(){this.terminal.enable(),this.terminal.clear(),this.gameState&&this.gameState.reset(),document.querySelectorAll(".screen").forEach(function(e){return e.classList.remove("active")});var e=document.getElementById("title-screen");e&&e.classList.add("active")}},{key:"endCombat",value:function(){this.inCombat=!1,this.currentEnemy=null,this.playerTurn=!1,this.defending=!1,this.terminal.print("\n--- COMBAT ENDED ---","combat-header"),this.storyEngine.describeCurrentLocation(),this.restoreCommandHandlers()}}])&&ye(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function we(e){return we="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},we(e)}function ke(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a,o,s=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,i=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw i}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return Se(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Se(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Se(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function Te(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_e(r.key),r)}}function _e(e){var t=function(e){if("object"!=we(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=we(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==we(t)?t:t+""}var Ie=function(){return e=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.outputElement="string"==typeof t?document.getElementById(t):t,this.inputElement="string"==typeof n?document.getElementById(n):n,this.commandHistory=[],this.historyIndex=-1,this.commandHandlers={},this.outputElement&&this.inputElement?this.init():console.error("Terminal: Could not find required DOM elements")},t=[{key:"init",value:function(){var e=this;this.keydownHandler=function(t){"Enter"===t.key?(t.preventDefault(),e.processInput()):"ArrowUp"===t.key?(t.preventDefault(),e.navigateHistory(-1)):"ArrowDown"===t.key&&(t.preventDefault(),e.navigateHistory(1))},this.clickHandler=function(){e.inputElement.focus()},this.inputElement.addEventListener("keydown",this.keydownHandler),this.inputElement.focus();var t=document.getElementById("terminal-container");t&&t.addEventListener("click",this.clickHandler)}},{key:"processInput",value:function(){var e=this.inputElement.value.trim();""!==e&&(this.commandHistory.push(e),this.historyIndex=this.commandHistory.length,this.print(e,"player-input")),this.inputElement.value="",this.parseCommand(e)}},{key:"navigateHistory",value:function(e){var t=this;0!==this.commandHistory.length&&(this.historyIndex+=e,this.historyIndex<0&&(this.historyIndex=0),this.historyIndex>this.commandHistory.length&&(this.historyIndex=this.commandHistory.length),this.historyIndex===this.commandHistory.length?this.inputElement.value="":this.inputElement.value=this.commandHistory[this.historyIndex],setTimeout(function(){t.inputElement.selectionStart=t.inputElement.value.length,t.inputElement.selectionEnd=t.inputElement.value.length},0))}},{key:"parseCommand",value:function(e){for(var t=e.toLowerCase(),n=0,r=Object.entries(this.commandHandlers);n<r.length;n++){var i=ke(r[n],2),a=i[0],o=i[1];if(t.match(new RegExp(a,"i")))return void o(e)}this.print("I don't understand that command.","error-message")}},{key:"registerCommand",value:function(e,t){this.commandHandlers[e]=t}},{key:"print",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=document.createElement("div");n.className="message ".concat(t),n.textContent=e,this.outputElement.appendChild(n),this.outputElement.scrollTop=this.outputElement.scrollHeight}},{key:"getHistory",value:function(){return this.outputElement.innerHTML}},{key:"setHistory",value:function(e){"string"==typeof e?this.outputElement.innerHTML=e:Array.isArray(e)&&(this.outputElement.innerHTML=e.join("")),this.outputElement.scrollTop=this.outputElement.scrollHeight}},{key:"clear",value:function(){this.outputElement.innerHTML=""}},{key:"disable",value:function(){this.inputElement.disabled=!0}},{key:"enable",value:function(){this.inputElement.disabled=!1,this.inputElement.focus()}},{key:"printHTML",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=document.createElement("div");n.className="message ".concat(t),n.innerHTML=e,this.outputElement.appendChild(n),this.outputElement.scrollTop=this.outputElement.scrollHeight}},{key:"cleanup",value:function(){this.inputElement&&this.inputElement.removeEventListener("keydown",this.keydownHandler);var e=document.getElementById("terminal-container");e&&this.clickHandler&&e.removeEventListener("click",this.clickHandler),this.commandHandlers={},this.commandHistory=[],this.historyIndex=-1}}],t&&Te(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Ce(e){return Ce="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ce(e)}function Ee(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function xe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Oe(r.key),r)}}function Ae(e,t,n){return t&&xe(e.prototype,t),n&&xe(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function Oe(e){var t=function(e){if("object"!=Ce(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=Ce(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Ce(t)?t:t+""}var je=function(){return Ae(function e(t,n,r,i){Ee(this,e),this.gameState=t,this.terminal=n,this.webglRenderer=r,this.audioManager=i,this.memories={},this.memoryTriggers={},this.activeMemoryFlash=!1,this.memoryFlashStartTime=0,this.memoryFlashDuration=2e3},[{key:"registerMemory",value:function(e,t){this.memories[e]={id:e,title:t.title||"Forgotten Memory",text:t.text||"A fragment of memory returns to you...",flashImage:t.flashImage||null,recovered:!1,importance:t.importance||"minor",relatedObjectives:t.relatedObjectives||[],onRecovered:t.onRecovered||null}}},{key:"registerMemoryTrigger",value:function(e,t){this.memoryTriggers[e]={id:e,type:t.type,target:t.target,condition:t.condition||null,memoryId:t.memoryId,triggered:!1,oneTime:void 0===t.oneTime||t.oneTime}}},{key:"checkTriggers",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=[];return Object.values(this.memoryTriggers).forEach(function(a){if(!(a.triggered&&a.oneTime||a.type!==e||a.target!==t&&"*"!==a.target)){var o=!0;if(a.condition&&"function"==typeof a.condition&&(o=a.condition(n.gameState,r)),o){a.triggered=!0;var s=n.memories[a.memoryId];s&&!s.recovered&&(n.recoverMemory(a.memoryId),i.push(s))}}}),i}},{key:"recoverMemory",value:function(e){var t=this,n=this.memories[e];return!(!n||n.recovered||(n.recovered=!0,this.gameState.memoryRecovered+=1,this.gameState.knownInformation.push({type:"memory",title:n.title,text:n.text,importance:n.importance}),this.triggerMemoryFlash(n),n.onRecovered&&"function"==typeof n.onRecovered&&n.onRecovered(this.gameState,this.terminal),n.relatedObjectives&&n.relatedObjectives.length>0&&n.relatedObjectives.forEach(function(e){t.gameState.completeObjective(e)}),0))}},{key:"triggerMemoryFlash",value:function(e){this.audioManager&&this.audioManager.playSound("memory_flash"),this.activeMemoryFlash=!0,this.memoryFlashStartTime=Date.now(),this.currentMemoryFlash=e,this.terminal.printHTML('<div class="memory-flash">\n      <h3>'.concat(e.title,"</h3>\n      <p>").concat(e.text,"</p>\n    </div>")),e.flashImage&&this.webglRenderer&&this.webglRenderer.setMemoryFlashImage(e.flashImage)}},{key:"update",value:function(){if(this.activeMemoryFlash){var e=Date.now()-this.memoryFlashStartTime,t=Math.min(1,e/this.memoryFlashDuration);return this.webglRenderer&&this.webglRenderer.updateMemoryFlash(t,this.currentMemoryFlash),t>=1&&(this.activeMemoryFlash=!1,this.currentMemoryFlash=null,this.webglRenderer&&this.webglRenderer.clearMemoryFlash()),!0}return!1}},{key:"getRecoveredMemories",value:function(){return Object.values(this.memories).filter(function(e){return e.recovered})}},{key:"getAllMemories",value:function(){return this.memories}},{key:"getMemoryRecoveryProgress",value:function(){var e=Object.keys(this.memories).length;return 0===e?0:Object.values(this.memories).filter(function(e){return e.recovered}).length/e*100}},{key:"isMemoryRecovered",value:function(e){return this.memories[e]&&this.memories[e].recovered}}])}(),Le=Ae(function e(t){Ee(this,e),this.id=t.id,this.title=t.title||"Forgotten Memory",this.text=t.text||"A fragment of memory returns to you...",this.flashImage=t.flashImage||null,this.importance=t.importance||"minor",this.relatedObjectives=t.relatedObjectives||[],this.onRecovered=t.onRecovered||null}),Pe=Ae(function e(t){Ee(this,e),this.id=t.id,this.type=t.type,this.target=t.target,this.condition=t.condition||null,this.memoryId=t.memoryId,this.oneTime=void 0===t.oneTime||t.oneTime}),Me={memories:{pond_visions:new Le({id:"pond_visions",title:"Visions in the Water",text:"You see flashes of yourself in gleaming armor, standing before a great castle. A woman in a crown speaks to you with urgency in her voice.",importance:"major",flashImage:"memory_castle.jpg"}),rememberedKnight:new Le({id:"rememberedKnight",title:"The Knight's Oath",text:"You remember taking an oath of service, kneeling before the throne. You were a knight of the realm, sworn to protect the innocent.",importance:"critical",flashImage:"memory_oath.jpg"}),wizard_betrayal:new Le({id:"wizard_betrayal",title:"The Wizard's Betrayal",text:'A trusted advisor... no, a wizard you once called friend. His face twists with malice as he raises his staff against you. "You know too much," he hisses.',importance:"critical",flashImage:"memory_betrayal.jpg"}),royal_scroll:new Le({id:"royal_scroll",title:"Royal Decree",text:"The scroll bears the royal seal. You remember delivering urgent messages between the castle and distant outposts. You were a trusted messenger of the crown.",importance:"major",flashImage:"memory_scroll.jpg"}),tower_symbols:new Le({id:"tower_symbols",title:"The Wizard's Name",text:"The symbols spell out a name: Malachar the Deceiver. Your former mentor, the court wizard who betrayed the realm and erased your memories.",importance:"critical",flashImage:"memory_symbols.jpg"}),crossroads_battle:new Le({id:"crossroads_battle",title:"The Ambush",text:"You remember now - you were ambushed here while carrying vital intelligence about Malachar's treachery. Dark creatures overwhelmed you, but not before you hid the evidence.",importance:"critical",flashImage:"memory_ambush.jpg"}),knight_identity:new Le({id:"knight_identity",title:"Your True Name",text:"Sir Aldric of Westmarch - that is who you are. A knight-errant in service to the crown, tasked with uncovering corruption in the highest ranks of the kingdom.",importance:"critical",flashImage:"memory_identity.jpg"})},triggers:{pond_examine:new Pe({id:"pond_examine",type:"examine",target:"pond",memoryId:"pond_visions",oneTime:!0}),pond_examine_advanced:new Pe({id:"pond_examine_advanced",type:"examine",target:"pond",memoryId:"wizard_betrayal",condition:function(e){return e.flags.pond_visions&&e.memoryFragments.length>=3},oneTime:!0}),scroll_examine:new Pe({id:"scroll_examine",type:"examine",target:"scroll",memoryId:"royal_scroll",oneTime:!0}),symbols_examine:new Pe({id:"symbols_examine",type:"examine",target:"symbols",memoryId:"tower_symbols",condition:function(e){return e.flags.rememberedMission},oneTime:!0}),ground_examine:new Pe({id:"ground_examine",type:"examine",target:"ground",memoryId:"crossroads_battle",oneTime:!0}),signet_take:new Pe({id:"signet_take",type:"take",target:"knight_signet",memoryId:"knight_identity",oneTime:!0})}};function Fe(e){Object.values(Me.memories).forEach(function(t){e.registerMemory(t.id,t)}),Object.values(Me.triggers).forEach(function(t){e.registerMemoryTrigger(t.id,t)})}function De(e){return De="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},De(e)}function He(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,We(r.key),r)}}function We(e){var t=function(e){if("object"!=De(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=De(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==De(t)?t:t+""}var Ge=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.reset()},t=[{key:"reset",value:function(){this.playerName="",this.playerHealth=100,this.playerMaxHealth=100,this.currentLocation="crossroads",this.visitedLocations=new Set(["crossroads"]),this.locationVisitCounts={crossroads:1},this.completedObjectives=new Set,this.knownInformation=new Set,this.memoryRecovered=0,this.inventory=[],this.equippedWeapon=null,this.equippedArmor=null,this.flags={metChildren:!1,savedChildren:!1,visitedVillage:!1,defeatedVillageMonster:!1,rememberedKnight:!1,rememberedWizard:!1,rememberedQueen:!1,foundTower:!1,triggerWolfDeathStory:!1,blacksmithOfferedSword:!1}}},{key:"newGame",value:function(e){this.reset(),this.playerName=e,this.saveGame()}},{key:"saveGame",value:function(){var e={playerName:this.playerName,playerHealth:this.playerHealth,playerMaxHealth:this.playerMaxHealth,currentLocation:this.currentLocation,visitedLocations:Array.from(this.visitedLocations),locationVisitCounts:this.locationVisitCounts,completedObjectives:Array.from(this.completedObjectives),knownInformation:Array.from(this.knownInformation),memoryRecovered:this.memoryRecovered,inventory:this.inventory,equippedWeapon:this.equippedWeapon,equippedArmor:this.equippedArmor,flags:this.flags};return localStorage.setItem("forgottenSteel_saveGame",JSON.stringify(e)),!0}},{key:"loadFromSave",value:function(e){return this.playerName=e.playerName||"",this.playerHealth=e.playerHealth||100,this.playerMaxHealth=e.playerMaxHealth||100,this.currentLocation=e.currentLocation||"crossroads",this.visitedLocations=new Set(e.visitedLocations||["crossroads"]),this.locationVisitCounts=e.locationVisitCounts||{crossroads:1},this.completedObjectives=new Set(e.completedObjectives||[]),this.knownInformation=new Set(e.knownInformation||[]),this.memoryRecovered=e.memoryRecovered||0,this.inventory=e.inventory||[],this.equippedWeapon=e.equippedWeapon||null,this.equippedArmor=e.equippedArmor||null,this.flags=e.flags||{metChildren:!1,savedChildren:!1,visitedVillage:!1,defeatedVillageMonster:!1,rememberedKnight:!1,rememberedWizard:!1,rememberedQueen:!1,foundTower:!1,triggerWolfDeathStory:!1,blacksmithOfferedSword:!1},this.flags.hasOwnProperty("blacksmithOfferedSword")||(this.flags.blacksmithOfferedSword=!1),this.flags.triggerWolfDeathStory=!1,!0}},{key:"changeLocation",value:function(e){return this.currentLocation=e,this.visitedLocations.add(e),this.locationVisitCounts[e]||(this.locationVisitCounts[e]=0),this.locationVisitCounts[e]++,this.saveGame(),!0}},{key:"getLocationVisitCount",value:function(e){return this.locationVisitCounts[e]||0}},{key:"addToInventory",value:function(e){return this.inventory.push(e),this.saveGame(),!0}},{key:"removeFromInventory",value:function(e){var t=this.inventory.findIndex(function(t){return t.id===e});if(-1!==t){var n=this.inventory[t];return this.inventory.splice(t,1),this.saveGame(),n}return null}},{key:"equipWeapon",value:function(e){var t=this.inventory.find(function(t){return t.id===e&&"weapon"===t.type});return!!t&&(this.equippedWeapon=t,this.saveGame(),!0)}},{key:"equipArmor",value:function(e){var t=this.inventory.find(function(t){return t.id===e&&"armor"===t.type});return!!t&&(this.equippedArmor=t,this.saveGame(),!0)}},{key:"completeObjective",value:function(e){return this.completedObjectives.add(e),this.updateMemoryRecovered(),this.saveGame(),!0}},{key:"updateMemoryRecovered",value:function(){var e=0;this.flags.rememberedKnight&&(e+=25),this.flags.rememberedWizard&&(e+=25),this.flags.rememberedQueen&&(e+=25),e+=5*this.completedObjectives.size,this.memoryRecovered=Math.min(100,e)}},{key:"setFlag",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e in this.flags&&(this.flags[e]=t,e.startsWith("remembered")&&this.updateMemoryRecovered(),this.saveGame(),!0)}},{key:"getFlag",value:function(e){return this.flags[e]||!1}},{key:"takeDamage",value:function(e){return this.playerHealth=Math.max(0,this.playerHealth-e),this.saveGame(),this.playerHealth>0}},{key:"heal",value:function(e){return this.playerHealth=Math.min(this.playerMaxHealth,this.playerHealth+e),this.saveGame(),!0}},{key:"isObjectiveCompleted",value:function(e){return this.completedObjectives.has(e)}},{key:"hasVisitedLocation",value:function(e){return this.visitedLocations.has(e)}},{key:"hasItem",value:function(e){return this.inventory.some(function(t){return t.id===e})}},{key:"getCurrentLocationData",value:function(){return le.locations[this.currentLocation]}}],t&&He(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Ye(e){return Ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ye(e)}function Re(e){return function(e){if(Array.isArray(e))return qe(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return qe(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?qe(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function qe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function Ne(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Be(r.key),r)}}function Be(e){var t=function(e){if("object"!=Ye(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=Ye(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Ye(t)?t:t+""}var ze=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.sounds={},this.music={},this.currentMusic=null,this.musicVolume=.5,this.soundVolume=.7,this.muted=!1,this.initialized=!1,this.audioContext=null,this.masterGain=null,this.musicGain=null,this.soundGain=null},t=[{key:"init",value:function(){if(!this.initialized)try{var e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e,this.masterGain=this.audioContext.createGain(),this.musicGain=this.audioContext.createGain(),this.soundGain=this.audioContext.createGain(),this.musicGain.connect(this.masterGain),this.soundGain.connect(this.masterGain),this.masterGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.musicVolume,this.soundGain.gain.value=this.soundVolume,this.masterGain.gain.value=this.muted?0:1,this.initialized=!0,console.log("Audio system initialized")}catch(e){console.error("Failed to initialize audio system:",e)}}},{key:"loadSound",value:function(e,t){var n=this;return fetch(t).then(function(e){return e.arrayBuffer()}).then(function(e){return n.initialized||n.init(),n.audioContext.decodeAudioData(e)}).then(function(t){return n.sounds[e]=t,t}).catch(function(t){console.error("Error loading sound ".concat(e,":"),t)})}},{key:"loadMusic",value:function(e,t){var n=this;return fetch(t).then(function(e){return e.arrayBuffer()}).then(function(e){return n.initialized||n.init(),n.audioContext.decodeAudioData(e)}).then(function(t){return n.music[e]=t,t}).catch(function(t){console.error("Error loading music ".concat(e,":"),t)})}},{key:"playSound",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.initialized||this.init(),!this.sounds[e])return console.warn("Sound ".concat(e," not loaded")),null;var n=this.audioContext.createBufferSource();n.buffer=this.sounds[e];var r=this.audioContext.createGain();r.gain.value=void 0!==t.volume?t.volume:1,n.connect(r),r.connect(this.soundGain),n.loop=t.loop||!1,t.playbackRate&&(n.playbackRate.value=t.playbackRate);var i=t.delay?this.audioContext.currentTime+t.delay:this.audioContext.currentTime;return n.start(i),n}},{key:"playMusic",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.initialized||this.init(),this.music[e]){this.stopMusic();var n=this.audioContext.createBufferSource();n.buffer=this.music[e],n.loop=void 0===t.loop||t.loop;var r=this.audioContext.createGain();if(r.gain.value=t.fadeIn?0:1,n.connect(r),r.connect(this.musicGain),n.start(),t.fadeIn){var i=t.fadeTime||2;r.gain.setValueAtTime(0,this.audioContext.currentTime),r.gain.linearRampToValueAtTime(1,this.audioContext.currentTime+i)}this.currentMusic={source:n,gainNode:r,id:e}}else console.warn("Music ".concat(e," not loaded"))}},{key:"stopMusic",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.currentMusic)if(t.fadeOut){var n=t.fadeTime||2;this.currentMusic.gainNode.gain.setValueAtTime(this.currentMusic.gainNode.gain.value,this.audioContext.currentTime),this.currentMusic.gainNode.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+n),setTimeout(function(){e.currentMusic&&e.currentMusic.source&&(e.currentMusic.source.stop(),e.currentMusic=null)},1e3*n)}else this.currentMusic.source.stop(),this.currentMusic=null}},{key:"setMasterVolume",value:function(e){this.initialized||this.init(),this.masterGain.gain.value=this.muted?0:Math.max(0,Math.min(1,e))}},{key:"setMusicVolume",value:function(e){this.initialized||this.init(),this.musicVolume=Math.max(0,Math.min(1,e)),this.musicGain.gain.value=this.musicVolume}},{key:"setSoundVolume",value:function(e){this.initialized||this.init(),this.soundVolume=Math.max(0,Math.min(1,e)),this.soundGain.gain.value=this.soundVolume}},{key:"setMuted",value:function(e){this.initialized||this.init(),this.muted=e,this.masterGain.gain.value=this.muted?0:1}},{key:"toggleMute",value:function(){return this.setMuted(!this.muted),this.muted}},{key:"preloadCommonSounds",value:function(){var e=this,t=[{id:"click",url:"assets/audio/click.mp3"},{id:"typing",url:"assets/audio/typing.mp3"},{id:"error",url:"assets/audio/error.mp3"},{id:"success",url:"assets/audio/success.mp3"},{id:"combat_start",url:"assets/audio/combat_start.mp3"},{id:"sword_swing",url:"assets/audio/sword_swing.mp3"},{id:"hit",url:"assets/audio/hit.mp3"},{id:"miss",url:"assets/audio/miss.mp3"},{id:"victory",url:"assets/audio/victory.mp3"},{id:"defeat",url:"assets/audio/defeat.mp3"},{id:"item_pickup",url:"assets/audio/item_pickup.mp3"},{id:"memory_flash",url:"assets/audio/memory_flash.mp3"}].map(function(t){return e.loadSound(t.id,t.url)}),n=[{id:"title",url:"assets/audio/title_theme.mp3"},{id:"village",url:"assets/audio/village_theme.mp3"},{id:"forest",url:"assets/audio/forest_theme.mp3"},{id:"combat",url:"assets/audio/combat_theme.mp3"},{id:"dungeon",url:"assets/audio/dungeon_theme.mp3"},{id:"boss",url:"assets/audio/boss_theme.mp3"},{id:"victory",url:"assets/audio/victory_theme.mp3"}].map(function(t){return e.loadMusic(t.id,t.url)});return Promise.all([].concat(Re(t),Re(n)))}}],t&&Ne(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t}();function Ve(e){return Ve="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ve(e)}function Ue(e){return function(e){if(Array.isArray(e))return Xe(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Ke(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function $e(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a,o,s=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,i=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw i}}return s}}(e,t)||Ke(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ke(e,t){if(e){if("string"==typeof e)return Xe(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Xe(e,t):void 0}}function Xe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function Qe(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function a(n,r,i,a){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return Je(c,"_invoke",function(n,r,i){var a,s,l,c=0,u=i||[],h=!1,m={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,n){return a=t,s=0,l=e,m.n=n,o}};function d(n,r){for(s=n,l=r,t=0;!h&&c&&!i&&t<u.length;t++){var i,a=u[t],d=m.p,g=a[2];n>3?(i=g===r)&&(l=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=d&&((i=n<2&&d<a[1])?(s=0,m.v=r,m.n=a[1]):d<g&&(i=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,s=0))}if(i||n>1)return o;throw h=!0,r}return function(i,u,g){if(c>1)throw TypeError("Generator is already running");for(h&&1===u&&d(u,g),s=u,l=g;(t=s<2?e:l)||!h;){a||(s?s<3?(s>1&&(m.n=-1),d(s,l)):m.n=l:m.v=l);try{if(c=2,a){if(s||(i="next"),t=a[i]){if(!(t=t.call(a,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=a.return)&&t.call(a),s<2&&(l=TypeError("The iterator does not provide a '"+i+"' method"),s=1);a=e}else if((t=(h=m.n<0)?l:n.call(r,m))!==o)break}catch(t){a=e,s=1,l=t}finally{c=1}}return{value:t,done:h}}}(n,i,a),!0),c}var o={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(Je(t={},r,function(){return this}),t),h=c.prototype=s.prototype=Object.create(u);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Je(e,i,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=c,Je(h,"constructor",c),Je(c,"constructor",l),l.displayName="GeneratorFunction",Je(c,i,"GeneratorFunction"),Je(h),Je(h,i,"Generator"),Je(h,r,function(){return this}),Je(h,"toString",function(){return"[object Generator]"}),(Qe=function(){return{w:a,m}})()}function Je(e,t,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}Je=function(e,t,n,r){function a(t,n){Je(e,t,function(e){return this._invoke(t,n,e)})}t?i?i(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},Je(e,t,n,r)}function Ze(e,t,n,r,i,a,o){try{var s=e[a](o),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,i)}function et(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var a=e.apply(t,n);function o(e){Ze(a,r,i,o,s,"next",e)}function s(e){Ze(a,r,i,o,s,"throw",e)}o(void 0)})}}function tt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,nt(r.key),r)}}function nt(e){var t=function(e){if("object"!=Ve(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=Ve(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Ve(t)?t:t+""}var rt=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cache=new Map,this.loadingPromises=new Map,this.preloadQueue=[],this.maxCacheSize=50,this.basePath="assets/images/"},t=[{key:"preloadImage",value:(l=et(Qe().m(function e(t){var n,r,i=this;return Qe().w(function(e){for(;;)switch(e.n){case 0:if(n=t.startsWith("assets/")?t:"".concat(this.basePath).concat(t),!this.cache.has(n)){e.n=1;break}return e.a(2,this.cache.get(n));case 1:if(!this.loadingPromises.has(n)){e.n=2;break}return e.a(2,this.loadingPromises.get(n));case 2:return r=new Promise(function(e,t){var r=new Image;r.onload=function(){i.addToCache(n,r),i.loadingPromises.delete(n),e(r)},r.onerror=function(){console.warn("Failed to preload image: ".concat(n)),i.loadingPromises.delete(n),t(new Error("Failed to load image: ".concat(n)))},r.src=n}),this.loadingPromises.set(n,r),e.a(2,r)}},e,this)})),function(e){return l.apply(this,arguments)})},{key:"preloadImages",value:(s=et(Qe().m(function e(t){var n,r=this;return Qe().w(function(e){for(;;)if(0===e.n)return n=t.map(function(e){return r.preloadImage(e)}),e.a(2,Promise.allSettled(n))},e)})),function(e){return s.apply(this,arguments)})},{key:"preloadLocationImages",value:(o=et(Qe().m(function e(t){var n,r,i,a;return Qe().w(function(e){for(;;)switch(e.n){case 0:if(t){e.n=1;break}return e.a(2,[]);case 1:if(n=[],t.default&&this.isImageFile(t.default)&&n.push(t.default),t.conditions)for(r=0,i=Object.values(t.conditions);r<i.length;r++)a=i[r],this.isImageFile(a)&&n.push(a);return e.a(2,this.preloadImages(n))}},e,this)})),function(e){return o.apply(this,arguments)})},{key:"preloadAllLocationImages",value:(a=et(Qe().m(function e(t){var n,r,i,a,o,s,l;return Qe().w(function(e){for(;;)switch(e.n){case 0:n={totalImages:0,successfulLoads:0,failedLoads:0,failedImages:[]},r=[],i=0,a=Object.entries(t.locations);case 1:if(!(i<a.length)){e.n=4;break}if((o=$e(a[i],2))[0],!(s=o[1]).images){e.n=3;break}return e.n=2,this.preloadLocationImages(s.images);case 2:l=e.v,r.push.apply(r,Ue(l));case 3:i++,e.n=1;break;case 4:return n.totalImages=r.length,e.n=5,Promise.allSettled(r);case 5:return e.v.forEach(function(e,t){var r;"fulfilled"===e.status?n.successfulLoads++:(n.failedLoads++,n.failedImages.push((null===(r=e.reason)||void 0===r?void 0:r.message)||"Unknown error"))}),console.log("Image preloading complete: ".concat(n.successfulLoads,"/").concat(n.totalImages," images loaded")),n.failedLoads>0&&console.warn("Failed to load ".concat(n.failedLoads," images:"),n.failedImages),e.a(2,n)}},e,this)})),function(e){return a.apply(this,arguments)})},{key:"preloadEventImages",value:(i=et(Qe().m(function e(){var t;return Qe().w(function(e){for(;;)if(0===e.n)return t=["Wolf_Children.png","Battle_Aftermath.png","Victory_Celebration.png","Night_Scene.png","Dawn_Scene.png"],e.a(2,this.preloadImages(t))},e,this)})),function(){return i.apply(this,arguments)})},{key:"addToCache",value:function(e,t){if(this.cache.size>=this.maxCacheSize){var n=this.cache.keys().next().value;this.cache.delete(n)}this.cache.set(e,t)}},{key:"getCachedImage",value:function(e){var t=e.startsWith("assets/")?e:"".concat(this.basePath).concat(e);return this.cache.get(t)||null}},{key:"isImageCached",value:function(e){var t=e.startsWith("assets/")?e:"".concat(this.basePath).concat(e);return this.cache.has(t)}},{key:"clearCache",value:function(){this.cache.clear(),this.loadingPromises.clear()}},{key:"getCacheStats",value:function(){return{cachedImages:this.cache.size,loadingImages:this.loadingPromises.size,maxCacheSize:this.maxCacheSize,cacheUsage:"".concat(this.cache.size,"/").concat(this.maxCacheSize)}}},{key:"isImageFile",value:function(e){return/\.(png|jpg|jpeg|gif|svg|webp)$/i.test(e)}},{key:"preloadNearbyLocationImages",value:(r=et(Qe().m(function e(t,n){var r,i,a,o,s,l,c;return Qe().w(function(e){for(;;)switch(e.n){case 0:if((r=t.locations[n])&&r.exits){e.n=1;break}return e.a(2,[]);case 1:i=[],a=0,o=Object.values(r.exits);case 2:if(!(a<o.length)){e.n=5;break}if(s=o[a],!(l=t.locations[s])||!l.images){e.n=4;break}return e.n=3,this.preloadLocationImages(l.images);case 3:c=e.v,i.push.apply(i,Ue(c));case 4:a++,e.n=2;break;case 5:return e.a(2,Promise.allSettled(i))}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"smartPreload",value:(n=et(Qe().m(function e(t,n){var r,i,a;return Qe().w(function(e){for(;;)switch(e.n){case 0:if(r={currentLocation:[],nearbyLocations:[],eventImages:[],priorityImages:[]},!(i=t.locations[n.currentLocation])||!i.images){e.n=2;break}return e.n=1,this.preloadLocationImages(i.images);case 1:r.currentLocation=e.v;case 2:return e.n=3,this.preloadNearbyLocationImages(t,n.currentLocation);case 3:return r.nearbyLocations=e.v,e.n=4,this.preloadEventImages();case 4:if(r.eventImages=e.v,!((a=this.getPriorityImages(n)).length>0)){e.n=6;break}return e.n=5,this.preloadImages(a);case 5:r.priorityImages=e.v;case 6:return e.a(2,r)}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"getPriorityImages",value:function(e){var t=[];return e.hasItem("map_to_den")&&t.push("Cave_Entrance.png","Cave_Interior.png","Cave_Interior_creature.png"),t}}],t&&tt(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,i,a,o,s,l}(),it=new rt;function at(e){return at="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},at(e)}function ot(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a,o,s=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,i=e}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw i}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return st(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?st(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function st(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function lt(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function a(n,r,i,a){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return ct(c,"_invoke",function(n,r,i){var a,s,l,c=0,u=i||[],h=!1,m={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,n){return a=t,s=0,l=e,m.n=n,o}};function d(n,r){for(s=n,l=r,t=0;!h&&c&&!i&&t<u.length;t++){var i,a=u[t],d=m.p,g=a[2];n>3?(i=g===r)&&(l=a[(s=a[4])?5:(s=3,3)],a[4]=a[5]=e):a[0]<=d&&((i=n<2&&d<a[1])?(s=0,m.v=r,m.n=a[1]):d<g&&(i=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,s=0))}if(i||n>1)return o;throw h=!0,r}return function(i,u,g){if(c>1)throw TypeError("Generator is already running");for(h&&1===u&&d(u,g),s=u,l=g;(t=s<2?e:l)||!h;){a||(s?s<3?(s>1&&(m.n=-1),d(s,l)):m.n=l:m.v=l);try{if(c=2,a){if(s||(i="next"),t=a[i]){if(!(t=t.call(a,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=a.return)&&t.call(a),s<2&&(l=TypeError("The iterator does not provide a '"+i+"' method"),s=1);a=e}else if((t=(h=m.n<0)?l:n.call(r,m))!==o)break}catch(t){a=e,s=1,l=t}finally{c=1}}return{value:t,done:h}}}(n,i,a),!0),c}var o={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(ct(t={},r,function(){return this}),t),h=c.prototype=s.prototype=Object.create(u);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,ct(e,i,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=c,ct(h,"constructor",c),ct(c,"constructor",l),l.displayName="GeneratorFunction",ct(c,i,"GeneratorFunction"),ct(h),ct(h,i,"Generator"),ct(h,r,function(){return this}),ct(h,"toString",function(){return"[object Generator]"}),(lt=function(){return{w:a,m}})()}function ct(e,t,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}ct=function(e,t,n,r){function a(t,n){ct(e,t,function(e){return this._invoke(t,n,e)})}t?i?i(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},ct(e,t,n,r)}function ut(e,t,n,r,i,a,o){try{var s=e[a](o),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,i)}function ht(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var a=e.apply(t,n);function o(e){ut(a,r,i,o,s,"next",e)}function s(e){ut(a,r,i,o,s,"throw",e)}o(void 0)})}}function mt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,dt(r.key),r)}}function dt(e){var t=function(e){if("object"!=at(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=at(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==at(t)?t:t+""}var gt=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.titleScreen=null,this.characterCreation=null,this.gameScreen=null,this.newGameBtn=null,this.loadGameBtn=null,this.startAdventureBtn=null,this.characterNameInput=null,this.playerName="",this.currentLocation="crossroads",this.inventory=[],this.gameProgress={memoryFragments:[],questFlags:{},visitedLocations:[],defeatedEnemies:[],discoveredItems:[]},this.terminalHistory=[],this.webglRenderer=null,this.terminal=null,this.storyEngine=null,this.combatSystem=null,this.memorySystem=null,this.audioManager=new ze,this.titleMusicPlaying=!1,this.gameState=new Ge,this.gameState.playerName="",this.gameState.currentLocation="crossroads",this.gameState.inventory=[],this.gameState.experience=0,this.gameState.level=1,this.gameState.equipment={weapon:null,armor:null},this.gameState.flags={},this.gameState.memoryFragments=[],this.gameState.memoryRecovered=0,this.gameState.knownInformation=[],this.init()},t=[{key:"isLocalStorageAvailable",value:function(){try{var e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}},{key:"init",value:function(){this.titleScreen=document.getElementById("title-screen"),this.characterCreation=document.getElementById("character-creation-screen"),this.gameScreen=document.getElementById("game-screen"),this.newGameBtn=document.getElementById("new-game-btn"),this.loadGameBtn=document.getElementById("load-game-btn"),this.startAdventureBtn=document.getElementById("start-game-btn"),this.characterNameInput=document.getElementById("player-name"),this.musicToggleBtn=document.getElementById("music-toggle-btn"),this.loadGameBtnGameOver=document.getElementById("load-game-btn-gameover"),this.newGameBtnGameOver=document.getElementById("new-game-btn-gameover"),this.titleBtnGameOver=document.getElementById("title-btn-gameover"),this.setupEventListeners(),this.showScreen("title-screen")}},{key:"setupEventListeners",value:function(){var e=this;this.newGameBtn&&this.newGameBtn.addEventListener("click",function(){e.showCharacterCreation()}),this.loadGameBtn&&this.loadGameBtn.addEventListener("click",function(){e.stopTitleMusic(),e.loadGame()}),this.startAdventureBtn&&this.startAdventureBtn.addEventListener("click",function(){return e.startNewGame()}),this.musicToggleBtn&&this.musicToggleBtn.addEventListener("click",function(){return e.toggleMusic()}),this.loadGameBtnGameOver&&this.loadGameBtnGameOver.addEventListener("click",function(){return e.loadGame()}),this.newGameBtnGameOver&&this.newGameBtnGameOver.addEventListener("click",function(){return e.showCharacterCreation()}),this.titleBtnGameOver&&this.titleBtnGameOver.addEventListener("click",function(){return e.showScreen("title-screen")})}},{key:"showScreen",value:function(e){document.querySelectorAll(".screen").forEach(function(e){return e.classList.remove("active")}),"title-screen"===e||"character-creation-screen"===e||this.stopTitleMusic();var t=document.getElementById(e);t&&t.classList.add("active")}},{key:"showCharacterCreation",value:function(){this.showScreen("character-creation-screen")}},{key:"startTitleMusic",value:(a=ht(lt().m(function e(){var t;return lt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,this.audioManager||(this.audioManager=new ze),this.audioManager.init(),!this.titleMusicPlaying){e.n=1;break}return e.a(2);case 1:return e.n=2,this.audioManager.loadMusic("title","assets/audio/title_theme.m4a");case 2:this.audioManager.playMusic("title",{loop:!0,volume:.3}),this.titleMusicPlaying=!0,console.log("Title music started successfully"),e.n=4;break;case 3:e.p=3,t=e.v,console.info("Title music unavailable:",t.message);case 4:return e.a(2)}},e,this,[[0,3]])})),function(){return a.apply(this,arguments)})},{key:"stopTitleMusic",value:function(){this.audioManager&&this.audioManager.currentMusic&&(this.audioManager.stopMusic(),this.titleMusicPlaying=!1)}},{key:"toggleMusic",value:function(){this.audioManager||(this.audioManager=new ze,this.audioManager.init()),this.titleMusicPlaying?(this.stopTitleMusic(),this.musicToggleBtn&&(this.musicToggleBtn.textContent="🎵 Enable Music")):(this.startTitleMusic(),this.musicToggleBtn&&(this.musicToggleBtn.textContent="🔇 Disable Music"))}},{key:"loadGame",value:function(){if(this.isLocalStorageAvailable()){var e=localStorage.getItem("forgottenSteel_saveGame");if(e)try{var t=JSON.parse(e);this.gameState=new Ge,this.gameState.loadFromSave(t),this.playerName=t.playerName||"",this.currentLocation=t.currentLocation||"crossroads",this.inventory=t.inventory||[],this.gameProgress=t.gameProgress||{memoryFragments:[],questFlags:{},visitedLocations:[],defeatedEnemies:[],discoveredItems:[]},this.terminalHistory=t.terminalHistory||[],this.stopTitleMusic(),this.showScreen("game-screen"),this.restoreGame();var n="Game loaded successfully! Welcome back, ".concat(this.playerName,"!");this.terminal?this.terminal.print(n,"system-message"):alert(n)}catch(e){alert("Error loading saved game. The save file may be corrupted or incompatible. Please start a new game."),console.error("Load game error:",e);try{localStorage.removeItem("forgottenSteel_saveGame")}catch(e){console.error("Failed to clear corrupted save:",e)}}else alert("No saved game found! Start a new game to begin your adventure.")}else alert("Save/Load functionality is not available in this browser or is disabled.")}},{key:"saveGame",value:function(){if(!this.isLocalStorageAvailable())return this.terminal?this.terminal.print("Save functionality is not available in this browser.","error-message"):alert("Save functionality is not available in this browser."),!1;try{if(this.gameState.saveGame()){var e=localStorage.getItem("forgottenSteel_saveGame");if(e){var t=JSON.parse(e);t.gameProgress=this.gameProgress,t.terminalHistory=this.terminal?this.terminal.getHistory():this.terminalHistory,t.saveDate=(new Date).toISOString(),localStorage.setItem("forgottenSteel_saveGame",JSON.stringify(t))}}var n="Game saved successfully! (".concat((new Date).toLocaleString(),")");if(this.terminal)this.terminal.print(n,"system-message");else{var r=document.getElementById("terminal-output");r?(r.innerHTML+='<p class="system-message">'.concat(n,"</p>"),r.scrollTop=r.scrollHeight):alert("Game saved successfully!")}return!0}catch(e){console.error("Failed to save game:",e);var i="Failed to save game. This may be due to insufficient storage space or browser restrictions. Please try again.";return this.terminal?this.terminal.print(i,"error-message"):alert(i),!1}}},{key:"restoreGame",value:function(){var e=this,t=document.getElementById("webgl-canvas");t&&(this.webglRenderer=g(t),this.renderCurrentScene()),this.terminal=new Ie("terminal-output","terminal-input"),this.terminalHistory.length>0&&this.terminal.setHistory(this.terminalHistory),this.memorySystem=new je(this.gameState,this.terminal,this.webglRenderer,this.audioManager),Fe(this.memorySystem),this.storyEngine=new ie(this.gameState,this.terminal,this.webglRenderer),this.combatSystem=new be(this.gameState,this.terminal,this.storyEngine),this.combatSystem.storyEngine=this.storyEngine,this.storyEngine.setCombatSystem(this.combatSystem),this.storyEngine.setMemorySystem(this.memorySystem),Object.entries(le.locations).forEach(function(t){var n=ot(t,2),r=n[0],i=n[1];e.storyEngine.registerLocation(r,i)}),Object.entries(le.items).forEach(function(t){var n=ot(t,2),r=n[0],i=n[1];e.storyEngine.registerItem(r,i)}),Object.entries(le.npcs).forEach(function(t){var n=ot(t,2),r=n[0],i=n[1];e.storyEngine.registerNPC(r,i)}),this.storyEngine.describeCurrentLocation(),this.startGameLoop(),this.terminal.print("Game loaded successfully. Welcome back!","system-message")}},{key:"startNewGame",value:(i=ht(lt().m(function e(){var t,n,r;return lt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=null===(t=this.characterNameInput)||void 0===t?void 0:t.value.trim()){e.n=1;break}return alert("Please enter a name for your character."),e.a(2);case 1:return this.playerName=n,this.stopTitleMusic(),this.cleanupGameSystems(),this.gameState.reset(),this.gameState.playerName=n,this.showScreen("game-screen"),e.p=2,e.n=3,this.initializeGame();case 3:console.log("🎮 Game initialized successfully with image system"),e.n=5;break;case 4:e.p=4,r=e.v,console.error("❌ Error initializing game:",r);case 5:return e.a(2)}},e,this,[[2,4]])})),function(){return i.apply(this,arguments)})},{key:"cleanupGameSystems",value:function(){this.terminal&&(this.terminal.cleanup(),this.terminal=null),this.storyEngine=null,this.combatSystem=null,this.memorySystem=null}},{key:"initializeGame",value:(r=ht(lt().m(function e(){var t,n=this;return lt().w(function(e){for(;;)switch(e.n){case 0:return(t=document.getElementById("webgl-canvas"))&&(this.webglRenderer=g(t),window.imagePreloader=it,window.imageValidator=E,window.imageHelpers=q,this.renderCurrentScene()),this.terminal=new Ie("terminal-output","terminal-input"),e.n=1,this.initializeImageSystem();case 1:this.memorySystem=new je(this.gameState,this.terminal,this.webglRenderer,null),Fe(this.memorySystem),this.storyEngine=new ie(this.gameState,this.terminal,this.webglRenderer),this.combatSystem=new be(this.gameState,this.terminal,this.storyEngine),this.combatSystem.storyEngine=this.storyEngine,this.storyEngine.setCombatSystem(this.combatSystem),this.storyEngine.setMemorySystem(this.memorySystem),Object.entries(le.locations).forEach(function(e){var t=ot(e,2),r=t[0],i=t[1];n.storyEngine.registerLocation(r,i)}),Object.entries(le.items).forEach(function(e){var t=ot(e,2),r=t[0],i=t[1];n.storyEngine.registerItem(r,i)}),Object.entries(le.npcs).forEach(function(e){var t=ot(e,2),r=t[0],i=t[1];n.storyEngine.registerNPC(r,i)}),this.storyEngine.start(),this.startGameLoop();case 2:return e.a(2)}},e,this)})),function(){return r.apply(this,arguments)})},{key:"initializeImageSystem",value:(n=ht(lt().m(function e(){var t,n,r,i;return lt().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,E.validateAllLocationImages(le);case 1:return(t=e.v).allMissingImages.length>0?console.warn("⚠️ Some location images are missing:",t.allMissingImages):console.log("✅ All location images validated successfully"),e.n=2,it.smartPreload(le,this.gameState);case 2:n=e.v,console.log("🖼️ Image preloading completed:",{currentLocation:n.currentLocation.length,nearbyLocations:n.nearbyLocations.length,eventImages:n.eventImages.length,priorityImages:n.priorityImages.length}),r=it.getCacheStats(),console.log("📊 Image cache stats:",r),e.n=4;break;case 3:e.p=3,i=e.v,console.error("❌ Error initializing image system:",i);case 4:return e.a(2)}},e,this,[[0,3]])})),function(){return n.apply(this,arguments)})},{key:"renderCurrentScene",value:function(){if(this.webglRenderer&&this.gameState.currentLocation){var e={crossroads:"crossroads",forest_path_north:"forest_path",forest_path_south:"forest_path",forest_path_east:"forest_path",forest_path_west:"forest_path",village_outskirts:"village_outskirts",village_entrance:"village_entrance",village_square:"village_square",village_smithy:"village_smithy",village_inn:"village_inn",village_elder_house:"village_elder_house",village_market:"village_market",creature_den_entrance:"cave_entrance",creature_den_interior:"cave_interior",forest_clearing:"forest_clearing",deep_forest:"deep_forest",wizard_tower_base:"wizard_tower_exterior",hillside:"hillside"}[this.gameState.currentLocation]||"chamber";this.webglRenderer.render(e)}}},{key:"startGameLoop",value:function(){var e=this,t=function(){e.memorySystem&&e.memorySystem.update(),requestAnimationFrame(t)};requestAnimationFrame(t)}}],t&&mt(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,i,a}();document.addEventListener("DOMContentLoaded",function(){new gt})})();